<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“š ç°½åˆ°ç³»çµ± Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        :root{--primary:#4f46e5;--primary-dark:#3730a3;--success:#10b981;--warning:#f59e0b;--danger:#ef4444;--bg:#f8fafc;--card:#fff;--text:#1e293b;--text-light:#64748b;--border:#e2e8f0}
        *{margin:0;padding:0;box-sizing:border-box}body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:var(--bg);color:var(--text)}
        .mobile-header{position:fixed;top:0;left:0;right:0;height:56px;background:linear-gradient(135deg,var(--primary-dark),var(--primary));color:#fff;display:flex;align-items:center;padding:0 15px;z-index:1001}
        .hamburger{width:44px;height:44px;display:flex;flex-direction:column;justify-content:center;align-items:center;gap:5px;background:rgba(255,255,255,.1);border:none;border-radius:10px;cursor:pointer}
        .hamburger span{display:block;width:20px;height:2px;background:#fff;transition:.3s}.hamburger.active span:nth-child(1){transform:rotate(45deg) translate(5px,5px)}.hamburger.active span:nth-child(2){opacity:0}.hamburger.active span:nth-child(3){transform:rotate(-45deg) translate(5px,-5px)}
        .mobile-title{flex:1;text-align:center;font-size:18px;font-weight:700}.status-dot{width:10px;height:10px;border-radius:50%;background:var(--danger)}.status-dot.connected{background:var(--success)}
        .sidebar-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:999}.sidebar-overlay.open{display:block}
        .sidebar{position:fixed;top:0;left:0;width:280px;height:100vh;background:linear-gradient(180deg,var(--primary-dark),var(--primary));color:#fff;padding:70px 0 20px;z-index:1000;transform:translateX(-100%);transition:.3s;overflow-y:auto}.sidebar.open{transform:translateX(0)}
        .nav-menu{list-style:none;padding:10px}.nav-section{padding:15px 15px 8px;font-size:11px;text-transform:uppercase;opacity:.6;letter-spacing:1px}
        .nav-link{display:flex;align-items:center;gap:12px;padding:14px 15px;color:rgba(255,255,255,.8);text-decoration:none;border-radius:12px;margin-bottom:4px;transition:.3s;font-size:15px}.nav-link:hover,.nav-link.active{background:rgba(255,255,255,.2);color:#fff}
        .nav-badge{background:var(--danger);color:#fff;font-size:11px;padding:2px 8px;border-radius:10px;margin-left:auto}
        .main{padding:70px 15px 20px}.header{margin-bottom:20px}.page-title{font-size:24px;font-weight:700;margin-bottom:5px}.page-subtitle{font-size:14px;color:var(--text-light);margin-bottom:15px}
        .stats-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:20px}
        .stat-card{background:var(--card);border-radius:16px;padding:18px;box-shadow:0 2px 8px rgba(0,0,0,.05);position:relative;overflow:hidden}
        .stat-card::before{content:'';position:absolute;top:0;left:0;width:4px;height:100%}.stat-card.primary::before{background:var(--primary)}.stat-card.success::before{background:var(--success)}.stat-card.warning::before{background:var(--warning)}.stat-card.danger::before{background:var(--danger)}
        .stat-value{font-size:28px;font-weight:700}.stat-card.primary .stat-value{color:var(--primary)}.stat-card.success .stat-value{color:var(--success)}.stat-card.warning .stat-value{color:var(--warning)}.stat-card.danger .stat-value{color:var(--danger)}
        .stat-label{font-size:13px;color:var(--text-light);margin-top:3px}.stat-icon{position:absolute;top:12px;right:12px;font-size:24px;opacity:.2}
        .card{background:var(--card);border-radius:16px;padding:18px;margin-bottom:15px;box-shadow:0 2px 8px rgba(0,0,0,.05)}.card-title{font-size:16px;font-weight:600;margin-bottom:15px;display:flex;align-items:center;gap:8px}
        .btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;padding:12px 18px;border:none;border-radius:10px;font-size:14px;font-weight:500;cursor:pointer;transition:.3s}
        .btn-primary{background:var(--primary);color:#fff}.btn-success{background:var(--success);color:#fff}.btn-warning{background:var(--warning);color:#fff}.btn-danger{background:var(--danger);color:#fff}.btn-outline{background:#fff;border:2px solid var(--border);color:var(--text)}.btn-block{width:100%}.btn-sm{padding:8px 12px;font-size:13px}
        .form-group{margin-bottom:18px}.form-label{display:block;margin-bottom:6px;font-weight:500;font-size:14px}
        .form-input,.form-select,.form-textarea{width:100%;padding:12px 14px;border:2px solid var(--border);border-radius:10px;font-size:16px;font-family:inherit;background:#fff}.form-input:focus,.form-select:focus,.form-textarea:focus{outline:none;border-color:var(--primary)}.form-textarea{min-height:80px;resize:vertical}
        .form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
        .chip-group{display:flex;flex-wrap:wrap;gap:8px}.chip{padding:10px 16px;border:2px solid var(--border);border-radius:25px;cursor:pointer;transition:.3s;font-size:14px;font-weight:500}.chip:hover{border-color:var(--primary)}.chip.active{background:var(--primary);color:#fff;border-color:var(--primary)}
        .chip.day.active{background:#3b82f6;border-color:#3b82f6}.chip.night.active{background:#8b5cf6;border-color:#8b5cf6}.chip.weekend.active{background:#f59e0b;border-color:#f59e0b}
        .period-table{width:100%;border-collapse:collapse;margin-top:10px}.period-table th,.period-table td{padding:10px;text-align:center;border:1px solid var(--border);font-size:14px}.period-table th{background:var(--bg);font-weight:600}
        .table-wrap{overflow-x:auto}table{width:100%;border-collapse:collapse}th,td{padding:12px 10px;text-align:left;border-bottom:1px solid var(--border);font-size:14px}th{background:var(--bg);font-weight:600;color:var(--text-light);font-size:12px}
        tr.clickable{cursor:pointer;transition:.2s}tr.clickable:hover{background:var(--bg)}
        .badge{padding:4px 10px;border-radius:20px;font-size:12px;font-weight:500}.badge.success{background:rgba(16,185,129,.1);color:var(--success)}.badge.warning{background:rgba(245,158,11,.1);color:var(--warning)}.badge.danger{background:rgba(239,68,68,.1);color:var(--danger)}.badge.primary{background:rgba(79,70,229,.1);color:var(--primary)}.badge.gray{background:#e2e8f0;color:var(--text-light)}
        .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:flex-end;justify-content:center;z-index:2000;opacity:0;visibility:hidden;transition:.3s}.modal-overlay.active{opacity:1;visibility:visible}
        .modal{background:#fff;border-radius:20px 20px 0 0;width:100%;max-height:90vh;overflow-y:auto;transform:translateY(100%);transition:.3s}.modal-overlay.active .modal{transform:translateY(0)}
        .modal-header{padding:18px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;background:#fff;z-index:1}.modal-title{font-size:18px;font-weight:600}.modal-close{background:none;border:none;font-size:28px;color:var(--text-light);cursor:pointer}
        .modal-body{padding:18px}.modal-footer{padding:15px 18px;border-top:1px solid var(--border);display:flex;gap:10px}.modal-footer .btn{flex:1}
        .alert{padding:14px 16px;border-radius:12px;margin-bottom:15px;font-size:14px;display:flex;align-items:flex-start;gap:10px}.alert-info{background:rgba(59,130,246,.1);color:#1d4ed8}.alert-warning{background:rgba(245,158,11,.1);color:#b45309}.alert-danger{background:rgba(239,68,68,.1);color:#b91c1c}.alert-success{background:rgba(16,185,129,.1);color:#047857}
        .qr-container{text-align:center;padding:20px}.qr-code{background:#fff;padding:15px;border-radius:16px;display:inline-block;box-shadow:0 4px 15px rgba(0,0,0,.1);margin-bottom:15px}.qr-info{color:var(--text-light);font-size:14px}.qr-info strong{color:var(--text);display:block;font-size:16px;margin-bottom:5px}
        .session-item{padding:15px;border:1px solid var(--border);border-radius:12px;margin-bottom:12px}.session-item.completed{background:#f8fafc;opacity:.7}
        .session-header{display:flex;align-items:center;gap:12px;margin-bottom:10px}.session-icon{width:44px;height:44px;background:linear-gradient(135deg,#818cf8,var(--primary));border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:20px;color:#fff}
        .session-info{flex:1}.session-info h4{font-size:15px;margin-bottom:3px}.session-info span{font-size:13px;color:var(--text-light)}.session-actions{display:flex;gap:8px}.session-actions .btn{flex:1}
        .schedule-grid{display:grid;gap:2px;font-size:11px}.schedule-header{padding:8px 4px;text-align:center;background:var(--primary);color:#fff;font-weight:600;border-radius:6px 6px 0 0}.schedule-time{padding:8px 4px;text-align:center;background:var(--bg);font-weight:500;display:flex;align-items:center;justify-content:center}
        .schedule-cell{min-height:50px;padding:4px;background:#fff;border:1px solid var(--border);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:.2s}.schedule-cell:hover{background:var(--bg)}.schedule-cell.has-class{background:rgba(79,70,229,.15)}.schedule-cell .class-tag{font-size:10px;padding:4px 6px;background:var(--primary);color:#fff;border-radius:4px;text-align:center;width:100%}
        .empty{text-align:center;padding:40px 20px;color:var(--text-light)}.empty .icon{font-size:48px;margin-bottom:12px;opacity:.5}
        .toast-container{position:fixed;top:70px;left:15px;right:15px;z-index:3000}.toast{background:var(--text);color:#fff;padding:14px 18px;border-radius:12px;margin-bottom:10px;display:flex;align-items:center;gap:10px;animation:slideDown .3s}.toast.success{background:var(--success)}.toast.warning{background:var(--warning)}.toast.danger{background:var(--danger)}@keyframes slideDown{from{transform:translateY(-20px);opacity:0}to{transform:translateY(0);opacity:1}}
        .page{display:none}.page.active{display:block}
        .tabs{display:flex;gap:5px;margin-bottom:15px}.tab{flex:1;padding:12px;text-align:center;border:2px solid var(--border);border-radius:10px;cursor:pointer;font-weight:500;font-size:14px}.tab.active{background:var(--primary);color:#fff;border-color:var(--primary)}
        .progress-ring{width:120px;height:120px;margin:0 auto 15px}.progress-ring circle{fill:none;stroke-width:8}.progress-ring .bg{stroke:var(--border)}.progress-ring .fg{stroke:var(--success);stroke-linecap:round;transform:rotate(-90deg);transform-origin:50% 50%;transition:stroke-dashoffset .5s}
        .big-stat{text-align:center;padding:20px}.big-stat .value{font-size:48px;font-weight:700}.big-stat .label{font-size:14px;color:var(--text-light)}
        .student-alert{display:flex;align-items:center;gap:12px;padding:12px;border:1px solid var(--border);border-radius:12px;margin-bottom:10px}
        .student-alert.critical{border-color:var(--danger);background:rgba(239,68,68,.05)}.student-alert.warning{border-color:var(--warning);background:rgba(245,158,11,.05)}.student-alert.success{border-color:var(--success);background:rgba(16,185,129,.05)}
        .student-alert .avatar{width:40px;height:40px;border-radius:50%;background:var(--primary);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:600}
        .student-alert .info{flex:1}.student-alert .info h5{font-size:14px;margin-bottom:2px}.student-alert .info span{font-size:12px;color:var(--text-light)}
        .switch{position:relative;width:50px;height:28px}.switch input{opacity:0;width:0;height:0}.switch .slider{position:absolute;inset:0;background:var(--border);border-radius:28px;transition:.3s;cursor:pointer}.switch .slider::before{content:'';position:absolute;width:22px;height:22px;left:3px;bottom:3px;background:#fff;border-radius:50%;transition:.3s}.switch input:checked+.slider{background:var(--success)}.switch input:checked+.slider::before{transform:translateX(22px)}
        .setting-item{display:flex;align-items:center;justify-content:space-between;padding:15px 0;border-bottom:1px solid var(--border)}.setting-item:last-child{border:none}.setting-item .label{font-size:15px}.setting-item .desc{font-size:12px;color:var(--text-light);margin-top:2px}
        .leave-item{padding:15px;border:1px solid var(--border);border-radius:12px;margin-bottom:10px}.leave-item.pending{border-left:4px solid var(--warning)}.leave-item.approved{border-left:4px solid var(--success)}.leave-item.rejected{border-left:4px solid var(--danger)}
        .chart-container{position:relative;height:200px;margin:15px 0}
        .item-card{padding:15px;border:1px solid var(--border);border-radius:12px;margin-bottom:10px;display:flex;align-items:center;gap:12px}
        .item-card .icon{width:44px;height:44px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:20px;color:#fff}
        .item-card .info{flex:1}.item-card .info h5{font-size:15px;margin-bottom:2px}.item-card .info span{font-size:13px;color:var(--text-light)}
        .item-card .actions{display:flex;gap:6px}
        @media(min-width:768px){.mobile-header{display:none}.sidebar{transform:translateX(0);padding-top:20px}.sidebar-overlay{display:none!important}.main{margin-left:280px;padding:30px}.modal{max-width:600px;border-radius:20px;margin:auto}.modal-overlay{align-items:center}.stats-grid{grid-template-columns:repeat(4,1fr)}}
    </style>
</head>
<body>
    <header class="mobile-header">
        <button class="hamburger" id="hamburger" onclick="toggleSidebar()"><span></span><span></span><span></span></button>
        <div class="mobile-title">ğŸ“š ç°½åˆ°ç³»çµ± Pro</div>
        <div class="status-dot" id="status-dot"></div>
    </header>
    <div class="sidebar-overlay" id="overlay" onclick="toggleSidebar()"></div>
    <aside class="sidebar" id="sidebar">
        <ul class="nav-menu">
            <li class="nav-section">ç¸½è¦½</li>
            <li><a href="#" class="nav-link active" data-page="dashboard"><span>ğŸ“Š</span> å„€è¡¨æ¿</a></li>
            <li class="nav-section">èª²ç¨‹ç®¡ç†</li>
            <li><a href="#" class="nav-link" data-page="semester"><span>ğŸ“…</span> å­¸æœŸè¨­å®š</a></li>
            <li><a href="#" class="nav-link" data-page="schedule"><span>ğŸ—“ï¸</span> èª²è¡¨ç®¡ç†</a></li>
            <li><a href="#" class="nav-link" data-page="sessions"><span>ğŸ“</span> ä»Šæ—¥ç°½åˆ°</a></li>
            <li class="nav-section">è³‡æ–™ç®¡ç†</li>
            <li><a href="#" class="nav-link" data-page="classes"><span>ğŸ«</span> ç­ç´šç®¡ç†</a></li>
            <li><a href="#" class="nav-link" data-page="students"><span>ğŸ‘¨â€ğŸ“</span> å­¸ç”Ÿåå–®</a></li>
            <li><a href="#" class="nav-link" data-page="leaves"><span>ğŸ“‹</span> è«‹å‡ç®¡ç†<span class="nav-badge" id="leave-badge" style="display:none">0</span></a></li>
            <li><a href="#" class="nav-link" data-page="records"><span>ğŸ“œ</span> å‡ºç¼ºç´€éŒ„</a></li>
            <li class="nav-section">çµ±è¨ˆåˆ†æ</li>
            <li><a href="#" class="nav-link" data-page="stats"><span>ğŸ“ˆ</span> å‡ºå¸­çµ±è¨ˆ</a></li>
            <li><a href="#" class="nav-link" data-page="alerts"><span>âš ï¸</span> ç¼ºå¸­è­¦ç¤º</a></li>
            <li class="nav-section">ç³»çµ±</li>
            <li><a href="#" class="nav-link" data-page="notifications"><span>ğŸ””</span> é€šçŸ¥è¨­å®š</a></li>
            <li><a href="#" class="nav-link" data-page="linebot"><span>ğŸ¤–</span> LINE Bot</a></li>
            <li><a href="#" class="nav-link" data-page="settings"><span>âš™ï¸</span> ç³»çµ±è¨­å®š</a></li>
        </ul>
    </aside>
    <main class="main">
        <!-- Dashboard -->
        <div class="page active" id="page-dashboard">
            <div class="header"><h1 class="page-title">å„€è¡¨æ¿</h1><p class="page-subtitle" id="today-info"></p></div>
            <div class="stats-grid">
                <div class="stat-card primary"><div class="stat-value" id="stat-students">-</div><div class="stat-label">è¨»å†Šå­¸ç”Ÿ</div><div class="stat-icon">ğŸ‘¨â€ğŸ“</div></div>
                <div class="stat-card success"><div class="stat-value" id="stat-attended">-</div><div class="stat-label">ä»Šæ—¥å‡ºå¸­</div><div class="stat-icon">âœ…</div></div>
                <div class="stat-card warning"><div class="stat-value" id="stat-late">-</div><div class="stat-label">ä»Šæ—¥é²åˆ°</div><div class="stat-icon">âš ï¸</div></div>
                <div class="stat-card danger"><div class="stat-value" id="stat-absent">-</div><div class="stat-label">ä»Šæ—¥ç¼ºå¸­</div><div class="stat-icon">âŒ</div></div>
            </div>
            <div class="card"><div class="card-title">ğŸ“… ä»Šæ—¥èª²ç¨‹</div><div id="today-classes"></div></div>
            <div class="card"><div class="card-title">âš ï¸ éœ€é—œæ³¨å­¸ç”Ÿ</div><div id="dashboard-alerts"></div></div>
        </div>
        <!-- Semester -->
        <div class="page" id="page-semester">
            <div class="header"><h1 class="page-title">å­¸æœŸè¨­å®š</h1><p class="page-subtitle">è¨­å®šå­¸æœŸæ—¥æœŸèˆ‡ç¯€æ¬¡æ™‚é–“</p></div>
            <div class="card"><div class="card-title">ğŸ« éƒ¨åˆ¥é¸æ“‡</div><div class="chip-group" id="division-chips"><div class="chip day" data-div="day" onclick="selectDivision('day')">â˜€ï¸ æ—¥é–“éƒ¨</div><div class="chip night" data-div="night" onclick="selectDivision('night')">ğŸŒ™ å¤œé–“éƒ¨</div><div class="chip weekend" data-div="weekend" onclick="selectDivision('weekend')">ğŸ“… é€²ä¿®éƒ¨</div></div></div>
            <div class="card"><div class="card-title">ğŸ“† å­¸æœŸæœŸé–“</div><div class="form-row"><div class="form-group"><label class="form-label">é–‹å­¸æ—¥æœŸ</label><input type="date" class="form-input" id="semester-start" onchange="calcWeeks()"></div><div class="form-group"><label class="form-label">çµæ¥­æ—¥æœŸ</label><input type="date" class="form-input" id="semester-end" onchange="calcWeeks()"></div></div><div class="alert alert-info">â„¹ï¸ è‡ªå‹•è¨ˆç®—ï¼š<strong id="semester-weeks">0</strong> é€±</div></div>
            <div class="card"><div class="card-title">â° ç¯€æ¬¡æ™‚é–“è¡¨</div><div id="period-settings"></div></div>
            <button class="btn btn-primary btn-block" onclick="saveSemester()">ğŸ’¾ å„²å­˜å­¸æœŸè¨­å®š</button>
            <button class="btn btn-danger btn-block" style="margin-top:10px" onclick="resetAllSettings()">ğŸ—‘ï¸ é‡è¨­æ‰€æœ‰è¨­å®š</button>
        </div>
        <!-- Schedule -->
        <div class="page" id="page-schedule">
            <div class="header"><h1 class="page-title">èª²è¡¨ç®¡ç†</h1><p class="page-subtitle">ç®¡ç†èª²ç¨‹è³‡æ–™</p></div>
            <div class="card">
                <div class="tabs"><div class="tab active" onclick="showView('grid')">é€±èª²è¡¨</div><div class="tab" onclick="showView('list')">èª²ç¨‹åˆ—è¡¨</div></div>
                <div id="grid-view"><div class="schedule-grid" id="schedule-grid"></div></div>
                <div id="list-view" style="display:none">
                    <button class="btn btn-primary btn-block" style="margin-bottom:15px" onclick="openModal('addCourse')">â• æ–°å¢èª²ç¨‹</button>
                    <div id="courses-list"></div>
                </div>
            </div>
        </div>
        <!-- Sessions -->
        <div class="page" id="page-sessions">
            <div class="header"><h1 class="page-title">ä»Šæ—¥ç°½åˆ°</h1><p class="page-subtitle" id="session-date"></p></div>
            <div id="sessions-list"></div>
        </div>
        <!-- Classes -->
        <div class="page" id="page-classes">
            <div class="header"><h1 class="page-title">ç­ç´šç®¡ç†</h1></div>
            <button class="btn btn-primary btn-block" style="margin-bottom:15px" onclick="openModal('addClass')">â• æ–°å¢ç­ç´š</button>
            <div id="classes-list"></div>
        </div>
        <!-- Students -->
        <div class="page" id="page-students">
            <div class="header"><h1 class="page-title">å­¸ç”Ÿåå–®</h1></div>
            <button class="btn btn-primary btn-block" style="margin-bottom:15px" onclick="openModal('addStudent')">â• æ–°å¢å­¸ç”Ÿ</button>
            <div class="card"><div class="form-group" style="margin:0"><select class="form-select" id="student-filter" onchange="loadStudents()"><option value="">å…¨éƒ¨ç­ç´š</option></select></div></div>
            <div id="students-list"></div>
        </div>
        <!-- Leaves -->
        <div class="page" id="page-leaves">
            <div class="header"><h1 class="page-title">è«‹å‡ç®¡ç†</h1></div>
            <div class="tabs"><div class="tab active" onclick="filterLeaves('pending')">å¾…å¯©æ ¸</div><div class="tab" onclick="filterLeaves('approved')">å·²æ ¸å‡†</div><div class="tab" onclick="filterLeaves('rejected')">å·²é§å›</div><div class="tab" onclick="filterLeaves('all')">å…¨éƒ¨</div></div>
            <div id="leaves-list"></div>
        </div>
        <!-- Records -->
        <div class="page" id="page-records">
            <div class="header"><h1 class="page-title">å‡ºç¼ºç´€éŒ„</h1></div>
            <button class="btn btn-primary btn-block" style="margin-bottom:15px" onclick="openModal('addRecord')">â• æ‰‹å‹•æ–°å¢</button>
            <div class="card"><div class="table-wrap"><table><thead><tr><th>æ—¥æœŸ</th><th>å­¸è™Ÿ</th><th>å§“å</th><th>ç‹€æ…‹</th></tr></thead><tbody id="records-table"></tbody></table></div></div>
        </div>
        <!-- Stats -->
        <div class="page" id="page-stats">
            <div class="header"><h1 class="page-title">å‡ºå¸­çµ±è¨ˆ</h1></div>
            <div class="card">
                <div class="big-stat">
                    <svg class="progress-ring" viewBox="0 0 120 120"><circle class="bg" cx="60" cy="60" r="52"/><circle class="fg" id="progress-circle" cx="60" cy="60" r="52" stroke-dasharray="327" stroke-dashoffset="327"/></svg>
                    <div class="value" id="overall-rate">--%</div>
                    <div class="label">æ•´é«”å‡ºå¸­ç‡</div>
                </div>
            </div>
            <div class="stats-grid">
                <div class="stat-card success"><div class="stat-value" id="stats-attended">-</div><div class="stat-label">å‡ºå¸­</div></div>
                <div class="stat-card warning"><div class="stat-value" id="stats-late">-</div><div class="stat-label">é²åˆ°</div></div>
                <div class="stat-card danger"><div class="stat-value" id="stats-absent">-</div><div class="stat-label">ç¼ºå¸­</div></div>
                <div class="stat-card primary"><div class="stat-value" id="stats-total">-</div><div class="stat-label">ç¸½è¨ˆ</div></div>
            </div>
            <div class="card"><div class="card-title">ğŸ“‰ ä½å‡ºå¸­ç‡å­¸ç”Ÿ</div><div id="low-attendance-list"></div></div>
        </div>
        <!-- Alerts -->
        <div class="page" id="page-alerts">
            <div class="header"><h1 class="page-title">ç¼ºå¸­è­¦ç¤º</h1></div>
            <div class="alert alert-warning">âš ï¸ ä»¥ä¸‹å­¸ç”Ÿæœ‰é€£çºŒç¼ºå¸­æƒ…å½¢</div>
            <div id="alert-list"></div>
            <button class="btn btn-primary btn-block" onclick="sendAllWarnings()">ğŸ“² ç™¼é€å…¨éƒ¨è­¦å‘Š</button>
        </div>
        <!-- Notifications -->
        <div class="page" id="page-notifications">
            <div class="header"><h1 class="page-title">é€šçŸ¥è¨­å®š</h1></div>
            <div class="card">
                <div class="card-title">ğŸ“± è‡ªå‹•é€šçŸ¥</div>
                <div class="setting-item"><div><div class="label">ç¼ºå¸­é€šçŸ¥å­¸ç”Ÿ</div><div class="desc">ç¼ºå¸­æ™‚ç™¼é€ LINE é€šçŸ¥</div></div><label class="switch"><input type="checkbox" id="notify-absent" checked><span class="slider"></span></label></div>
                <div class="setting-item"><div><div class="label">ç¼ºå¸­é€šçŸ¥å®¶é•·</div><div class="desc">åŒæ™‚é€šçŸ¥å®¶é•·</div></div><label class="switch"><input type="checkbox" id="notify-parent"><span class="slider"></span></label></div>
                <div class="setting-item"><div><div class="label">é€£çºŒç¼ºå¸­è­¦å‘Š</div><div class="desc">é€£çºŒ 3 æ¬¡ç¼ºå¸­ç™¼è­¦å‘Š</div></div><label class="switch"><input type="checkbox" id="notify-warning" checked><span class="slider"></span></label></div>
            </div>
            <button class="btn btn-primary btn-block" onclick="toast('è¨­å®šå·²å„²å­˜ï¼')">ğŸ’¾ å„²å­˜è¨­å®š</button>
        </div>
        <!-- LINE Bot -->
        <div class="page" id="page-linebot">
            <div class="header"><h1 class="page-title">LINE Bot è¨­å®š</h1><p class="page-subtitle">å¦‚ä½•ç™¼å¸ƒèˆ‡ä½¿ç”¨</p></div>
            <div class="card">
                <div class="card-title">ğŸ“‹ ç™¼å¸ƒæ­¥é©Ÿ</div>
                <div class="alert alert-info">
                    <b>Step 1:</b> å‰å¾€ <a href="https://developers.line.biz/" target="_blank" style="color:#1d4ed8">LINE Developers</a> ç™»å…¥
                </div>
                <div class="alert alert-info">
                    <b>Step 2:</b> å»ºç«‹ Provider â†’ å»ºç«‹ Messaging API Channel
                </div>
                <div class="alert alert-info">
                    <b>Step 3:</b> åœ¨ Channel è¨­å®šä¸­ï¼š<br>
                    â€¢ Webhook URL å¡«å…¥ï¼š<br>
                    <code style="background:#e2e8f0;padding:4px 8px;border-radius:4px;font-size:12px;word-break:break-all">${location.origin}/webhook</code>
                </div>
                <div class="alert alert-info">
                    <b>Step 4:</b> é–‹å•Ÿã€ŒUse webhookã€
                </div>
                <div class="alert alert-info">
                    <b>Step 5:</b> è¤‡è£½ Channel Secret å’Œ Channel Access Tokenï¼Œå¡«å…¥ Render ç’°å¢ƒè®Šæ•¸
                </div>
            </div>
            <div class="card">
                <div class="card-title">âš™ï¸ Render ç’°å¢ƒè®Šæ•¸</div>
                <div class="alert alert-warning">
                    åœ¨ Render Dashboard â†’ Environment åŠ å…¥ï¼š<br><br>
                    <code>LINE_CHANNEL_SECRET</code> = ä½ çš„ Secret<br>
                    <code>LINE_CHANNEL_ACCESS_TOKEN</code> = ä½ çš„ Token<br>
                    <code>GOOGLE_SHEETS_ID</code> = ä½ çš„è©¦ç®—è¡¨ ID<br>
                    <code>GOOGLE_SERVICE_ACCOUNT_EMAIL</code> = æœå‹™å¸³æˆ¶ Email<br>
                    <code>GOOGLE_PRIVATE_KEY</code> = æœå‹™å¸³æˆ¶é‡‘é‘°
                </div>
            </div>
            <div class="card">
                <div class="card-title">ğŸ“± å­¸ç”Ÿå¦‚ä½•ä½¿ç”¨</div>
                <div class="alert alert-success">
                    1. æƒæ LINE Bot QR Code åŠ å¥½å‹<br>
                    2. å‚³é€ã€Œè¨»å†Š å­¸è™Ÿ å§“å ç­ç´šã€<br>
                    3. ä¸Šèª²æ™‚æƒæè€å¸«çš„ç°½åˆ° QR Code<br>
                    4. å‚³é€ã€Œç°½åˆ°ã€å®Œæˆ
                </div>
            </div>
            <div class="card">
                <div class="card-title">ğŸ”— Bot ID</div>
                <div class="form-group"><input type="text" class="form-input" id="bot-id" placeholder="@xxx"></div>
                <button class="btn btn-primary btn-block" onclick="saveBotId()">ğŸ’¾ å„²å­˜</button>
            </div>
        </div>
        <!-- Settings -->
        <div class="page" id="page-settings">
            <div class="header"><h1 class="page-title">ç³»çµ±è¨­å®š</h1></div>
            <div class="card"><div class="card-title">ğŸ”— API é€£ç·š</div><div class="form-group"><label class="form-label">å¾Œç«¯ç¶²å€</label><input type="text" class="form-input" id="api-url" placeholder="https://your-app.onrender.com"></div><button class="btn btn-primary btn-block" onclick="testConn()">ğŸ” æ¸¬è©¦é€£ç·š</button></div>
        </div>
    </main>
    <div class="toast-container" id="toasts"></div>

    <!-- Modals -->
    <div class="modal-overlay" id="modal-addClass"><div class="modal"><div class="modal-header"><h3 class="modal-title">æ–°å¢ç­ç´š</h3><button class="modal-close" onclick="closeModal('addClass')">&times;</button></div><div class="modal-body"><div class="form-group"><label class="form-label">ç­ç´šä»£ç¢¼ *</label><input type="text" class="form-input" id="class-code" placeholder="801"></div><div class="form-group"><label class="form-label">ç­ç´šåç¨± *</label><input type="text" class="form-input" id="class-name" placeholder="å…«å¹´ä¸€ç­"></div><div class="form-group"><label class="form-label">éƒ¨åˆ¥</label><select class="form-select" id="class-division"><option value="day">æ—¥é–“éƒ¨</option><option value="night">å¤œé–“éƒ¨</option><option value="weekend">é€²ä¿®éƒ¨</option></select></div><div class="form-group"><label class="form-label">å°å¸«</label><input type="text" class="form-input" id="class-teacher"></div></div><div class="modal-footer"><button class="btn btn-outline" onclick="closeModal('addClass')">å–æ¶ˆ</button><button class="btn btn-primary" onclick="addClass()">æ–°å¢</button></div></div></div>
    
    <div class="modal-overlay" id="modal-editClass"><div class="modal"><div class="modal-header"><h3 class="modal-title">ç·¨è¼¯ç­ç´š</h3><button class="modal-close" onclick="closeModal('editClass')">&times;</button></div><div class="modal-body"><div class="form-group"><label class="form-label">ç­ç´šä»£ç¢¼</label><input type="text" class="form-input" id="edit-class-code" readonly></div><div class="form-group"><label class="form-label">ç­ç´šåç¨±</label><input type="text" class="form-input" id="edit-class-name"></div><div class="form-group"><label class="form-label">éƒ¨åˆ¥</label><select class="form-select" id="edit-class-division"><option value="day">æ—¥é–“éƒ¨</option><option value="night">å¤œé–“éƒ¨</option><option value="weekend">é€²ä¿®éƒ¨</option></select></div><div class="form-group"><label class="form-label">å°å¸«</label><input type="text" class="form-input" id="edit-class-teacher"></div></div><div class="modal-footer"><button class="btn btn-danger" onclick="deleteClass()">ğŸ—‘ï¸ åˆªé™¤</button><button class="btn btn-primary" onclick="saveClass()">ğŸ’¾ å„²å­˜</button></div></div></div>

    <div class="modal-overlay" id="modal-addCourse"><div class="modal"><div class="modal-header"><h3 class="modal-title">æ–°å¢èª²ç¨‹</h3><button class="modal-close" onclick="closeModal('addCourse')">&times;</button></div><div class="modal-body"><div class="form-group"><label class="form-label">èª²ç¨‹åç¨± *</label><input type="text" class="form-input" id="course-name" placeholder="ç‰©ç†"></div><div class="form-group"><label class="form-label">ç­ç´š *</label><select class="form-select" id="course-class"></select></div><div class="form-row"><div class="form-group"><label class="form-label">æ˜ŸæœŸ *</label><select class="form-select" id="course-day"><option value="1">é€±ä¸€</option><option value="2">é€±äºŒ</option><option value="3">é€±ä¸‰</option><option value="4">é€±å››</option><option value="5">é€±äº”</option><option value="6">é€±å…­</option><option value="0">é€±æ—¥</option></select></div><div class="form-group"><label class="form-label">ç¯€æ¬¡ *</label><select class="form-select" id="course-period"></select></div></div><div class="form-group"><label class="form-label">æ•™å®¤</label><input type="text" class="form-input" id="course-room" placeholder="ç‰©ç†å¯¦é©—å®¤"></div><div class="form-row"><div class="form-group"><label class="form-label">GPS ç·¯åº¦</label><input type="number" step="any" class="form-input" id="course-lat"></div><div class="form-group"><label class="form-label">GPS ç¶“åº¦</label><input type="number" step="any" class="form-input" id="course-lon"></div></div><button type="button" class="btn btn-outline btn-block" onclick="getLocation()">ğŸ“ å–å¾—ç›®å‰ä½ç½®</button></div><div class="modal-footer"><button class="btn btn-outline" onclick="closeModal('addCourse')">å–æ¶ˆ</button><button class="btn btn-primary" onclick="addCourse()">æ–°å¢</button></div></div></div>

    <div class="modal-overlay" id="modal-editCourse"><div class="modal"><div class="modal-header"><h3 class="modal-title">ç·¨è¼¯èª²ç¨‹</h3><button class="modal-close" onclick="closeModal('editCourse')">&times;</button></div><div class="modal-body"><div class="form-group"><label class="form-label">èª²ç¨‹åç¨±</label><input type="text" class="form-input" id="edit-course-name"></div><div class="form-group"><label class="form-label">ç­ç´š</label><select class="form-select" id="edit-course-class"></select></div><div class="form-row"><div class="form-group"><label class="form-label">æ˜ŸæœŸ</label><select class="form-select" id="edit-course-day"><option value="1">é€±ä¸€</option><option value="2">é€±äºŒ</option><option value="3">é€±ä¸‰</option><option value="4">é€±å››</option><option value="5">é€±äº”</option><option value="6">é€±å…­</option><option value="0">é€±æ—¥</option></select></div><div class="form-group"><label class="form-label">ç¯€æ¬¡</label><select class="form-select" id="edit-course-period"></select></div></div><div class="form-group"><label class="form-label">æ•™å®¤</label><input type="text" class="form-input" id="edit-course-room"></div></div><div class="modal-footer"><button class="btn btn-danger" onclick="deleteCourse()">ğŸ—‘ï¸ åˆªé™¤</button><button class="btn btn-primary" onclick="saveCourse()">ğŸ’¾ å„²å­˜</button></div></div></div>

    <div class="modal-overlay" id="modal-addStudent"><div class="modal"><div class="modal-header"><h3 class="modal-title">æ–°å¢å­¸ç”Ÿ</h3><button class="modal-close" onclick="closeModal('addStudent')">&times;</button></div><div class="modal-body"><div class="alert alert-info">ğŸ’¡ å­¸ç”Ÿä¹Ÿå¯ä»¥é€é LINE Bot è‡ªè¡Œè¨»å†Š</div><div class="form-group"><label class="form-label">å­¸è™Ÿ *</label><input type="text" class="form-input" id="student-id" placeholder="110001"></div><div class="form-group"><label class="form-label">å§“å *</label><input type="text" class="form-input" id="student-name" placeholder="ç‹å°æ˜"></div><div class="form-group"><label class="form-label">ç­ç´š *</label><select class="form-select" id="student-class"></select></div><div class="form-group"><label class="form-label">é›»è©±</label><input type="tel" class="form-input" id="student-phone" placeholder="0912345678"></div><div class="form-group"><label class="form-label">å®¶é•·é›»è©±</label><input type="tel" class="form-input" id="student-parent-phone"></div></div><div class="modal-footer"><button class="btn btn-outline" onclick="closeModal('addStudent')">å–æ¶ˆ</button><button class="btn btn-primary" onclick="addStudent()">æ–°å¢</button></div></div></div>

    <div class="modal-overlay" id="modal-editStudent"><div class="modal"><div class="modal-header"><h3 class="modal-title">ç·¨è¼¯å­¸ç”Ÿ</h3><button class="modal-close" onclick="closeModal('editStudent')">&times;</button></div><div class="modal-body"><div class="form-group"><label class="form-label">å­¸è™Ÿ</label><input type="text" class="form-input" id="edit-student-id" readonly></div><div class="form-group"><label class="form-label">å§“å</label><input type="text" class="form-input" id="edit-student-name"></div><div class="form-group"><label class="form-label">ç­ç´š</label><select class="form-select" id="edit-student-class"></select></div><div class="form-group"><label class="form-label">é›»è©±</label><input type="tel" class="form-input" id="edit-student-phone"></div><div class="form-group"><label class="form-label">å®¶é•·é›»è©±</label><input type="tel" class="form-input" id="edit-student-parent-phone"></div></div><div class="modal-footer"><button class="btn btn-danger" onclick="deleteStudent()">ğŸ—‘ï¸ åˆªé™¤</button><button class="btn btn-primary" onclick="saveStudent()">ğŸ’¾ å„²å­˜</button></div></div></div>

    <div class="modal-overlay" id="modal-addRecord"><div class="modal"><div class="modal-header"><h3 class="modal-title">æ‰‹å‹•æ–°å¢ç´€éŒ„</h3><button class="modal-close" onclick="closeModal('addRecord')">&times;</button></div><div class="modal-body"><div class="form-group"><label class="form-label">å­¸è™Ÿ *</label><input type="text" class="form-input" id="record-student"></div><div class="form-group"><label class="form-label">æ—¥æœŸ *</label><input type="date" class="form-input" id="record-date"></div><div class="form-group"><label class="form-label">ç‹€æ…‹</label><select class="form-select" id="record-status"><option value="å·²å ±åˆ°">å·²å ±åˆ°</option><option value="é²åˆ°">é²åˆ°</option><option value="ç¼ºå¸­">ç¼ºå¸­</option></select></div><div class="form-group"><label class="form-label">å‚™è¨»</label><input type="text" class="form-input" id="record-note"></div></div><div class="modal-footer"><button class="btn btn-outline" onclick="closeModal('addRecord')">å–æ¶ˆ</button><button class="btn btn-primary" onclick="addRecord()">æ–°å¢</button></div></div></div>

    <div class="modal-overlay" id="modal-reviewLeave"><div class="modal"><div class="modal-header"><h3 class="modal-title">å¯©æ ¸è«‹å‡</h3><button class="modal-close" onclick="closeModal('reviewLeave')">&times;</button></div><div class="modal-body"><div id="leave-detail"></div><div class="form-group"><label class="form-label">å‚™è¨»</label><textarea class="form-textarea" id="review-note"></textarea></div></div><div class="modal-footer"><button class="btn btn-danger" onclick="reviewLeave('å·²é§å›')">âŒ é§å›</button><button class="btn btn-success" onclick="reviewLeave('å·²æ ¸å‡†')">âœ… æ ¸å‡†</button></div></div></div>

    <div class="modal-overlay" id="modal-qr"><div class="modal"><div class="modal-header"><h3 class="modal-title">ğŸ“± ç°½åˆ° QR Code</h3><button class="modal-close" onclick="closeModal('qr')">&times;</button></div><div class="modal-body"><div class="qr-container"><div class="qr-code"><canvas id="qr-canvas"></canvas></div><div class="qr-info"><strong id="qr-name"></strong><span id="qr-time"></span></div></div></div><div class="modal-footer"><button class="btn btn-outline" onclick="closeModal('qr')">é—œé–‰</button><button class="btn btn-primary" onclick="downloadQR()">ğŸ“¥ ä¸‹è¼‰</button></div></div></div>

    <script>
        // === å…¨åŸŸè®Šæ•¸ ===
        let API = localStorage.getItem('apiUrl') || '';
        let BOT = localStorage.getItem('botId') || '@bot';
        let sem = JSON.parse(localStorage.getItem('semester') || 'null') || { div: 'day', start: '', end: '', periods: [] };
        let classes = [], courses = [], students = [], leaves = [];
        let currentClass = null, currentCourse = null, currentStudent = null, currentLeave = null;
        let leaveFilter = 'pending';
        
        const PERIODS = {
            day: [{n:1,s:'08:00',e:'08:50'},{n:2,s:'09:00',e:'09:50'},{n:3,s:'10:00',e:'10:50'},{n:4,s:'11:00',e:'11:50'},{n:5,s:'13:00',e:'13:50'},{n:6,s:'14:00',e:'14:50'},{n:7,s:'15:00',e:'15:50'},{n:8,s:'16:00',e:'17:00'}],
            night: [{n:1,s:'18:00',e:'18:50'},{n:2,s:'19:00',e:'19:50'},{n:3,s:'20:00',e:'20:50'},{n:4,s:'21:00',e:'22:00'}],
            weekend: [{n:1,s:'08:00',e:'08:50'},{n:2,s:'09:00',e:'09:50'},{n:3,s:'10:00',e:'10:50'},{n:4,s:'11:00',e:'11:50'},{n:5,s:'13:00',e:'13:50'},{n:6,s:'14:00',e:'14:50'},{n:7,s:'15:00',e:'15:50'},{n:8,s:'16:00',e:'17:00'}]
        };
        const DAY_NAMES = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
        const DIV_NAMES = { day: 'æ—¥é–“éƒ¨', night: 'å¤œé–“éƒ¨', weekend: 'é€²ä¿®éƒ¨' };

        // === API ===
        async function api(path, opts = {}) {
            if (!API) {
                console.log('API æœªè¨­å®š');
                return null;
            }
            try {
                console.log('API è«‹æ±‚:', API + path, opts.method || 'GET');
                const res = await fetch(API + path, { ...opts, headers: { 'Content-Type': 'application/json' } });
                const data = await res.json();
                console.log('API å›æ‡‰:', res.status, data);
                
                if (!res.ok) {
                    console.error('API éŒ¯èª¤:', res.status, data);
                    return data;
                }
                document.getElementById('status-dot').classList.add('connected');
                return data;
            } catch (e) {
                console.error('API ä¾‹å¤–:', e);
                document.getElementById('status-dot').classList.remove('connected');
                return null;
            }
        }

        // === UI ===
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
            document.getElementById('overlay').classList.toggle('open');
            document.getElementById('hamburger').classList.toggle('active');
        }
        function showPage(page) {
            document.querySelectorAll('.nav-link').forEach(l => l.classList.toggle('active', l.dataset.page === page));
            document.querySelectorAll('.page').forEach(p => p.classList.toggle('active', p.id === 'page-' + page));
        }
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', e => {
                e.preventDefault();
                showPage(link.dataset.page);
                if (innerWidth < 768) toggleSidebar();
                loadPage(link.dataset.page);
            });
        });
        function openModal(id) { document.getElementById('modal-' + id).classList.add('active'); }
        function closeModal(id) { document.getElementById('modal-' + id).classList.remove('active'); }
        function toast(msg, type = 'success') {
            const el = document.createElement('div');
            el.className = 'toast ' + type;
            el.textContent = (type === 'success' ? 'âœ… ' : type === 'warning' ? 'â³ ' : 'âŒ ') + msg;
            document.getElementById('toasts').appendChild(el);
            setTimeout(() => el.remove(), 3000);
        }

        // === å­¸æœŸè¨­å®š ===
        function selectDivision(div) {
            console.log('åˆ‡æ›éƒ¨åˆ¥:', div);
            
            // æ›´æ–°è®Šæ•¸
            sem.div = div;
            sem.periods = JSON.parse(JSON.stringify(PERIODS[div]));
            
            // æ›´æ–°æ‰€æœ‰ chip çš„æ¨£å¼
            const chips = document.querySelectorAll('#division-chips .chip');
            chips.forEach(c => {
                // ç§»é™¤æ‰€æœ‰ active å’Œé¡è‰² class
                c.classList.remove('active', 'day', 'night', 'weekend');
            });
            
            // ç‚ºé¸ä¸­çš„ chip åŠ ä¸Šæ¨£å¼
            const selectedChip = document.querySelector('#division-chips .chip[data-div="' + div + '"]');
            if (selectedChip) {
                selectedChip.classList.add('active');
                selectedChip.classList.add(div);
            }
            
            // å„²å­˜åˆ° localStorage
            localStorage.setItem('semester', JSON.stringify(sem));
            console.log('å·²å„²å­˜:', JSON.stringify(sem));
            
            // æ›´æ–°ç¯€æ¬¡é¡¯ç¤º
            renderPeriods();
            
            // é¡¯ç¤ºæç¤º
            toast('å·²åˆ‡æ›è‡³' + (div === 'day' ? 'æ—¥é–“éƒ¨' : div === 'night' ? 'å¤œé–“éƒ¨' : 'é€²ä¿®éƒ¨'));
        }
        
        function resetAllSettings() {
            if (!confirm('ç¢ºå®šè¦é‡è¨­æ‰€æœ‰è¨­å®šå—ï¼Ÿé€™æœƒæ¸…é™¤å­¸æœŸè¨­å®šã€éƒ¨åˆ¥é¸æ“‡ç­‰ã€‚')) return;
            
            // æ¸…é™¤ localStorage
            localStorage.removeItem('semester');
            
            // é‡è¨­è®Šæ•¸
            sem = { div: 'day', start: '', end: '', periods: JSON.parse(JSON.stringify(PERIODS.day)) };
            
            // é‡æ–°åˆå§‹åŒ– UI
            initSemesterUI();
            
            toast('è¨­å®šå·²é‡è¨­ï¼');
        }
        
        function saveSemesterToStorage() {
            localStorage.setItem('semester', JSON.stringify(sem));
        }
        
        function loadSemesterFromStorage() {
            const saved = localStorage.getItem('semester');
            console.log('å¾ localStorage è®€å–:', saved);
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    sem.div = parsed.div || 'day';
                    sem.start = parsed.start || '';
                    sem.end = parsed.end || '';
                    sem.periods = parsed.periods && parsed.periods.length > 0 ? parsed.periods : JSON.parse(JSON.stringify(PERIODS[sem.div]));
                    console.log('è§£ææˆåŠŸ:', sem);
                } catch (e) {
                    console.log('è§£æå¤±æ•—ï¼Œä½¿ç”¨é è¨­');
                    sem = { div: 'day', start: '', end: '', periods: JSON.parse(JSON.stringify(PERIODS.day)) };
                }
            }
        }
        
        function initSemesterUI() {
            console.log('åˆå§‹åŒ– UI, sem.div =', sem.div);
            
            // æ›´æ–°éƒ¨åˆ¥ chips
            const chips = document.querySelectorAll('#division-chips .chip');
            chips.forEach(c => {
                c.classList.remove('active', 'day', 'night', 'weekend');
                if (c.dataset.div === sem.div) {
                    c.classList.add('active');
                    c.classList.add(sem.div);
                }
            });
            
            // æ›´æ–°æ—¥æœŸ
            document.getElementById('semester-start').value = sem.start || '';
            document.getElementById('semester-end').value = sem.end || '';
            calcWeeks();
            
            // æ›´æ–°ç¯€æ¬¡è¡¨
            renderPeriods();
        }
        function renderPeriods() {
            const ps = sem.periods && sem.periods.length > 0 ? sem.periods : PERIODS[sem.div || 'day'];
            document.getElementById('period-settings').innerHTML = '<table class="period-table"><thead><tr><th>ç¯€æ¬¡</th><th>é–‹å§‹</th><th>çµæŸ</th></tr></thead><tbody>' + ps.map((p, i) => '<tr><td>ç¬¬' + p.n + 'ç¯€</td><td><input type="time" class="form-input" value="' + p.s + '" onchange="updatePeriod(' + i + ',\'s\',this.value)" style="padding:8px"></td><td><input type="time" class="form-input" value="' + p.e + '" onchange="updatePeriod(' + i + ',\'e\',this.value)" style="padding:8px"></td></tr>').join('') + '</tbody></table>';
            updatePeriodDropdowns();
        }
        function updatePeriod(idx, key, val) {
            sem.periods[idx][key] = val;
            saveSemesterToStorage();
        }
        function calcWeeks() {
            const s = document.getElementById('semester-start').value;
            const e = document.getElementById('semester-end').value;
            if (s && e) {
                const weeks = Math.ceil((new Date(e) - new Date(s)) / (7 * 24 * 60 * 60 * 1000));
                document.getElementById('semester-weeks').textContent = weeks;
                sem.start = s;
                sem.end = e;
                sem.weeks = weeks;
            }
        }
        function saveSemester() {
            calcWeeks();
            saveSemesterToStorage();
            toast('å­¸æœŸè¨­å®šå·²å„²å­˜ï¼');
        }
        function updatePeriodDropdowns() {
            const ps = sem.periods && sem.periods.length > 0 ? sem.periods : PERIODS[sem.div || 'day'];
            const opts = ps.map(p => '<option value="' + p.n + '">ç¬¬' + p.n + 'ç¯€ (' + p.s + '-' + p.e + ')</option>').join('');
            document.getElementById('course-period').innerHTML = opts;
            document.getElementById('edit-course-period').innerHTML = opts;
        }

        // === ç­ç´šç®¡ç† ===
        async function loadClasses() {
            const data = await api('/api/classes');
            if (data) {
                classes = data;
                renderClasses();
                updateClassDropdowns();
            }
        }
        function renderClasses() {
            document.getElementById('classes-list').innerHTML = classes.length ? classes.map(c => 
                '<div class="item-card" onclick="editClass(\'' + c.code + '\')">' +
                '<div class="icon" style="background:var(--primary)">ğŸ«</div>' +
                '<div class="info"><h5>' + c.code + ' - ' + c.name + '</h5><span>' + (DIV_NAMES[c.division] || 'æ—¥é–“éƒ¨') + (c.teacher ? ' Â· ' + c.teacher : '') + '</span></div>' +
                '<div class="actions"><span class="badge primary">' + (c.count || 0) + ' äºº</span></div></div>'
            ).join('') : '<div class="empty">å°šç„¡ç­ç´šï¼Œè«‹é»æ“Šä¸Šæ–¹æŒ‰éˆ•æ–°å¢</div>';
        }
        async function addClass() {
            const code = document.getElementById('class-code').value.trim();
            const name = document.getElementById('class-name').value.trim();
            const division = document.getElementById('class-division').value;
            const teacher = document.getElementById('class-teacher').value.trim();
            if (!code || !name) { toast('è«‹å¡«å¯«ç­ç´šä»£ç¢¼å’Œåç¨±', 'danger'); return; }
            const r = await api('/api/classes', { method: 'POST', body: JSON.stringify({ code, name, division, teacher }) });
            if (r?.success) { toast('ç­ç´šå·²æ–°å¢ï¼'); closeModal('addClass'); loadClasses(); document.getElementById('class-code').value = ''; document.getElementById('class-name').value = ''; document.getElementById('class-teacher').value = ''; }
            else { toast(r?.message || 'æ–°å¢å¤±æ•—', 'danger'); }
        }
        function editClass(code) {
            currentClass = classes.find(c => c.code === code);
            if (!currentClass) return;
            document.getElementById('edit-class-code').value = currentClass.code;
            document.getElementById('edit-class-name').value = currentClass.name;
            document.getElementById('edit-class-division').value = currentClass.division || 'day';
            document.getElementById('edit-class-teacher').value = currentClass.teacher || '';
            openModal('editClass');
        }
        async function saveClass() {
            const name = document.getElementById('edit-class-name').value.trim();
            const division = document.getElementById('edit-class-division').value;
            const teacher = document.getElementById('edit-class-teacher').value.trim();
            console.log('å„²å­˜ç­ç´š:', currentClass.code, { name, division, teacher });
            const r = await api('/api/classes/' + currentClass.code, { method: 'PUT', body: JSON.stringify({ name, division, teacher }) });
            console.log('API å›æ‡‰:', r);
            if (r?.success) { 
                toast('ç­ç´šå·²æ›´æ–°ï¼'); 
                closeModal('editClass'); 
                loadClasses(); 
            } else {
                toast(r?.message || 'æ›´æ–°å¤±æ•—', 'danger');
            }
        }
        async function deleteClass() {
            if (!confirm('ç¢ºå®šåˆªé™¤ç­ç´š ' + currentClass.code + 'ï¼Ÿ')) return;
            const r = await api('/api/classes/' + currentClass.code, { method: 'DELETE' });
            if (r?.success) {
                toast('ç­ç´šå·²åˆªé™¤ï¼'); 
                closeModal('editClass'); 
                loadClasses();
            } else {
                toast('åˆªé™¤å¤±æ•—', 'danger');
            }
        }
        function updateClassDropdowns() {
            const opts = '<option value="">é¸æ“‡ç­ç´š</option>' + classes.map(c => '<option value="' + c.code + '">' + c.code + ' - ' + c.name + '</option>').join('');
            document.getElementById('course-class').innerHTML = opts;
            document.getElementById('edit-course-class').innerHTML = opts;
            document.getElementById('student-class').innerHTML = opts;
            document.getElementById('edit-student-class').innerHTML = opts;
            document.getElementById('student-filter').innerHTML = '<option value="">å…¨éƒ¨ç­ç´š</option>' + classes.map(c => '<option value="' + c.code + '">' + c.name + '</option>').join('');
        }

        // === èª²ç¨‹ç®¡ç† ===
        async function loadCourses() {
            const data = await api('/api/courses');
            console.log('è¼‰å…¥èª²ç¨‹:', data);
            if (data) {
                courses = data;
                console.log('èª²ç¨‹è³‡æ–™:', courses.map(c => ({ id: c.id, name: c.name || c.subject, day: c.day, period: c.period })));
                renderCourses();
                renderScheduleGrid();
            }
        }
        function renderCourses() {
            document.getElementById('courses-list').innerHTML = courses.length ? courses.map(c => {
                const dayName = DAY_NAMES[c.day] || '?';
                const period = c.period || '?';
                return '<div class="item-card" onclick="editCourse(\'' + c.id + '\')">' +
                    '<div class="icon" style="background:var(--success)">ğŸ“–</div>' +
                    '<div class="info"><h5>' + (c.name || c.subject || 'æœªå‘½å') + '</h5><span>ç­ç´š ' + c.classCode + ' Â· é€±' + dayName + ' ç¬¬' + period + 'ç¯€ Â· ' + (c.room || 'æ•™å®¤æœªè¨­å®š') + '</span></div></div>';
            }).join('') : '<div class="empty">å°šç„¡èª²ç¨‹</div>';
        }
        function showView(view) {
            document.querySelectorAll('.tabs .tab').forEach((t, i) => t.classList.toggle('active', i === (view === 'grid' ? 0 : 1)));
            document.getElementById('grid-view').style.display = view === 'grid' ? 'block' : 'none';
            document.getElementById('list-view').style.display = view === 'list' ? 'block' : 'none';
        }
        function renderScheduleGrid() {
            const div = sem.div || 'day';
            const ps = sem.periods && sem.periods.length > 0 ? sem.periods : PERIODS[div];
            const days = div === 'weekend' ? ['', 'å…­', 'æ—¥'] : ['', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”'];
            let html = days.map(d => '<div class="schedule-header">' + (d || 'ç¯€æ¬¡') + '</div>').join('');
            ps.forEach(p => {
                html += '<div class="schedule-time">' + p.n + '<br><small>' + p.s + '</small></div>';
                for (let i = 1; i < days.length; i++) {
                    const dayNum = div === 'weekend' ? (i === 1 ? 6 : 0) : i;
                    const c = courses.find(x => x.day == dayNum && x.period == p.n);
                    if (c) {
                        html += '<div class="schedule-cell has-class" onclick="editCourse(\'' + c.id + '\')"><div class="class-tag">' + (c.name || c.subject) + '<br>' + c.classCode + '</div></div>';
                    } else {
                        html += '<div class="schedule-cell" onclick="quickAddCourse(' + dayNum + ',' + p.n + ')"></div>';
                    }
                }
            });
            document.getElementById('schedule-grid').innerHTML = html;
            document.getElementById('schedule-grid').style.gridTemplateColumns = '60px repeat(' + (days.length - 1) + ', 1fr)';
        }
        function quickAddCourse(day, period) {
            document.getElementById('course-day').value = day;
            document.getElementById('course-period').value = period;
            openModal('addCourse');
        }
        async function addCourse() {
            const name = document.getElementById('course-name').value.trim();
            const classCode = document.getElementById('course-class').value;
            const day = parseInt(document.getElementById('course-day').value);
            const period = parseInt(document.getElementById('course-period').value);
            const room = document.getElementById('course-room').value.trim();
            const lat = document.getElementById('course-lat').value;
            const lon = document.getElementById('course-lon').value;
            if (!name || !classCode) { toast('è«‹å¡«å¯«èª²ç¨‹åç¨±å’Œç­ç´š', 'danger'); return; }
            const p = ((sem.periods && sem.periods.length > 0 ? sem.periods : PERIODS[sem.div || "day"])).find(x => x.n == period) || {};
            const r = await api('/api/courses', { method: 'POST', body: JSON.stringify({ subject: name, name, classCode, day, period, time: p.s + '-' + p.e, room, lat: lat ? +lat : 0, lon: lon ? +lon : 0, radius: 50000 }) });
            if (r?.success) { toast('èª²ç¨‹å·²æ–°å¢ï¼'); closeModal('addCourse'); loadCourses(); document.getElementById('course-name').value = ''; document.getElementById('course-room').value = ''; }
        }
        function editCourse(id) {
            currentCourse = courses.find(c => c.id === id);
            if (!currentCourse) return;
            document.getElementById('edit-course-name').value = currentCourse.name || currentCourse.subject || '';
            document.getElementById('edit-course-class').value = currentCourse.classCode || '';
            document.getElementById('edit-course-day').value = currentCourse.day || 1;
            document.getElementById('edit-course-period').value = currentCourse.period || 1;
            document.getElementById('edit-course-room').value = currentCourse.room || '';
            openModal('editCourse');
        }
        async function saveCourse() {
            const subject = document.getElementById('edit-course-name').value.trim();
            const classCode = document.getElementById('edit-course-class').value;
            const day = parseInt(document.getElementById('edit-course-day').value);
            const period = parseInt(document.getElementById('edit-course-period').value);
            const room = document.getElementById('edit-course-room').value.trim();
            const p = ((sem.periods && sem.periods.length > 0 ? sem.periods : PERIODS[sem.div || "day"])).find(x => x.n == period) || {};
            console.log('å„²å­˜èª²ç¨‹:', currentCourse.id, { subject, classCode, day, period, room });
            const r = await api('/api/courses/' + currentCourse.id, { method: 'PUT', body: JSON.stringify({ subject, classCode, day, period, time: p.s + '-' + p.e, room }) });
            console.log('API å›æ‡‰:', r);
            if (r?.success) { 
                toast('èª²ç¨‹å·²æ›´æ–°ï¼'); 
                closeModal('editCourse'); 
                loadCourses(); 
            } else {
                toast(r?.message || 'æ›´æ–°å¤±æ•—', 'danger');
            }
        }
        async function deleteCourse() {
            if (!confirm('ç¢ºå®šåˆªé™¤æ­¤èª²ç¨‹ï¼Ÿ')) return;
            const r = await api('/api/courses/' + currentCourse.id, { method: 'DELETE' });
            if (r?.success) {
                toast('èª²ç¨‹å·²åˆªé™¤ï¼'); 
                closeModal('editCourse'); 
                loadCourses();
            } else {
                toast('åˆªé™¤å¤±æ•—', 'danger');
            }
        }
        function getLocation() {
            if (!navigator.geolocation) { toast('ç€è¦½å™¨ä¸æ”¯æ´å®šä½', 'danger'); return; }
            toast('å®šä½ä¸­...', 'warning');
            navigator.geolocation.getCurrentPosition(pos => {
                document.getElementById('course-lat').value = pos.coords.latitude.toFixed(6);
                document.getElementById('course-lon').value = pos.coords.longitude.toFixed(6);
                toast('å®šä½æˆåŠŸï¼');
            }, () => toast('å®šä½å¤±æ•—', 'danger'), { enableHighAccuracy: true });
        }

        // === å­¸ç”Ÿç®¡ç† ===
        async function loadStudents() {
            const filter = document.getElementById('student-filter')?.value || '';
            const data = await api('/api/students');
            if (data) {
                students = filter ? data.filter(s => s.classCode === filter) : data;
                renderStudents();
            }
        }
        function renderStudents() {
            document.getElementById('students-list').innerHTML = students.length ? students.map(s =>
                '<div class="item-card" onclick="editStudent(\'' + s.studentId + '\')">' +
                '<div class="icon" style="background:var(--primary)">' + (s.name ? s.name.charAt(0) : '?') + '</div>' +
                '<div class="info"><h5>' + s.studentId + ' - ' + s.name + '</h5><span>' + s.classCode + (s.lineId ? ' Â· LINE å·²ç¶å®š' : '') + '</span></div></div>'
            ).join('') : '<div class="empty">å°šç„¡å­¸ç”Ÿ</div>';
        }
        async function addStudent() {
            const studentId = document.getElementById('student-id').value.trim();
            const name = document.getElementById('student-name').value.trim();
            const classCode = document.getElementById('student-class').value;
            const phone = document.getElementById('student-phone').value.trim();
            const parentPhone = document.getElementById('student-parent-phone').value.trim();
            if (!studentId || !name || !classCode) { toast('è«‹å¡«å¯«å­¸è™Ÿã€å§“åå’Œç­ç´š', 'danger'); return; }
            const r = await api('/api/students', { method: 'POST', body: JSON.stringify({ studentId, name, classCode, phone, parentPhone }) });
            if (r?.success) { toast('å­¸ç”Ÿå·²æ–°å¢ï¼'); closeModal('addStudent'); loadStudents(); document.getElementById('student-id').value = ''; document.getElementById('student-name').value = ''; document.getElementById('student-phone').value = ''; document.getElementById('student-parent-phone').value = ''; }
            else { toast(r?.message || 'æ–°å¢å¤±æ•—', 'danger'); }
        }
        function editStudent(id) {
            currentStudent = students.find(s => s.studentId === id);
            if (!currentStudent) return;
            document.getElementById('edit-student-id').value = currentStudent.studentId;
            document.getElementById('edit-student-name').value = currentStudent.name;
            document.getElementById('edit-student-class').value = currentStudent.classCode;
            document.getElementById('edit-student-phone').value = currentStudent.phone || '';
            document.getElementById('edit-student-parent-phone').value = currentStudent.parentPhone || '';
            openModal('editStudent');
        }
        async function saveStudent() {
            const name = document.getElementById('edit-student-name').value.trim();
            const classCode = document.getElementById('edit-student-class').value;
            const phone = document.getElementById('edit-student-phone').value.trim();
            const parentPhone = document.getElementById('edit-student-parent-phone').value.trim();
            const r = await api('/api/students/' + currentStudent.studentId, { method: 'PUT', body: JSON.stringify({ name, classCode, phone, parentPhone }) });
            if (r?.success) { toast('å­¸ç”Ÿå·²æ›´æ–°ï¼'); closeModal('editStudent'); loadStudents(); }
        }
        async function deleteStudent() {
            if (!confirm('ç¢ºå®šåˆªé™¤å­¸ç”Ÿ ' + currentStudent.name + 'ï¼Ÿ')) return;
            await api('/api/students/' + currentStudent.studentId, { method: 'DELETE' });
            toast('å­¸ç”Ÿå·²åˆªé™¤ï¼'); closeModal('editStudent'); loadStudents();
        }

        // === ç°½åˆ°ç®¡ç† ===
        async function loadSessions() {
            const now = new Date();
            document.getElementById('session-date').textContent = now.toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });
            const dow = now.getDay();
            console.log('ä»Šå¤©æ˜ŸæœŸ:', dow, 'èª²ç¨‹æ•¸:', courses.length);
            const today = courses.filter(c => {
                console.log('æª¢æŸ¥èª²ç¨‹:', c.name || c.subject, 'æ˜ŸæœŸ:', c.day, 'åŒ¹é…:', c.day == dow);
                return c.day == dow;
            });
            console.log('ä»Šæ—¥èª²ç¨‹:', today);
            if (!today.length) {
                document.getElementById('sessions-list').innerHTML = '<div class="empty"><div class="icon">ğŸ“…</div><h3>ä»Šæ—¥ç„¡èª²ç¨‹</h3><p style="color:var(--text-light);margin-top:10px">è«‹å…ˆåœ¨èª²è¡¨ç®¡ç†æ–°å¢ä»Šå¤©ï¼ˆæ˜ŸæœŸ' + DAY_NAMES[dow] + 'ï¼‰çš„èª²ç¨‹</p></div>';
                return;
            }
            document.getElementById('sessions-list').innerHTML = today.map(c => {
                const p = ((sem.periods && sem.periods.length > 0 ? sem.periods : PERIODS[sem.div || "day"])).find(x => x.n == c.period) || { s: '', e: '' };
                const nowTime = now.getHours() * 60 + now.getMinutes();
                const endTime = parseInt((p.e || '17:00').split(':')[0]) * 60 + parseInt((p.e || '17:00').split(':')[1] || 0);
                const completed = nowTime > endTime;
                return '<div class="session-item' + (completed ? ' completed' : '') + '"><div class="session-header"><div class="session-icon">ğŸ“–</div><div class="session-info"><h4>' + (c.name || c.subject) + ' - ' + c.classCode + '</h4><span>ç¬¬' + c.period + 'ç¯€ Â· ' + p.s + '-' + p.e + ' Â· ' + (c.room || 'æ•™å®¤') + '</span></div></div><div class="session-actions">' + (completed ? '<button class="btn btn-outline btn-sm" disabled>å·²çµæŸ</button>' : '<button class="btn btn-primary btn-sm" onclick="startSession(\'' + c.id + '\')">ğŸ“± ç°½åˆ°</button><button class="btn btn-outline btn-sm" onclick="endSession(\'' + c.id + '\')">â¹ï¸ çµæŸ</button>') + '</div></div>';
            }).join('');
        }
        async function startSession(id) {
            const c = courses.find(x => x.id === id);
            if (!c) {
                toast('æ‰¾ä¸åˆ°èª²ç¨‹', 'danger');
                return;
            }
            const today = new Date().toISOString().split('T')[0];
            const p = ((sem.periods && sem.periods.length > 0 ? sem.periods : PERIODS[sem.div || "day"])).find(x => x.n == c.period) || { s: '08:00', e: '09:00' };
            console.log('å»ºç«‹ç°½åˆ°:', { courseId: id, date: today, startTime: p.s, endTime: p.e });
            
            const r = await api('/api/sessions', { method: 'POST', body: JSON.stringify({ courseId: id, date: today, startTime: p.s, endTime: p.e }) });
            console.log('API å›æ‡‰:', r);
            
            if (r?.success && r.qrContent) {
                showQR(r.qrContent, (c.name || c.subject) + ' - ' + c.classCode, today + ' ' + p.s);
                toast('ç°½åˆ°å·²å»ºç«‹ï¼');
            } else {
                toast(r?.error || 'å»ºç«‹ç°½åˆ°å¤±æ•—', 'danger');
            }
        }
        async function endSession(id) {
            if (!confirm('ç¢ºå®šçµæŸï¼Ÿæœªç°½åˆ°å­¸ç”Ÿå°‡è¢«æ¨™è¨˜ç‚ºç¼ºå¸­ã€‚')) return;
            const r = await api('/api/sessions/' + id + '/complete', { method: 'POST' });
            if (r?.success) { toast('å·²çµæŸï¼Œ' + (r.marked || 0) + ' äººç¼ºå¸­'); loadSessions(); }
            else { toast('çµæŸå¤±æ•—', 'danger'); }
        }
        function showQR(content, name, time) {
            console.log('é¡¯ç¤º QR Code:', { content, name, time, BOT });
            
            // å…ˆè¨­å®šæ–‡å­—å’Œé–‹å•Ÿ modal
            document.getElementById('qr-name').textContent = name;
            document.getElementById('qr-time').textContent = time;
            openModal('qr');
            
            // çŸ­æš«å»¶é²å¾Œç”Ÿæˆ QR Codeï¼ˆç¢ºä¿ canvas å·²ç¶“å¯è¦‹ï¼‰
            setTimeout(() => {
                try {
                    const canvas = document.getElementById('qr-canvas');
                    if (!canvas) {
                        console.error('æ‰¾ä¸åˆ° canvas å…ƒç´ ');
                        toast('QR Code ç”¢ç”Ÿå¤±æ•—ï¼šæ‰¾ä¸åˆ°ç•«å¸ƒ', 'danger');
                        return;
                    }
                    
                    // æª¢æŸ¥ BOT ID
                    const botId = BOT || '@516bpeih';
                    const qrUrl = 'https://line.me/R/oaMessage/' + botId + '/?' + encodeURIComponent(content);
                    console.log('QR URL:', qrUrl);
                    
                    if (typeof QRCode === 'undefined') {
                        console.error('QRCode å‡½å¼åº«æœªè¼‰å…¥');
                        toast('QR Code å‡½å¼åº«è¼‰å…¥å¤±æ•—', 'danger');
                        return;
                    }
                    
                    QRCode.toCanvas(canvas, qrUrl, { width: 200 }, function(error) {
                        if (error) {
                            console.error('QR Code ç”¢ç”ŸéŒ¯èª¤:', error);
                            toast('QR Code ç”¢ç”Ÿå¤±æ•—: ' + error.message, 'danger');
                        } else {
                            console.log('QR Code ç”¢ç”ŸæˆåŠŸ');
                        }
                    });
                } catch (e) {
                    console.error('QR Code éŒ¯èª¤:', e);
                    toast('QR Code ç”¢ç”Ÿå¤±æ•—: ' + e.message, 'danger');
                }
            }, 100);
        }
        function downloadQR() {
            const canvas = document.getElementById('qr-canvas');
            const link = document.createElement('a');
            link.download = 'qrcode.png';
            link.href = canvas.toDataURL();
            link.click();
            toast('å·²ä¸‹è¼‰ï¼');
        }

        // === è«‹å‡ç®¡ç† ===
        async function loadLeaves() {
            const data = await api('/api/leaves');
            if (data) {
                leaves = data;
                const pending = leaves.filter(l => l.status === 'å¾…å¯©æ ¸').length;
                const badge = document.getElementById('leave-badge');
                badge.style.display = pending > 0 ? 'inline' : 'none';
                badge.textContent = pending;
                renderLeaves();
            }
        }
        function filterLeaves(filter) {
            leaveFilter = filter;
            document.querySelectorAll('#page-leaves .tab').forEach((t, i) => {
                const filters = ['pending', 'approved', 'rejected', 'all'];
                t.classList.toggle('active', filters[i] === filter);
            });
            renderLeaves();
        }
        function renderLeaves() {
            let filtered = leaves;
            if (leaveFilter === 'pending') filtered = leaves.filter(l => l.status === 'å¾…å¯©æ ¸');
            else if (leaveFilter === 'approved') filtered = leaves.filter(l => l.status === 'å·²æ ¸å‡†');
            else if (leaveFilter === 'rejected') filtered = leaves.filter(l => l.status === 'å·²é§å›');
            document.getElementById('leaves-list').innerHTML = filtered.length ? filtered.map(l => {
                const badge = l.status === 'å¾…å¯©æ ¸' ? 'warning' : l.status === 'å·²æ ¸å‡†' ? 'success' : 'danger';
                return '<div class="leave-item ' + l.status.replace('å·²', '').toLowerCase() + '"><div style="display:flex;justify-content:space-between;margin-bottom:8px"><b>' + l.name + ' (' + l.studentId + ')</b><span class="badge ' + badge + '">' + l.status + '</span></div><div style="font-size:14px;color:var(--text-light);margin-bottom:10px">ğŸ“… ' + l.date + ' Â· ç¬¬' + l.periods + 'ç¯€<br>ğŸ“ ' + l.type + 'ï¼š' + (l.reason || 'ç„¡èªªæ˜') + '</div>' + (l.status === 'å¾…å¯©æ ¸' ? '<button class="btn btn-sm btn-success" onclick="openReviewLeave(\'' + l.id + '\')">å¯©æ ¸</button>' : '') + '</div>';
            }).join('') : '<div class="empty">ç„¡è«‹å‡ç´€éŒ„</div>';
        }
        function openReviewLeave(id) {
            currentLeave = leaves.find(l => l.id === id);
            if (!currentLeave) return;
            document.getElementById('leave-detail').innerHTML = '<div class="alert alert-info"><b>' + currentLeave.name + '</b> (' + currentLeave.studentId + ')<br>ğŸ“… ' + currentLeave.date + ' Â· ç¬¬' + currentLeave.periods + 'ç¯€<br>ğŸ“ ' + currentLeave.type + 'ï¼š' + (currentLeave.reason || 'ç„¡') + '</div>';
            document.getElementById('review-note').value = '';
            openModal('reviewLeave');
        }
        async function reviewLeave(status) {
            if (!currentLeave) return;
            const note = document.getElementById('review-note').value.trim();
            const r = await api('/api/leaves/' + currentLeave.id, { method: 'PUT', body: JSON.stringify({ status, note }) });
            if (r?.success) { toast(status === 'å·²æ ¸å‡†' ? 'å·²æ ¸å‡†ï¼' : 'å·²é§å›ï¼'); closeModal('reviewLeave'); loadLeaves(); }
        }

        // === å‡ºç¼ºç´€éŒ„ ===
        async function loadRecords() {
            const data = await api('/api/records');
            document.getElementById('records-table').innerHTML = data?.length ? data.slice(-50).reverse().map(r => {
                const badge = r.status === 'å·²å ±åˆ°' ? 'success' : r.status === 'é²åˆ°' ? 'warning' : 'danger';
                return '<tr><td>' + (r.date || '-') + '</td><td>' + r.studentId + '</td><td>' + (r.studentName || '-') + '</td><td><span class="badge ' + badge + '">' + r.status + '</span></td></tr>';
            }).join('') : '<tr><td colspan="4" class="empty">å°šç„¡ç´€éŒ„</td></tr>';
        }
        async function addRecord() {
            const studentId = document.getElementById('record-student').value.trim();
            const date = document.getElementById('record-date').value;
            const status = document.getElementById('record-status').value;
            const note = document.getElementById('record-note').value.trim();
            if (!studentId || !date) { toast('è«‹å¡«å¯«å­¸è™Ÿå’Œæ—¥æœŸ', 'danger'); return; }
            const r = await api('/api/records/manual', { method: 'POST', body: JSON.stringify({ studentId, date, status, note }) });
            if (r?.success) { toast('ç´€éŒ„å·²æ–°å¢ï¼'); closeModal('addRecord'); loadRecords(); }
        }

        // === çµ±è¨ˆ ===
        async function loadStats() {
            const data = await api('/api/stats/attendance');
            if (data) {
                document.getElementById('overall-rate').textContent = data.overall + '%';
                document.getElementById('stats-attended').textContent = data.attended || 0;
                document.getElementById('stats-late').textContent = data.late || 0;
                document.getElementById('stats-absent').textContent = data.absent || 0;
                document.getElementById('stats-total').textContent = data.totalRecords || 0;
                const offset = 327 - 327 * (data.overall / 100);
                document.getElementById('progress-circle').style.strokeDashoffset = offset;
                const low = data.lowAttendance || [];
                document.getElementById('low-attendance-list').innerHTML = low.length ? low.slice(0, 10).map(s => '<div class="student-alert ' + (s.rate < 60 ? 'critical' : 'warning') + '"><div class="avatar">' + s.name.charAt(0) + '</div><div class="info"><h5>' + s.name + ' (' + s.studentId + ')</h5><span>' + s.classCode + ' Â· å‡ºå¸­ç‡ ' + s.rate + '%</span></div></div>').join('') : '<div class="empty">æ‰€æœ‰å­¸ç”Ÿå‡ºå¸­ç‡è‰¯å¥½ ğŸ‘</div>';
            }
        }

        // === è­¦ç¤º ===
        async function loadAlerts() {
            const data = await api('/api/stats/consecutive-absent');
            if (data?.alerts) {
                document.getElementById('alert-list').innerHTML = data.alerts.length ? data.alerts.map(s => '<div class="student-alert ' + (s.level === 'critical' ? 'critical' : 'warning') + '"><div class="avatar">' + s.name.charAt(0) + '</div><div class="info"><h5>' + s.name + ' (' + s.studentId + ')</h5><span>' + s.classCode + ' Â· é€£çºŒç¼ºå¸­ <b>' + s.consecutiveAbsent + '</b> æ¬¡</span></div><button class="btn btn-sm btn-danger" onclick="sendWarning(\'' + s.studentId + '\',' + s.consecutiveAbsent + ')">ğŸ“² é€šçŸ¥</button></div>').join('') : '<div class="empty">ç›®å‰æ²’æœ‰é€£çºŒç¼ºå¸­çš„å­¸ç”Ÿ âœ¨</div>';
            }
        }
        async function sendWarning(id, count) {
            const r = await api('/api/notify/warning', { method: 'POST', body: JSON.stringify({ studentId: id, consecutiveCount: count }) });
            toast(r?.success ? 'è­¦å‘Šå·²ç™¼é€ï¼' : 'ç™¼é€å¤±æ•—', r?.success ? 'success' : 'danger');
        }
        async function sendAllWarnings() {
            const data = await api('/api/stats/consecutive-absent');
            if (data?.alerts) {
                for (const s of data.alerts) {
                    await api('/api/notify/warning', { method: 'POST', body: JSON.stringify({ studentId: s.studentId, consecutiveCount: s.consecutiveAbsent }) });
                }
                toast('å·²ç™¼é€ ' + data.alerts.length + ' å‰‡è­¦å‘Šï¼');
            }
        }

        // === å„€è¡¨æ¿ ===
        async function loadDashboard() {
            const now = new Date();
            document.getElementById('today-info').textContent = now.toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });
            const data = await api('/api/dashboard');
            if (data) {
                document.getElementById('stat-students').textContent = data.totalStudents || 0;
                document.getElementById('stat-attended').textContent = data.todayAttended || 0;
                document.getElementById('stat-late').textContent = data.todayLate || 0;
                document.getElementById('stat-absent').textContent = data.todayAbsent || 0;
            }
            const dow = now.getDay();
            const today = courses.filter(c => c.day == dow);
            document.getElementById('today-classes').innerHTML = today.length ? today.map(c => {
                const p = ((sem.periods && sem.periods.length > 0 ? sem.periods : PERIODS[sem.div || "day"])).find(x => x.n == c.period) || { s: '', e: '' };
                return '<div style="padding:10px;border:1px solid var(--border);border-radius:10px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center"><div><b>' + (c.name || c.subject) + '</b> - ' + c.classCode + '<br><small>ç¬¬' + c.period + 'ç¯€ ' + p.s + '-' + p.e + '</small></div><button class="btn btn-primary btn-sm" onclick="startSession(\'' + c.id + '\')">ğŸ“±</button></div>';
            }).join('') : '<div class="empty">ä»Šæ—¥ç„¡èª²ç¨‹</div>';
            const alerts = await api('/api/stats/consecutive-absent');
            document.getElementById('dashboard-alerts').innerHTML = alerts?.alerts?.length ? alerts.alerts.slice(0, 3).map(s => '<div style="padding:8px 0;border-bottom:1px solid var(--border)">âš ï¸ ' + s.name + ' é€£çºŒç¼ºå¸­ ' + s.consecutiveAbsent + ' æ¬¡</div>').join('') : '<div class="empty">ç„¡ç•°å¸¸ âœ¨</div>';
        }

        // === è¨­å®š ===
        async function testConn() {
            const url = document.getElementById('api-url').value.trim();
            if (!url) { toast('è«‹è¼¸å…¥ç¶²å€', 'danger'); return; }
            toast('æ¸¬è©¦ä¸­...', 'warning');
            try {
                const res = await fetch(url + '/api/health');
                if (res.ok) {
                    API = url;
                    localStorage.setItem('apiUrl', url);
                    document.getElementById('status-dot').classList.add('connected');
                    toast('é€£ç·šæˆåŠŸï¼');
                    loadAll();
                } else throw new Error();
            } catch { toast('é€£ç·šå¤±æ•—', 'danger'); }
        }
        function saveBotId() {
            BOT = document.getElementById('bot-id').value.trim() || '@bot';
            localStorage.setItem('botId', BOT);
            toast('Bot ID å·²å„²å­˜ï¼');
        }

        // === é é¢è¼‰å…¥ ===
        function loadPage(page) {
            if (page === 'dashboard') loadDashboard();
            if (page === 'semester') { initSemesterUI(); }
            if (page === 'schedule') { renderScheduleGrid(); renderCourses(); }
            if (page === 'sessions') loadSessions();
            if (page === 'classes') loadClasses();
            if (page === 'students') loadStudents();
            if (page === 'leaves') loadLeaves();
            if (page === 'records') { document.getElementById('record-date').value = new Date().toISOString().split('T')[0]; loadRecords(); }
            if (page === 'stats') loadStats();
            if (page === 'alerts') loadAlerts();
            if (page === 'linebot') document.getElementById('bot-id').value = BOT;
        }
        async function loadAll() {
            await loadClasses();
            await loadCourses();
            await loadLeaves();
            await loadDashboard();
        }
        function init() {
            document.getElementById('api-url').value = API;
            document.getElementById('bot-id').value = BOT;
            
            // å¾ localStorage è®€å–å­¸æœŸè¨­å®š
            loadSemesterFromStorage();
            console.log('è¼‰å…¥çš„ sem:', sem);
            
            // åˆå§‹åŒ–å­¸æœŸè¨­å®š UI
            initSemesterUI();
            
            // è‡ªå‹•åµæ¸¬ API
            if (!API && location.origin.includes('onrender.com')) {
                API = location.origin;
                localStorage.setItem('apiUrl', API);
                document.getElementById('api-url').value = API;
            }
            if (API) loadAll();
        }
        init();
    </script>
</body>
</html>
