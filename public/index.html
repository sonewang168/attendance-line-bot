<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“š ç°½åˆ°ç³»çµ± Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        :root{--primary:#4f46e5;--primary-dark:#3730a3;--success:#10b981;--warning:#f59e0b;--danger:#ef4444;--bg:#f8fafc;--card:#fff;--text:#1e293b;--text-light:#64748b;--border:#e2e8f0}
        *{margin:0;padding:0;box-sizing:border-box}body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:var(--bg);color:var(--text)}
        .mobile-header{position:fixed;top:0;left:0;right:0;height:56px;background:linear-gradient(135deg,var(--primary-dark),var(--primary));color:#fff;display:flex;align-items:center;padding:0 15px;z-index:1001}
        .hamburger{width:44px;height:44px;display:flex;flex-direction:column;justify-content:center;align-items:center;gap:5px;background:rgba(255,255,255,.1);border:none;border-radius:10px;cursor:pointer}
        .hamburger span{display:block;width:20px;height:2px;background:#fff;transition:.3s}.hamburger.active span:nth-child(1){transform:rotate(45deg) translate(5px,5px)}.hamburger.active span:nth-child(2){opacity:0}.hamburger.active span:nth-child(3){transform:rotate(-45deg) translate(5px,-5px)}
        .mobile-title{flex:1;text-align:center;font-size:18px;font-weight:700}.status-dot{width:10px;height:10px;border-radius:50%;background:var(--danger)}.status-dot.connected{background:var(--success)}
        .sidebar-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:999}.sidebar-overlay.open{display:block}
        .sidebar{position:fixed;top:0;left:0;width:280px;height:100vh;background:linear-gradient(180deg,var(--primary-dark),var(--primary));color:#fff;padding:70px 0 20px;z-index:1000;transform:translateX(-100%);transition:.3s;overflow-y:auto}.sidebar.open{transform:translateX(0)}
        .nav-menu{list-style:none;padding:10px}.nav-section{padding:15px 15px 8px;font-size:11px;text-transform:uppercase;opacity:.6;letter-spacing:1px}
        .nav-link{display:flex;align-items:center;gap:12px;padding:14px 15px;color:rgba(255,255,255,.8);text-decoration:none;border-radius:12px;margin-bottom:4px;transition:.3s;font-size:15px}.nav-link:hover,.nav-link.active{background:rgba(255,255,255,.2);color:#fff}
        .nav-badge{background:var(--danger);color:#fff;font-size:11px;padding:2px 8px;border-radius:10px;margin-left:auto}
        .main{padding:70px 15px 20px}.header{margin-bottom:20px}.page-title{font-size:24px;font-weight:700;margin-bottom:5px}.page-subtitle{font-size:14px;color:var(--text-light);margin-bottom:15px}
        .stats-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:20px}
        .stat-card{background:var(--card);border-radius:16px;padding:18px;box-shadow:0 2px 8px rgba(0,0,0,.05);position:relative;overflow:hidden}
        .stat-card::before{content:'';position:absolute;top:0;left:0;width:4px;height:100%}.stat-card.primary::before{background:var(--primary)}.stat-card.success::before{background:var(--success)}.stat-card.warning::before{background:var(--warning)}.stat-card.danger::before{background:var(--danger)}
        .stat-value{font-size:28px;font-weight:700}.stat-card.primary .stat-value{color:var(--primary)}.stat-card.success .stat-value{color:var(--success)}.stat-card.warning .stat-value{color:var(--warning)}.stat-card.danger .stat-value{color:var(--danger)}
        .stat-label{font-size:13px;color:var(--text-light);margin-top:3px}.stat-icon{position:absolute;top:12px;right:12px;font-size:24px;opacity:.2}
        .card{background:var(--card);border-radius:16px;padding:18px;margin-bottom:15px;box-shadow:0 2px 8px rgba(0,0,0,.05)}.card-title{font-size:16px;font-weight:600;margin-bottom:15px;display:flex;align-items:center;gap:8px}
        .btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;padding:12px 18px;border:none;border-radius:10px;font-size:14px;font-weight:500;cursor:pointer;transition:.3s}
        .btn-primary{background:var(--primary);color:#fff}.btn-success{background:var(--success);color:#fff}.btn-warning{background:var(--warning);color:#fff}.btn-danger{background:var(--danger);color:#fff}.btn-outline{background:#fff;border:2px solid var(--border);color:var(--text)}.btn-block{width:100%}.btn-sm{padding:8px 12px;font-size:13px}
        .form-group{margin-bottom:18px}.form-label{display:block;margin-bottom:6px;font-weight:500;font-size:14px}
        .form-input,.form-select,.form-textarea{width:100%;padding:12px 14px;border:2px solid var(--border);border-radius:10px;font-size:16px;font-family:inherit;background:#fff}.form-input:focus,.form-select:focus,.form-textarea:focus{outline:none;border-color:var(--primary)}.form-textarea{min-height:80px;resize:vertical}
        .form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
        .chip-group{display:flex;flex-wrap:wrap;gap:8px}.chip{padding:10px 16px;border:2px solid var(--border);border-radius:25px;cursor:pointer;transition:.3s;font-size:14px;font-weight:500}.chip:hover{border-color:var(--primary)}.chip.active{background:var(--primary);color:#fff;border-color:var(--primary)}
        .chip.day.active{background:#3b82f6;border-color:#3b82f6}.chip.night.active{background:#8b5cf6;border-color:#8b5cf6}.chip.weekend.active{background:#f59e0b;border-color:#f59e0b}
        .period-table{width:100%;border-collapse:collapse;margin-top:10px}.period-table th,.period-table td{padding:10px;text-align:center;border:1px solid var(--border);font-size:14px}.period-table th{background:var(--bg);font-weight:600}
        .table-wrap{overflow-x:auto}table{width:100%;border-collapse:collapse}th,td{padding:12px 10px;text-align:left;border-bottom:1px solid var(--border);font-size:14px}th{background:var(--bg);font-weight:600;color:var(--text-light);font-size:12px}
        tr.clickable{cursor:pointer;transition:.2s}tr.clickable:hover{background:var(--bg)}
        .badge{padding:4px 10px;border-radius:20px;font-size:12px;font-weight:500}.badge.success{background:rgba(16,185,129,.1);color:var(--success)}.badge.warning{background:rgba(245,158,11,.1);color:var(--warning)}.badge.danger{background:rgba(239,68,68,.1);color:var(--danger)}.badge.primary{background:rgba(79,70,229,.1);color:var(--primary)}.badge.gray{background:#e2e8f0;color:var(--text-light)}
        .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:flex-end;justify-content:center;z-index:2000;opacity:0;visibility:hidden;transition:.3s}.modal-overlay.active{opacity:1;visibility:visible}
        .modal{background:#fff;border-radius:20px 20px 0 0;width:100%;max-height:90vh;overflow-y:auto;transform:translateY(100%);transition:.3s}.modal-overlay.active .modal{transform:translateY(0)}
        .modal-header{padding:18px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;background:#fff;z-index:1}.modal-title{font-size:18px;font-weight:600}.modal-close{background:none;border:none;font-size:28px;color:var(--text-light);cursor:pointer}
        .modal-body{padding:18px}.modal-footer{padding:15px 18px;border-top:1px solid var(--border);display:flex;gap:10px}.modal-footer .btn{flex:1}
        .alert{padding:14px 16px;border-radius:12px;margin-bottom:15px;font-size:14px;display:flex;align-items:flex-start;gap:10px}.alert-info{background:rgba(59,130,246,.1);color:#1d4ed8}.alert-warning{background:rgba(245,158,11,.1);color:#b45309}.alert-danger{background:rgba(239,68,68,.1);color:#b91c1c}.alert-success{background:rgba(16,185,129,.1);color:#047857}
        .qr-container{text-align:center;padding:20px}.qr-code{background:#fff;padding:15px;border-radius:16px;display:inline-block;box-shadow:0 4px 15px rgba(0,0,0,.1);margin-bottom:15px}.qr-info{color:var(--text-light);font-size:14px}.qr-info strong{color:var(--text);display:block;font-size:16px;margin-bottom:5px}
        .session-item{padding:15px;border:1px solid var(--border);border-radius:12px;margin-bottom:12px}.session-item.completed{background:#f8fafc;opacity:.7}
        .session-header{display:flex;align-items:center;gap:12px;margin-bottom:10px}.session-icon{width:44px;height:44px;background:linear-gradient(135deg,#818cf8,var(--primary));border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:20px;color:#fff}
        .session-info{flex:1}.session-info h4{font-size:15px;margin-bottom:3px}.session-info span{font-size:13px;color:var(--text-light)}.session-actions{display:flex;gap:8px}.session-actions .btn{flex:1}
        .schedule-grid{display:grid;gap:2px;font-size:11px}.schedule-header{padding:8px 4px;text-align:center;background:var(--primary);color:#fff;font-weight:600;border-radius:6px 6px 0 0}.schedule-time{padding:8px 4px;text-align:center;background:var(--bg);font-weight:500;display:flex;align-items:center;justify-content:center}
        .schedule-cell{min-height:50px;padding:4px;background:#fff;border:1px solid var(--border);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:.2s}.schedule-cell:hover{background:var(--bg)}.schedule-cell.has-class{background:rgba(79,70,229,.15)}.schedule-cell .class-tag{font-size:10px;padding:4px 6px;background:var(--primary);color:#fff;border-radius:4px;text-align:center;width:100%}
        .empty{text-align:center;padding:40px 20px;color:var(--text-light)}.empty .icon{font-size:48px;margin-bottom:12px;opacity:.5}
        .toast-container{position:fixed;top:70px;left:15px;right:15px;z-index:3000}.toast{background:var(--text);color:#fff;padding:14px 18px;border-radius:12px;margin-bottom:10px;display:flex;align-items:center;gap:10px;animation:slideDown .3s}.toast.success{background:var(--success)}.toast.warning{background:var(--warning)}.toast.danger{background:var(--danger)}@keyframes slideDown{from{transform:translateY(-20px);opacity:0}to{transform:translateY(0);opacity:1}}
        .page{display:none}.page.active{display:block}
        .tabs{display:flex;gap:5px;margin-bottom:15px}.tab{flex:1;padding:12px;text-align:center;border:2px solid var(--border);border-radius:10px;cursor:pointer;font-weight:500;font-size:14px}.tab.active{background:var(--primary);color:#fff;border-color:var(--primary)}
        .progress-ring{width:120px;height:120px;margin:0 auto 15px}.progress-ring circle{fill:none;stroke-width:8}.progress-ring .bg{stroke:var(--border)}.progress-ring .fg{stroke:var(--success);stroke-linecap:round;transform:rotate(-90deg);transform-origin:50% 50%;transition:stroke-dashoffset .5s}
        .big-stat{text-align:center;padding:20px}.big-stat .value{font-size:48px;font-weight:700}.big-stat .label{font-size:14px;color:var(--text-light)}
        .student-alert{display:flex;align-items:center;gap:12px;padding:12px;border:1px solid var(--border);border-radius:12px;margin-bottom:10px}
        .student-alert.critical{border-color:var(--danger);background:rgba(239,68,68,.05)}.student-alert.warning{border-color:var(--warning);background:rgba(245,158,11,.05)}.student-alert.success{border-color:var(--success);background:rgba(16,185,129,.05)}
        .student-alert .avatar{width:40px;height:40px;border-radius:50%;background:var(--primary);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:600}
        .student-alert .info{flex:1}.student-alert .info h5{font-size:14px;margin-bottom:2px}.student-alert .info span{font-size:12px;color:var(--text-light)}
        .switch{position:relative;width:50px;height:28px}.switch input{opacity:0;width:0;height:0}.switch .slider{position:absolute;inset:0;background:var(--border);border-radius:28px;transition:.3s;cursor:pointer}.switch .slider::before{content:'';position:absolute;width:22px;height:22px;left:3px;bottom:3px;background:#fff;border-radius:50%;transition:.3s}.switch input:checked+.slider{background:var(--success)}.switch input:checked+.slider::before{transform:translateX(22px)}
        .setting-item{display:flex;align-items:center;justify-content:space-between;padding:15px 0;border-bottom:1px solid var(--border)}.setting-item:last-child{border:none}.setting-item .label{font-size:15px}.setting-item .desc{font-size:12px;color:var(--text-light);margin-top:2px}
        .leave-item{padding:15px;border:1px solid var(--border);border-radius:12px;margin-bottom:10px}.leave-item.pending{border-left:4px solid var(--warning)}.leave-item.approved{border-left:4px solid var(--success)}.leave-item.rejected{border-left:4px solid var(--danger)}
        .chart-container{position:relative;height:200px;margin:15px 0}
        .item-card{padding:15px;border:1px solid var(--border);border-radius:12px;margin-bottom:10px;display:flex;align-items:center;gap:12px}
        .item-card .icon{width:44px;height:44px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:20px;color:#fff}
        .item-card .info{flex:1}.item-card .info h5{font-size:15px;margin-bottom:2px}.item-card .info span{font-size:13px;color:var(--text-light)}
        .item-card .actions{display:flex;gap:6px}
        @media(min-width:768px){.mobile-header{display:none}.sidebar{transform:translateX(0);padding-top:20px}.sidebar-overlay{display:none!important}.main{margin-left:280px;padding:30px}.modal{max-width:600px;border-radius:20px;margin:auto}.modal-overlay{align-items:center}.stats-grid{grid-template-columns:repeat(4,1fr)}}
    </style>
</head>
<body>
    <header class="mobile-header">
        <button class="hamburger" id="hamburger" onclick="toggleSidebar()"><span></span><span></span><span></span></button>
        <div class="mobile-title">ğŸ“š ç°½åˆ°ç³»çµ± Pro</div>
        <div class="status-dot" id="status-dot"></div>
    </header>
    <div class="sidebar-overlay" id="overlay" onclick="toggleSidebar()"></div>
    <aside class="sidebar" id="sidebar">
        <ul class="nav-menu">
            <li class="nav-section">ç¸½è¦½</li>
            <li><a href="#" class="nav-link active" data-page="dashboard"><span>ğŸ“Š</span> å„€è¡¨æ¿</a></li>
            <li class="nav-section">èª²ç¨‹ç®¡ç†</li>
            <li><a href="#" class="nav-link" data-page="semester"><span>ğŸ“…</span> å­¸æœŸè¨­å®š</a></li>
            <li><a href="#" class="nav-link" data-page="schedule"><span>ğŸ—“ï¸</span> èª²è¡¨ç®¡ç†</a></li>
            <li><a href="#" class="nav-link" data-page="sessions"><span>ğŸ“</span> ä»Šæ—¥ç°½åˆ°</a></li>
            <li class="nav-section">è³‡æ–™ç®¡ç†</li>
            <li><a href="#" class="nav-link" data-page="classes"><span>ğŸ«</span> ç­ç´šç®¡ç†</a></li>
            <li><a href="#" class="nav-link" data-page="students"><span>ğŸ‘¨â€ğŸ“</span> å­¸ç”Ÿåå–®</a></li>
            <li><a href="#" class="nav-link" data-page="leaves"><span>ğŸ“‹</span> è«‹å‡ç®¡ç†<span class="nav-badge" id="leave-badge" style="display:none">0</span></a></li>
            <li><a href="#" class="nav-link" data-page="records"><span>ğŸ“œ</span> å‡ºç¼ºç´€éŒ„</a></li>
            <li class="nav-section">çµ±è¨ˆåˆ†æ</li>
            <li><a href="#" class="nav-link" data-page="stats"><span>ğŸ“ˆ</span> å‡ºå¸­çµ±è¨ˆ</a></li>
            <li><a href="#" class="nav-link" data-page="alerts"><span>âš ï¸</span> ç¼ºå¸­è­¦ç¤º</a></li>
            <li class="nav-section">ç³»çµ±</li>
            <li><a href="#" class="nav-link" data-page="notifications"><span>ğŸ””</span> é€šçŸ¥è¨­å®š</a></li>
            <li><a href="#" class="nav-link" data-page="linebot"><span>ğŸ¤–</span> LINE Bot</a></li>
            <li><a href="#" class="nav-link" data-page="settings"><span>âš™ï¸</span> ç³»çµ±è¨­å®š</a></li>
        </ul>
    </aside>
    <main class="main">
        <!-- Dashboard -->
        <div class="page active" id="page-dashboard">
            <div class="header"><h1 class="page-title">å„€è¡¨æ¿</h1><p class="page-subtitle" id="today-info"></p></div>
            <div class="stats-grid">
                <div class="stat-card primary"><div class="stat-value" id="stat-students">-</div><div class="stat-label">è¨»å†Šå­¸ç”Ÿ</div><div class="stat-icon">ğŸ‘¨â€ğŸ“</div></div>
                <div class="stat-card success"><div class="stat-value" id="stat-attended">-</div><div class="stat-label">ä»Šæ—¥å‡ºå¸­</div><div class="stat-icon">âœ…</div></div>
                <div class="stat-card warning"><div class="stat-value" id="stat-late">-</div><div class="stat-label">ä»Šæ—¥é²åˆ°</div><div class="stat-icon">âš ï¸</div></div>
                <div class="stat-card danger"><div class="stat-value" id="stat-absent">-</div><div class="stat-label">ä»Šæ—¥ç¼ºå¸­</div><div class="stat-icon">âŒ</div></div>
            </div>
            <div class="card"><div class="card-title">ğŸ“… ä»Šæ—¥èª²ç¨‹</div><div id="today-classes"></div></div>
            <div class="card"><div class="card-title">âš ï¸ éœ€é—œæ³¨å­¸ç”Ÿ</div><div id="dashboard-alerts"></div></div>
        </div>
        <!-- Semester -->
        <div class="page" id="page-semester">
            <div class="header"><h1 class="page-title">å­¸æœŸè¨­å®š</h1><p class="page-subtitle">è¨­å®šå­¸æœŸæ—¥æœŸèˆ‡ç¯€æ¬¡æ™‚é–“</p></div>
            <div class="card"><div class="card-title">ğŸ« éƒ¨åˆ¥é¸æ“‡</div><div class="chip-group" id="division-chips"><div class="chip day" data-div="day" onclick="selectDivision('day')">â˜€ï¸ æ—¥é–“éƒ¨</div><div class="chip night" data-div="night" onclick="selectDivision('night')">ğŸŒ™ å¤œé–“éƒ¨</div><div class="chip weekend" data-div="weekend" onclick="selectDivision('weekend')">ğŸ“… é€²ä¿®éƒ¨</div></div></div>
            <div class="card"><div class="card-title">ğŸ“† å­¸æœŸæœŸé–“</div><div class="form-row"><div class="form-group"><label class="form-label">é–‹å­¸æ—¥æœŸ</label><input type="date" class="form-input" id="semester-start" onchange="calcWeeks()"></div><div class="form-group"><label class="form-label">çµæ¥­æ—¥æœŸ</label><input type="date" class="form-input" id="semester-end" onchange="calcWeeks()"></div></div>
                <div class="alert alert-info" style="margin-top:10px">
                    â„¹ï¸ è‡ªå‹•è¨ˆç®—ï¼š<strong id="semester-weeks">0</strong> é€± Â· ç›®å‰ç¬¬ <strong id="current-week">0</strong> é€±
                    <div id="week-selector-container" style="margin-top:12px;display:none">
                        <button type="button" class="btn btn-outline" style="width:100%" onclick="openWeekPicker()">
                            ğŸ“… é–‹å•Ÿå­¸æœŸæ—¥æ›†ï¼ˆé¸æ“‡å¹´/æœˆ/å‘¨æ¬¡ï¼‰
                        </button>
                    </div>
                </div>
            </div>
            <div class="card"><div class="card-title">ğŸ”” è‡ªå‹•æé†’è¨­å®š</div>
                <div class="form-group" style="display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid var(--border)">
                    <div><strong>è‡ªå‹•ä¸Šèª²æé†’</strong><br><small style="color:var(--text-light)">ä¸Šèª²å‰è‡ªå‹•ç™¼é€ LINE é€šçŸ¥</small></div>
                    <label class="switch"><input type="checkbox" id="auto-remind" checked><span class="slider"></span></label>
                </div>
                <div class="form-group" style="margin-top:15px">
                    <label class="form-label">æå‰æé†’æ™‚é–“</label>
                    <select class="form-select" id="remind-minutes">
                        <option value="10">10 åˆ†é˜å‰</option>
                        <option value="15">15 åˆ†é˜å‰</option>
                        <option value="20">20 åˆ†é˜å‰</option>
                        <option value="30" selected>30 åˆ†é˜å‰</option>
                        <option value="60">1 å°æ™‚å‰</option>
                    </select>
                </div>
                <div class="alert alert-success" style="margin-top:15px">âœ… ç³»çµ±æœƒæ ¹æ“šèª²è¡¨è‡ªå‹•ç™¼é€ä¸Šèª²æé†’èˆ‡ç°½åˆ°é€£çµçµ¦å­¸ç”Ÿ</div>
            </div>
            <div class="card"><div class="card-title">âŒ ç¼ºå¸­é€šçŸ¥è¨­å®š</div>
                <div class="form-group">
                    <label class="form-label">ç¼ºå¸­é€šçŸ¥ç™¼é€æ¬¡æ•¸</label>
                    <select class="form-select" id="absent-notify-times">
                        <option value="0">ä¸ç™¼é€ç¼ºå¸­é€šçŸ¥</option>
                        <option value="1" selected>ç™¼é€ 1 æ¬¡</option>
                        <option value="2">ç™¼é€ 2 æ¬¡</option>
                        <option value="3">ç™¼é€ 3 æ¬¡</option>
                    </select>
                    <small style="color:var(--text-light);display:block;margin-top:5px">èª²ç¨‹çµæŸå¾Œï¼Œç³»çµ±æœƒè‡ªå‹•æ¨™è¨˜æœªç°½åˆ°çš„å­¸ç”Ÿç‚ºç¼ºå¸­ä¸¦ç™¼é€é€šçŸ¥</small>
                </div>
            </div>
            <div class="card"><div class="card-title">ğŸ“š å­¸æœŸçµæŸé€šçŸ¥</div>
                <div class="form-group">
                    <label class="form-label">ç™¼é€æ™‚æ©Ÿ</label>
                    <select class="form-select" id="semester-end-mode" onchange="toggleSemesterEndWeek()">
                        <option value="end_day">çµæ¥­æ—¥ç•¶å¤©</option>
                        <option value="next_day">çµæ¥­æ—¥éš”å¤©</option>
                        <option value="last_week">æœ€å¾Œä¸€å‘¨ï¼ˆé€±ä¸€ï¼‰</option>
                        <option value="specific_week">æŒ‡å®šå‘¨æ¬¡</option>
                    </select>
                </div>
                <div class="form-group" id="semester-end-week-group" style="display:none;margin-top:10px">
                    <label class="form-label">æŒ‡å®šç™¼é€å‘¨æ¬¡</label>
                    <select class="form-select" id="semester-end-week">
                        <option value="">è«‹å…ˆè¨­å®šå­¸æœŸæœŸé–“</option>
                    </select>
                </div>
                <div class="alert alert-info" style="margin-top:10px">ğŸ’¡ å­¸æœŸçµæŸæ™‚æœƒè‡ªå‹•ç™¼é€è§£é™¤ LINE BOT ç¶å®šçš„èªªæ˜çµ¦æ‰€æœ‰å­¸ç”Ÿ</div>
            </div>
            <div class="card"><div class="card-title">â° ç¯€æ¬¡æ™‚é–“è¡¨</div><div id="period-settings"></div></div>
            <button class="btn btn-primary btn-block" onclick="saveSemester()">ğŸ’¾ å„²å­˜å­¸æœŸè¨­å®š</button>
            <button class="btn btn-danger btn-block" style="margin-top:10px" onclick="resetAllSettings()">ğŸ—‘ï¸ é‡è¨­æ‰€æœ‰è¨­å®š</button>
        </div>
        <!-- Schedule -->
        <div class="page" id="page-schedule">
            <div class="header"><h1 class="page-title">èª²è¡¨ç®¡ç†</h1><p class="page-subtitle">ç®¡ç†èª²ç¨‹è³‡æ–™</p></div>
            
            <!-- å‘¨æ¬¡é¸æ“‡å™¨ -->
            <div class="card" id="schedule-week-selector" style="display:none">
                <div class="card-title">ğŸ“… å‘¨æ¬¡é¸æ“‡</div>
                <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
                    <select class="form-select" id="schedule-year" style="width:auto" onchange="onScheduleYearChange()"></select>
                    <select class="form-select" id="schedule-month" style="width:auto" onchange="onScheduleMonthChange()"></select>
                    <select class="form-select" id="schedule-week" style="width:auto;flex:1;min-width:180px" onchange="onScheduleWeekChange()"></select>
                </div>
                <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
                    <button class="btn btn-sm btn-outline" onclick="goToPrevWeek()">â—€ ä¸Šä¸€å‘¨</button>
                    <button class="btn btn-sm btn-primary" onclick="goToCurrentWeek()">ğŸ“ æœ¬å‘¨</button>
                    <button class="btn btn-sm btn-outline" onclick="goToNextWeek()">ä¸‹ä¸€å‘¨ â–¶</button>
                </div>
                <div id="schedule-week-info" class="alert alert-info" style="margin-top:10px;display:none"></div>
            </div>
            
            <div class="card">
                <div class="tabs">
                    <div class="tab active" onclick="showView('grid')">é€±èª²è¡¨</div>
                    <div class="tab" onclick="showView('list')">èª²ç¨‹åˆ—è¡¨</div>
                    <div class="tab" onclick="showView('substitute')">ğŸ”„ èª¿ä»£èª²</div>
                </div>
                <div id="grid-view"><div class="schedule-grid" id="schedule-grid"></div></div>
                <div id="list-view" style="display:none">
                    <button class="btn btn-primary btn-block" style="margin-bottom:15px" onclick="openModal('addCourse')">â• æ–°å¢èª²ç¨‹</button>
                    <div id="courses-list"></div>
                </div>
                <div id="substitute-view" style="display:none">
                    <div class="alert alert-info" style="margin-bottom:15px">
                        ğŸ’¡ èª¿ä»£èª²åŠŸèƒ½å¯è™•ç†è‡¨æ™‚èª²ç¨‹ç•°å‹•ï¼ŒåŒ…æ‹¬èª¿èª²ã€ä»£èª²ã€åœèª²ç­‰æƒ…æ³
                    </div>
                    <button class="btn btn-primary btn-block" style="margin-bottom:15px" onclick="openSubstituteModal()">â• æ–°å¢èª¿ä»£èª²</button>
                    <div id="substitute-list"></div>
                </div>
            </div>
        </div>
        <!-- Sessions -->
        <div class="page" id="page-sessions">
            <div class="header"><h1 class="page-title">ä»Šæ—¥ç°½åˆ°</h1><p class="page-subtitle" id="session-date"></p></div>
            <div id="sessions-list"></div>
        </div>
        <!-- Classes -->
        <div class="page" id="page-classes">
            <div class="header"><h1 class="page-title">ç­ç´šç®¡ç†</h1></div>
            <button class="btn btn-primary btn-block" style="margin-bottom:15px" onclick="openModal('addClass')">â• æ–°å¢ç­ç´š</button>
            <div id="classes-list"></div>
        </div>
        <!-- Students -->
        <div class="page" id="page-students">
            <div class="header"><h1 class="page-title">å­¸ç”Ÿåå–®</h1></div>
            <button class="btn btn-primary btn-block" style="margin-bottom:15px" onclick="openModal('addStudent')">â• æ–°å¢å­¸ç”Ÿ</button>
            <div class="card"><div class="form-group" style="margin:0"><select class="form-select" id="student-filter" onchange="loadStudents()"><option value="">å…¨éƒ¨ç­ç´š</option></select></div></div>
            <div id="students-list"></div>
        </div>
        <!-- Leaves -->
        <div class="page" id="page-leaves">
            <div class="header"><h1 class="page-title">è«‹å‡ç®¡ç†</h1></div>
            <div class="tabs"><div class="tab active" onclick="filterLeaves('pending')">å¾…å¯©æ ¸</div><div class="tab" onclick="filterLeaves('approved')">å·²æ ¸å‡†</div><div class="tab" onclick="filterLeaves('rejected')">å·²é§å›</div><div class="tab" onclick="filterLeaves('all')">å…¨éƒ¨</div></div>
            <div id="leaves-list"></div>
        </div>
        <!-- Records -->
        <div class="page" id="page-records">
            <div class="header"><h1 class="page-title">å‡ºç¼ºç´€éŒ„</h1></div>
            <button class="btn btn-primary btn-block" style="margin-bottom:15px" onclick="openModal('addRecord')">â• æ‰‹å‹•æ–°å¢</button>
            <div class="card"><div class="table-wrap"><table><thead><tr><th>æ—¥æœŸ</th><th>å­¸è™Ÿ</th><th>å§“å</th><th>ç‹€æ…‹</th></tr></thead><tbody id="records-table"></tbody></table></div></div>
        </div>
        <!-- Stats -->
        <div class="page" id="page-stats">
            <div class="header"><h1 class="page-title">å‡ºå¸­çµ±è¨ˆ</h1></div>
            <div class="card">
                <div class="big-stat">
                    <svg class="progress-ring" viewBox="0 0 120 120"><circle class="bg" cx="60" cy="60" r="52"/><circle class="fg" id="progress-circle" cx="60" cy="60" r="52" stroke-dasharray="327" stroke-dashoffset="327"/></svg>
                    <div class="value" id="overall-rate">--%</div>
                    <div class="label">æ•´é«”å‡ºå¸­ç‡</div>
                </div>
            </div>
            <div class="stats-grid">
                <div class="stat-card success"><div class="stat-value" id="stats-attended">-</div><div class="stat-label">å‡ºå¸­</div></div>
                <div class="stat-card warning"><div class="stat-value" id="stats-late">-</div><div class="stat-label">é²åˆ°</div></div>
                <div class="stat-card danger"><div class="stat-value" id="stats-absent">-</div><div class="stat-label">ç¼ºå¸­</div></div>
                <div class="stat-card primary"><div class="stat-value" id="stats-total">-</div><div class="stat-label">ç¸½è¨ˆ</div></div>
            </div>
            <div class="card"><div class="card-title">ğŸ“‰ ä½å‡ºå¸­ç‡å­¸ç”Ÿ</div><div id="low-attendance-list"></div></div>
        </div>
        <!-- Alerts -->
        <div class="page" id="page-alerts">
            <div class="header"><h1 class="page-title">ç¼ºå¸­è­¦ç¤º</h1></div>
            <div class="alert alert-warning">âš ï¸ ä»¥ä¸‹å­¸ç”Ÿæœ‰é€£çºŒç¼ºå¸­æƒ…å½¢</div>
            <div id="alert-list"></div>
            <button class="btn btn-primary btn-block" onclick="sendAllWarnings()">ğŸ“² ç™¼é€å…¨éƒ¨è­¦å‘Š</button>
        </div>
        <!-- Notifications -->
        <div class="page" id="page-notifications">
            <div class="header"><h1 class="page-title">é€šçŸ¥è¨­å®š</h1></div>
            <div class="card">
                <div class="card-title">ğŸ“± è‡ªå‹•é€šçŸ¥</div>
                <div class="setting-item"><div><div class="label">ç¼ºå¸­é€šçŸ¥å­¸ç”Ÿ</div><div class="desc">ç¼ºå¸­æ™‚ç™¼é€ LINE é€šçŸ¥</div></div><label class="switch"><input type="checkbox" id="notify-absent" checked><span class="slider"></span></label></div>
                <div class="setting-item"><div><div class="label">ç¼ºå¸­é€šçŸ¥å®¶é•·</div><div class="desc">åŒæ™‚é€šçŸ¥å®¶é•·</div></div><label class="switch"><input type="checkbox" id="notify-parent"><span class="slider"></span></label></div>
                <div class="setting-item"><div><div class="label">é€£çºŒç¼ºå¸­è­¦å‘Š</div><div class="desc">é€£çºŒ 3 æ¬¡ç¼ºå¸­ç™¼è­¦å‘Š</div></div><label class="switch"><input type="checkbox" id="notify-warning" checked><span class="slider"></span></label></div>
            </div>
            <button class="btn btn-primary btn-block" onclick="toast('è¨­å®šå·²å„²å­˜ï¼')">ğŸ’¾ å„²å­˜è¨­å®š</button>
        </div>
        <!-- LINE Bot -->
        <div class="page" id="page-linebot">
            <div class="header"><h1 class="page-title">LINE Bot è¨­å®š</h1><p class="page-subtitle">å¦‚ä½•ç™¼å¸ƒèˆ‡ä½¿ç”¨</p></div>
            <div class="card">
                <div class="card-title">ğŸ“‹ ç™¼å¸ƒæ­¥é©Ÿ</div>
                <div class="alert alert-info">
                    <b>Step 1:</b> å‰å¾€ <a href="https://developers.line.biz/" target="_blank" style="color:#1d4ed8">LINE Developers</a> ç™»å…¥
                </div>
                <div class="alert alert-info">
                    <b>Step 2:</b> å»ºç«‹ Provider â†’ å»ºç«‹ Messaging API Channel
                </div>
                <div class="alert alert-info">
                    <b>Step 3:</b> åœ¨ Channel è¨­å®šä¸­ï¼š<br>
                    â€¢ Webhook URL å¡«å…¥ï¼š<br>
                    <code style="background:#e2e8f0;padding:4px 8px;border-radius:4px;font-size:12px;word-break:break-all">${location.origin}/webhook</code>
                </div>
                <div class="alert alert-info">
                    <b>Step 4:</b> é–‹å•Ÿã€ŒUse webhookã€
                </div>
                <div class="alert alert-info">
                    <b>Step 5:</b> è¤‡è£½ Channel Secret å’Œ Channel Access Tokenï¼Œå¡«å…¥ Render ç’°å¢ƒè®Šæ•¸
                </div>
            </div>
            <div class="card">
                <div class="card-title">âš™ï¸ Render ç’°å¢ƒè®Šæ•¸</div>
                <div class="alert alert-warning">
                    åœ¨ Render Dashboard â†’ Environment åŠ å…¥ï¼š<br><br>
                    <code>LINE_CHANNEL_SECRET</code> = ä½ çš„ Secret<br>
                    <code>LINE_CHANNEL_ACCESS_TOKEN</code> = ä½ çš„ Token<br>
                    <code>GOOGLE_SHEETS_ID</code> = ä½ çš„è©¦ç®—è¡¨ ID<br>
                    <code>GOOGLE_SERVICE_ACCOUNT_EMAIL</code> = æœå‹™å¸³æˆ¶ Email<br>
                    <code>GOOGLE_PRIVATE_KEY</code> = æœå‹™å¸³æˆ¶é‡‘é‘°
                </div>
            </div>
            <div class="card">
                <div class="card-title">ğŸ“± å­¸ç”Ÿå¦‚ä½•ä½¿ç”¨</div>
                <div class="alert alert-success">
                    1. æƒæ LINE Bot QR Code åŠ å¥½å‹<br>
                    2. å‚³é€ã€Œè¨»å†Š å­¸è™Ÿ å§“å ç­ç´šã€<br>
                    3. ä¸Šèª²æ™‚æƒæè€å¸«çš„ç°½åˆ° QR Code<br>
                    4. å‚³é€ã€Œç°½åˆ°ã€å®Œæˆ
                </div>
            </div>
            <div class="card">
                <div class="card-title">ğŸ”— Bot ID</div>
                <div class="form-group"><input type="text" class="form-input" id="bot-id" placeholder="@xxx"></div>
                <button class="btn btn-primary btn-block" onclick="saveBotId()">ğŸ’¾ å„²å­˜</button>
            </div>
        </div>
        <!-- Settings -->
        <div class="page" id="page-settings">
            <div class="header"><h1 class="page-title">ç³»çµ±è¨­å®š</h1></div>
            <div class="card"><div class="card-title">ğŸ”— API é€£ç·š</div><div class="form-group"><label class="form-label">å¾Œç«¯ç¶²å€</label><input type="text" class="form-input" id="api-url" placeholder="https://your-app.onrender.com"></div><button class="btn btn-primary btn-block" onclick="testConn()">ğŸ” æ¸¬è©¦é€£ç·š</button></div>
            <div class="card"><div class="card-title">ğŸ§ª æ¸¬è©¦é©—è­‰</div>
                <p style="color:var(--text-light);font-size:13px;margin-bottom:15px">è€å¸«å¯ä»¥åœ¨é€™è£¡æ¸¬è©¦å„é …åŠŸèƒ½ï¼Œä¸éœ€è¦ç­‰åˆ°å¯¦éš›èª²å ‚çµæŸã€‚</p>
                <div class="form-group">
                    <label class="form-label">é¸æ“‡æ¸¬è©¦ç­ç´š</label>
                    <select class="form-select" id="test-class"></select>
                </div>
                <div style="display:flex;flex-direction:column;gap:10px">
                    <button class="btn btn-outline" onclick="testSemesterEndNotify()">ğŸ“š æ¸¬è©¦å­¸æœŸçµæŸé€šçŸ¥</button>
                    <button class="btn btn-outline" onclick="testCheckinNotify()">âœ… æ¸¬è©¦ç°½åˆ°æˆåŠŸé€šçŸ¥</button>
                    <button class="btn btn-outline" onclick="testLateNotify()">âš ï¸ æ¸¬è©¦é²åˆ°é€šçŸ¥</button>
                    <button class="btn btn-outline" onclick="testAbsentNotify()">âŒ æ¸¬è©¦ç¼ºå¸­é€šçŸ¥</button>
                    <button class="btn btn-outline" onclick="testReminderNotify()">ğŸ“¢ æ¸¬è©¦ä¸Šèª²æé†’</button>
                </div>
                <div class="alert alert-warning" style="margin-top:15px;font-size:12px">âš ï¸ æ¸¬è©¦é€šçŸ¥æœƒç™¼é€çµ¦è©²ç­ç´šæ‰€æœ‰å·²ç¶å®š LINE çš„å­¸ç”Ÿ</div>
            </div>
            <div class="card"><div class="card-title">ğŸ” èª²ç¨‹è¨­å®šé™¤éŒ¯</div>
                <p style="color:var(--text-light);font-size:13px;margin-bottom:15px">æª¢æŸ¥èª²ç¨‹çš„ç°½åˆ°ç¯„åœæ˜¯å¦æ­£ç¢ºå„²å­˜</p>
                <div class="form-group">
                    <label class="form-label">é¸æ“‡èª²ç¨‹</label>
                    <select class="form-select" id="debug-course"></select>
                </div>
                <button class="btn btn-outline btn-block" onclick="debugCourse()">ğŸ” æª¢æŸ¥èª²ç¨‹è¨­å®š</button>
                <div id="debug-result" style="margin-top:10px;padding:10px;background:#f5f5f5;border-radius:8px;font-size:12px;font-family:monospace;display:none"></div>
            </div>
            <div class="card"><div class="card-title">ğŸ”§ LINE Bot è¨­å®š</div>
                <div class="form-group"><label class="form-label">LINE Bot ID</label><input type="text" class="form-input" id="bot-id" placeholder="@your_bot_id"></div>
                <button class="btn btn-primary btn-block" onclick="saveBotId()">ğŸ’¾ å„²å­˜ Bot ID</button>
            </div>
        </div>
    </main>
    <div class="toast-container" id="toasts"></div>

    <!-- Modals -->
    <div class="modal-overlay" id="modal-addClass"><div class="modal"><div class="modal-header"><h3 class="modal-title">æ–°å¢ç­ç´š</h3><button class="modal-close" onclick="closeModal('addClass')">&times;</button></div><div class="modal-body"><div class="form-group"><label class="form-label">ç­ç´šä»£ç¢¼ *</label><input type="text" class="form-input" id="class-code" placeholder="801"></div><div class="form-group"><label class="form-label">ç­ç´šåç¨± *</label><input type="text" class="form-input" id="class-name" placeholder="å…«å¹´ä¸€ç­"></div><div class="form-group"><label class="form-label">éƒ¨åˆ¥</label><select class="form-select" id="class-division"><option value="day">æ—¥é–“éƒ¨</option><option value="night">å¤œé–“éƒ¨</option><option value="weekend">é€²ä¿®éƒ¨</option></select></div><div class="form-group"><label class="form-label">å°å¸«</label><input type="text" class="form-input" id="class-teacher"></div></div><div class="modal-footer"><button class="btn btn-outline" onclick="closeModal('addClass')">å–æ¶ˆ</button><button class="btn btn-primary" onclick="addClass()">æ–°å¢</button></div></div></div>
    
    <div class="modal-overlay" id="modal-editClass"><div class="modal"><div class="modal-header"><h3 class="modal-title">ç·¨è¼¯ç­ç´š</h3><button class="modal-close" onclick="closeModal('editClass')">&times;</button></div><div class="modal-body"><div class="form-group"><label class="form-label">ç­ç´šä»£ç¢¼</label><input type="text" class="form-input" id="edit-class-code" readonly></div><div class="form-group"><label class="form-label">ç­ç´šåç¨±</label><input type="text" class="form-input" id="edit-class-name"></div><div class="form-group"><label class="form-label">éƒ¨åˆ¥</label><select class="form-select" id="edit-class-division"><option value="day">æ—¥é–“éƒ¨</option><option value="night">å¤œé–“éƒ¨</option><option value="weekend">é€²ä¿®éƒ¨</option></select></div><div class="form-group"><label class="form-label">å°å¸«</label><input type="text" class="form-input" id="edit-class-teacher"></div></div><div class="modal-footer"><button class="btn btn-danger" onclick="deleteClass()">ğŸ—‘ï¸ åˆªé™¤</button><button class="btn btn-primary" onclick="saveClass()">ğŸ’¾ å„²å­˜</button></div></div></div>

    <div class="modal-overlay" id="modal-addCourse"><div class="modal"><div class="modal-header"><h3 class="modal-title">æ–°å¢èª²ç¨‹</h3><button class="modal-close" onclick="closeModal('addCourse')">&times;</button></div><div class="modal-body"><div class="form-group"><label class="form-label">èª²ç¨‹åç¨± *</label><input type="text" class="form-input" id="course-name" placeholder="ç‰©ç†"></div><div class="form-group"><label class="form-label">ç­ç´š *</label><select class="form-select" id="course-class"></select></div><div class="form-row"><div class="form-group"><label class="form-label">æ˜ŸæœŸ *</label><select class="form-select" id="course-day"><option value="1">é€±ä¸€</option><option value="2">é€±äºŒ</option><option value="3">é€±ä¸‰</option><option value="4">é€±å››</option><option value="5">é€±äº”</option><option value="6">é€±å…­</option><option value="0">é€±æ—¥</option></select></div><div class="form-group"><label class="form-label">ç¯€æ¬¡ *</label><select class="form-select" id="course-period"></select></div></div><div class="form-group"><label class="form-label">æ•™å®¤</label><input type="text" class="form-input" id="course-room" placeholder="è‡´é æ¨“ 301"></div><div class="form-group"><label class="form-label">ç°½åˆ°æ–¹å¼</label><select class="form-select" id="course-radius"><option value="-1">ğŸ“± ç¾å ´ç°½åˆ°ï¼ˆæƒQR Codeï¼‰</option><option value="10">ğŸ“ GPS 10 å…¬å°ºï¼ˆç²¾æº–ï¼‰</option><option value="50">ğŸ“ GPS 50 å…¬å°ºï¼ˆæ•™å®¤ï¼‰</option><option value="100" selected>ğŸ“ GPS 100 å…¬å°ºï¼ˆæ¨“å±¤ï¼‰</option><option value="150">ğŸ“ GPS 150 å…¬å°ºï¼ˆå»ºç¯‰ï¼‰</option><option value="200">ğŸ“ GPS 200 å…¬å°ºï¼ˆæ ¡åœ’ï¼‰</option><option value="0">ğŸŒ ä¸é™åˆ¶ï¼ˆç·šä¸Šèª²ç¨‹ï¼‰</option></select></div><div class="alert alert-info" style="font-size:12px;margin-bottom:10px">ğŸ’¡ <b>GPS åº§æ¨™å–å¾—æ–¹å¼ï¼š</b><br>1. é»ã€ŒğŸ“¡ é«˜ç²¾åº¦å®šä½ã€æœƒé€£çºŒå–æ¨£æ‰¾å‡ºæœ€æº–ä½ç½®<br>2. æˆ–å¾ <a href="https://www.google.com/maps" target="_blank">Google Maps</a> å³éµé»æ“Šä½ç½®è¤‡è£½åº§æ¨™<br>3. å®šä½æ™‚è«‹ç«™åœ¨çª—é‚Šæˆ–æˆ¶å¤–ä»¥ç²å¾—æœ€ä½³ç²¾åº¦</div><div class="form-row"><div class="form-group"><label class="form-label">GPS ç·¯åº¦</label><input type="number" step="any" class="form-input" id="course-lat" placeholder="22.6267"></div><div class="form-group"><label class="form-label">GPS ç¶“åº¦</label><input type="number" step="any" class="form-input" id="course-lon" placeholder="120.3565"></div></div><div style="display:flex;gap:8px"><button type="button" class="btn btn-outline" style="flex:1" onclick="getLocation()">ğŸ“¡ é«˜ç²¾åº¦å®šä½</button><button type="button" class="btn btn-outline" style="flex:1" onclick="parseGoogleMapsUrl()">ğŸ—ºï¸ è²¼ä¸Š Google Maps é€£çµ</button></div></div><div class="modal-footer"><button class="btn btn-outline" onclick="closeModal('addCourse')">å–æ¶ˆ</button><button class="btn btn-primary" onclick="addCourse()">æ–°å¢</button></div></div></div>

    <div class="modal-overlay" id="modal-editCourse"><div class="modal"><div class="modal-header"><h3 class="modal-title">ç·¨è¼¯èª²ç¨‹</h3><button class="modal-close" onclick="closeModal('editCourse')">&times;</button></div><div class="modal-body"><div class="form-group"><label class="form-label">èª²ç¨‹åç¨±</label><input type="text" class="form-input" id="edit-course-name"></div><div class="form-group"><label class="form-label">ç­ç´š</label><select class="form-select" id="edit-course-class"></select></div><div class="form-row"><div class="form-group"><label class="form-label">æ˜ŸæœŸ</label><select class="form-select" id="edit-course-day"><option value="1">é€±ä¸€</option><option value="2">é€±äºŒ</option><option value="3">é€±ä¸‰</option><option value="4">é€±å››</option><option value="5">é€±äº”</option><option value="6">é€±å…­</option><option value="0">é€±æ—¥</option></select></div><div class="form-group"><label class="form-label">ç¯€æ¬¡</label><select class="form-select" id="edit-course-period"></select></div></div><div class="form-group"><label class="form-label">æ•™å®¤</label><input type="text" class="form-input" id="edit-course-room"></div><div class="form-group"><label class="form-label">ç°½åˆ°æ–¹å¼</label><select class="form-select" id="edit-course-radius"><option value="-1">ğŸ“± ç¾å ´ç°½åˆ°ï¼ˆæƒQR Codeï¼‰</option><option value="10">ğŸ“ GPS 10 å…¬å°ºï¼ˆç²¾æº–ï¼‰</option><option value="50">ğŸ“ GPS 50 å…¬å°ºï¼ˆæ•™å®¤ï¼‰</option><option value="100">ğŸ“ GPS 100 å…¬å°ºï¼ˆæ¨“å±¤ï¼‰</option><option value="150">ğŸ“ GPS 150 å…¬å°ºï¼ˆå»ºç¯‰ï¼‰</option><option value="200">ğŸ“ GPS 200 å…¬å°ºï¼ˆæ ¡åœ’ï¼‰</option><option value="0">ğŸŒ ä¸é™åˆ¶ï¼ˆç·šä¸Šèª²ç¨‹ï¼‰</option></select></div><div class="alert alert-info" style="font-size:12px;margin-bottom:10px">ğŸ’¡ <b>é«˜ç²¾åº¦å®šä½æ¨¡å¼ï¼š</b>æœƒé€£çºŒå–æ¨£ä¸¦é¸å–æœ€ä½³ä½ç½®ã€‚å¦‚éœ€æ‰‹å‹•è¼¸å…¥ï¼Œå¯å¾ <a href="https://www.google.com/maps" target="_blank">Google Maps</a> è¤‡è£½åº§æ¨™</div><div class="form-row"><div class="form-group"><label class="form-label">GPS ç·¯åº¦</label><input type="number" step="any" class="form-input" id="edit-course-lat" placeholder="22.6267"></div><div class="form-group"><label class="form-label">GPS ç¶“åº¦</label><input type="number" step="any" class="form-input" id="edit-course-lon" placeholder="120.3565"></div></div><div style="display:flex;gap:8px"><button type="button" class="btn btn-outline" style="flex:1" onclick="getLocationForEdit()">ğŸ“¡ é«˜ç²¾åº¦å®šä½</button><button type="button" class="btn btn-outline" style="flex:1" onclick="parseGoogleMapsUrlForEdit()">ğŸ—ºï¸ è²¼ä¸Š Google Maps é€£çµ</button></div></div><div class="modal-footer"><button class="btn btn-danger" onclick="deleteCourse()">ğŸ—‘ï¸ åˆªé™¤</button><button class="btn btn-primary" onclick="saveCourse()">ğŸ’¾ å„²å­˜</button></div></div></div>

    <div class="modal-overlay" id="modal-addStudent"><div class="modal"><div class="modal-header"><h3 class="modal-title">æ–°å¢å­¸ç”Ÿ</h3><button class="modal-close" onclick="closeModal('addStudent')">&times;</button></div><div class="modal-body"><div class="alert alert-info">ğŸ’¡ å­¸ç”Ÿä¹Ÿå¯ä»¥é€é LINE Bot è‡ªè¡Œè¨»å†Š</div><div class="form-group"><label class="form-label">å­¸è™Ÿ *</label><input type="text" class="form-input" id="student-id" placeholder="110001"></div><div class="form-group"><label class="form-label">å§“å *</label><input type="text" class="form-input" id="student-name" placeholder="ç‹å°æ˜"></div><div class="form-group"><label class="form-label">ç­ç´š *</label><select class="form-select" id="student-class"></select></div><div class="form-group"><label class="form-label">é›»è©±</label><input type="tel" class="form-input" id="student-phone" placeholder="0912345678"></div><div class="form-group"><label class="form-label">å®¶é•·é›»è©±</label><input type="tel" class="form-input" id="student-parent-phone"></div></div><div class="modal-footer"><button class="btn btn-outline" onclick="closeModal('addStudent')">å–æ¶ˆ</button><button class="btn btn-primary" onclick="addStudent()">æ–°å¢</button></div></div></div>

    <div class="modal-overlay" id="modal-editStudent"><div class="modal"><div class="modal-header"><h3 class="modal-title">ç·¨è¼¯å­¸ç”Ÿ</h3><button class="modal-close" onclick="closeModal('editStudent')">&times;</button></div><div class="modal-body"><div class="form-group"><label class="form-label">å­¸è™Ÿ</label><input type="text" class="form-input" id="edit-student-id" readonly></div><div class="form-group"><label class="form-label">å§“å</label><input type="text" class="form-input" id="edit-student-name"></div><div class="form-group"><label class="form-label">ç­ç´š</label><select class="form-select" id="edit-student-class"></select></div><div class="form-group"><label class="form-label">é›»è©±</label><input type="tel" class="form-input" id="edit-student-phone"></div><div class="form-group"><label class="form-label">å®¶é•·é›»è©±</label><input type="tel" class="form-input" id="edit-student-parent-phone"></div></div><div class="modal-footer"><button class="btn btn-danger" onclick="deleteStudent()">ğŸ—‘ï¸ åˆªé™¤</button><button class="btn btn-primary" onclick="saveStudent()">ğŸ’¾ å„²å­˜</button></div></div></div>

    <div class="modal-overlay" id="modal-addRecord"><div class="modal"><div class="modal-header"><h3 class="modal-title">æ‰‹å‹•æ–°å¢ç´€éŒ„</h3><button class="modal-close" onclick="closeModal('addRecord')">&times;</button></div><div class="modal-body"><div class="form-group"><label class="form-label">å­¸è™Ÿ *</label><input type="text" class="form-input" id="record-student"></div><div class="form-group"><label class="form-label">æ—¥æœŸ *</label><input type="date" class="form-input" id="record-date"></div><div class="form-group"><label class="form-label">ç‹€æ…‹</label><select class="form-select" id="record-status"><option value="å·²å ±åˆ°">å·²å ±åˆ°</option><option value="é²åˆ°">é²åˆ°</option><option value="ç¼ºå¸­">ç¼ºå¸­</option></select></div><div class="form-group"><label class="form-label">å‚™è¨»</label><input type="text" class="form-input" id="record-note"></div></div><div class="modal-footer"><button class="btn btn-outline" onclick="closeModal('addRecord')">å–æ¶ˆ</button><button class="btn btn-primary" onclick="addRecord()">æ–°å¢</button></div></div></div>

    <div class="modal-overlay" id="modal-reviewLeave"><div class="modal"><div class="modal-header"><h3 class="modal-title">å¯©æ ¸è«‹å‡</h3><button class="modal-close" onclick="closeModal('reviewLeave')">&times;</button></div><div class="modal-body"><div id="leave-detail"></div><div class="form-group"><label class="form-label">å‚™è¨»</label><textarea class="form-textarea" id="review-note"></textarea></div></div><div class="modal-footer"><button class="btn btn-danger" onclick="reviewLeave('å·²é§å›')">âŒ é§å›</button><button class="btn btn-success" onclick="reviewLeave('å·²æ ¸å‡†')">âœ… æ ¸å‡†</button></div></div></div>

    <div class="modal-overlay" id="modal-qr"><div class="modal"><div class="modal-header"><h3 class="modal-title">ğŸ“± ç°½åˆ° QR Code</h3><button class="modal-close" onclick="closeModal('qr')">&times;</button></div><div class="modal-body"><div class="qr-container"><div class="qr-code" id="qr-container"></div><div class="qr-info"><strong id="qr-name"></strong><span id="qr-time"></span></div><div class="alert alert-success" style="margin-top:10px;font-size:12px">ğŸ‘† å­¸ç”Ÿæƒæ­¤ QR Code â†’ ç›´æ¥ç°½åˆ°æˆåŠŸ</div><div id="qr-link-box" style="margin-top:15px;padding:10px;background:#fff3cd;border-radius:10px"><p style="font-size:12px;color:#856404;margin-bottom:8px">ğŸ“¤ å­¸ç”Ÿè‡ªå·±æ‰‹æ©Ÿç°½åˆ°é€£çµï¼ˆéœ€ GPS é©—è­‰ï¼‰ï¼š</p><input type="text" id="qr-link" readonly style="width:100%;padding:8px;border:1px solid #ddd;border-radius:6px;font-size:11px" onclick="this.select()"><button class="btn btn-outline btn-sm" style="margin-top:8px;width:100%" onclick="copyQRLink()">ğŸ“‹ è¤‡è£½é€£çµåˆ†äº«çµ¦å­¸ç”Ÿ</button></div></div></div><div class="modal-footer"><button class="btn btn-outline" onclick="closeModal('qr')">é—œé–‰</button><button class="btn btn-success" onclick="sendReminderFromQR()">ğŸ“¢ ç™¼é€é€šçŸ¥</button><button class="btn btn-primary" onclick="downloadQR()">ğŸ“¥ ä¸‹è¼‰</button></div></div></div>

    <!-- å­¸æœŸæ—¥æ›†é¸æ“‡å™¨ Modal -->
    <div class="modal-overlay" id="modal-weekPicker">
        <div class="modal" style="max-width:500px">
            <div class="modal-header">
                <h3 class="modal-title">ğŸ“… å­¸æœŸæ—¥æ›†</h3>
                <button class="modal-close" onclick="closeModal('weekPicker')">&times;</button>
            </div>
            <div class="modal-body">
                <!-- å¹´æœˆé¸æ“‡ -->
                <div style="display:flex;gap:10px;margin-bottom:15px">
                    <select class="form-select" id="picker-year" onchange="updateWeekPickerCalendar()" style="flex:1"></select>
                    <select class="form-select" id="picker-month" onchange="updateWeekPickerCalendar()" style="flex:1"></select>
                </div>
                
                <!-- å¿«é€Ÿè·³è½‰ -->
                <div style="display:flex;gap:8px;margin-bottom:15px;flex-wrap:wrap">
                    <button class="btn btn-sm btn-outline" onclick="jumpToCurrentWeek()">ğŸ“ æœ¬å‘¨</button>
                    <button class="btn btn-sm btn-outline" onclick="jumpToFirstWeek()">â®ï¸ ç¬¬ä¸€å‘¨</button>
                    <button class="btn btn-sm btn-outline" onclick="jumpToLastWeek()">â­ï¸ æœ€å¾Œä¸€å‘¨</button>
                    <button class="btn btn-sm btn-success" onclick="applyWeekToSchedule()">ğŸ“‹ å¥—ç”¨åˆ°èª²è¡¨</button>
                </div>
                
                <!-- å‘¨æ¬¡åˆ—è¡¨ -->
                <div style="max-height:350px;overflow-y:auto">
                    <div id="week-picker-list"></div>
                </div>
                
                <!-- é¸ä¸­çš„å‘¨æ¬¡è³‡è¨Š -->
                <div id="selected-week-info" class="alert alert-success" style="margin-top:15px;display:none"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('weekPicker')">é—œé–‰</button>
            </div>
        </div>
    </div>

    <!-- èª¿ä»£èª² Modal -->
    <div class="modal-overlay" id="modal-addSubstitute">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">ğŸ”„ æ–°å¢èª¿ä»£èª²</h3>
                <button class="modal-close" onclick="closeModal('addSubstitute')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">ç•°å‹•é¡å‹ *</label>
                    <select class="form-select" id="sub-type" onchange="onSubTypeChange()">
                        <option value="substitute">ä»£èª²ï¼ˆä»–äººä»£ä¸Šï¼‰</option>
                        <option value="swap">èª¿èª²ï¼ˆæ›´æ›æ™‚é–“ï¼‰</option>
                        <option value="cancel">åœèª²</option>
                        <option value="makeup">è£œèª²</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">åŸèª²ç¨‹ *</label>
                    <select class="form-select" id="sub-original-course"></select>
                </div>
                <div class="form-group">
                    <label class="form-label">ç•°å‹•æ—¥æœŸ *</label>
                    <input type="date" class="form-input" id="sub-date">
                </div>
                <div id="sub-substitute-fields">
                    <div class="form-group">
                        <label class="form-label">ä»£èª²æ•™å¸«</label>
                        <input type="text" class="form-input" id="sub-teacher" placeholder="ä»£èª²æ•™å¸«å§“å">
                    </div>
                </div>
                <div id="sub-swap-fields" style="display:none">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">èª¿è‡³æ—¥æœŸ</label>
                            <input type="date" class="form-input" id="sub-new-date">
                        </div>
                        <div class="form-group">
                            <label class="form-label">èª¿è‡³ç¯€æ¬¡</label>
                            <select class="form-select" id="sub-new-period"></select>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">å‚™è¨»</label>
                    <textarea class="form-textarea" id="sub-note" placeholder="å¡«å¯«ç•°å‹•åŸå› æˆ–èªªæ˜"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('addSubstitute')">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="addSubstitute()">ç¢ºèªæ–°å¢</button>
            </div>
        </div>
    </div>

    <!-- ç·¨è¼¯èª¿ä»£èª² Modal -->
    <div class="modal-overlay" id="modal-editSubstitute">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">ğŸ”„ ç·¨è¼¯èª¿ä»£èª²</h3>
                <button class="modal-close" onclick="closeModal('editSubstitute')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">ç•°å‹•é¡å‹</label>
                    <select class="form-select" id="edit-sub-type" onchange="onEditSubTypeChange()">
                        <option value="substitute">ä»£èª²ï¼ˆä»–äººä»£ä¸Šï¼‰</option>
                        <option value="swap">èª¿èª²ï¼ˆæ›´æ›æ™‚é–“ï¼‰</option>
                        <option value="cancel">åœèª²</option>
                        <option value="makeup">è£œèª²</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">åŸèª²ç¨‹</label>
                    <select class="form-select" id="edit-sub-original-course"></select>
                </div>
                <div class="form-group">
                    <label class="form-label">ç•°å‹•æ—¥æœŸ</label>
                    <input type="date" class="form-input" id="edit-sub-date">
                </div>
                <div id="edit-sub-substitute-fields">
                    <div class="form-group">
                        <label class="form-label">ä»£èª²æ•™å¸«</label>
                        <input type="text" class="form-input" id="edit-sub-teacher">
                    </div>
                </div>
                <div id="edit-sub-swap-fields" style="display:none">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">èª¿è‡³æ—¥æœŸ</label>
                            <input type="date" class="form-input" id="edit-sub-new-date">
                        </div>
                        <div class="form-group">
                            <label class="form-label">èª¿è‡³ç¯€æ¬¡</label>
                            <select class="form-select" id="edit-sub-new-period"></select>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">å‚™è¨»</label>
                    <textarea class="form-textarea" id="edit-sub-note"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="deleteSubstitute()">ğŸ—‘ï¸ åˆªé™¤</button>
                <button class="btn btn-primary" onclick="saveSubstitute()">ğŸ’¾ å„²å­˜</button>
            </div>
        </div>
    </div>

    <script>
        // === å…¨åŸŸè®Šæ•¸ ===
        let API = localStorage.getItem('apiUrl') || '';
        let BOT = localStorage.getItem('botId') || '@bot';
        let sem = JSON.parse(localStorage.getItem('semester') || 'null') || { div: 'day', start: '', end: '', periods: [] };
        let classes = [], courses = [], students = [], leaves = [], substitutes = [];
        let currentClass = null, currentCourse = null, currentStudent = null, currentLeave = null, currentSubstitute = null;
        let leaveFilter = 'pending';
        let selectedScheduleWeek = 0; // èª²è¡¨é¸æ“‡çš„å‘¨æ¬¡
        
        const PERIODS = {
            day: [{n:1,s:'08:00',e:'08:50'},{n:2,s:'09:00',e:'09:50'},{n:3,s:'10:00',e:'10:50'},{n:4,s:'11:00',e:'11:50'},{n:5,s:'13:00',e:'13:50'},{n:6,s:'14:00',e:'14:50'},{n:7,s:'15:00',e:'15:50'},{n:8,s:'16:00',e:'17:00'}],
            night: [{n:1,s:'18:00',e:'18:50'},{n:2,s:'19:00',e:'19:50'},{n:3,s:'20:00',e:'20:50'},{n:4,s:'21:00',e:'22:00'}],
            weekend: [{n:1,s:'08:00',e:'08:50'},{n:2,s:'09:00',e:'09:50'},{n:3,s:'10:00',e:'10:50'},{n:4,s:'11:00',e:'11:50'},{n:5,s:'13:00',e:'13:50'},{n:6,s:'14:00',e:'14:50'},{n:7,s:'15:00',e:'15:50'},{n:8,s:'16:00',e:'17:00'}]
        };
        const DAY_NAMES = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
        const DIV_NAMES = { day: 'æ—¥é–“éƒ¨', night: 'å¤œé–“éƒ¨', weekend: 'é€²ä¿®éƒ¨' };

        // === API ===
        async function api(path, opts = {}) {
            if (!API) {
                console.log('API æœªè¨­å®š');
                return null;
            }
            try {
                console.log('API è«‹æ±‚:', API + path, opts.method || 'GET');
                const res = await fetch(API + path, { ...opts, headers: { 'Content-Type': 'application/json' } });
                const data = await res.json();
                console.log('API å›æ‡‰:', res.status, data);
                
                if (!res.ok) {
                    console.error('API éŒ¯èª¤:', res.status, data);
                    return data;
                }
                document.getElementById('status-dot').classList.add('connected');
                return data;
            } catch (e) {
                console.error('API ä¾‹å¤–:', e);
                document.getElementById('status-dot').classList.remove('connected');
                return null;
            }
        }

        // === UI ===
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
            document.getElementById('overlay').classList.toggle('open');
            document.getElementById('hamburger').classList.toggle('active');
        }
        function showPage(page) {
            document.querySelectorAll('.nav-link').forEach(l => l.classList.toggle('active', l.dataset.page === page));
            document.querySelectorAll('.page').forEach(p => p.classList.toggle('active', p.id === 'page-' + page));
        }
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', e => {
                e.preventDefault();
                showPage(link.dataset.page);
                if (innerWidth < 768) toggleSidebar();
                loadPage(link.dataset.page);
            });
        });
        function openModal(id) { document.getElementById('modal-' + id).classList.add('active'); }
        function closeModal(id) { document.getElementById('modal-' + id).classList.remove('active'); }
        function toast(msg, type = 'success') {
            const el = document.createElement('div');
            el.className = 'toast ' + type;
            el.textContent = (type === 'success' ? 'âœ… ' : type === 'warning' ? 'â³ ' : 'âŒ ') + msg;
            document.getElementById('toasts').appendChild(el);
            setTimeout(() => el.remove(), 3000);
        }

        // === å­¸æœŸè¨­å®š ===
        function selectDivision(div) {
            console.log('åˆ‡æ›éƒ¨åˆ¥:', div);
            
            // æ›´æ–°è®Šæ•¸
            sem.div = div;
            sem.periods = JSON.parse(JSON.stringify(PERIODS[div]));
            
            // æ›´æ–°æ‰€æœ‰ chip çš„æ¨£å¼
            const chips = document.querySelectorAll('#division-chips .chip');
            chips.forEach(c => {
                // ç§»é™¤æ‰€æœ‰ active å’Œé¡è‰² class
                c.classList.remove('active', 'day', 'night', 'weekend');
            });
            
            // ç‚ºé¸ä¸­çš„ chip åŠ ä¸Šæ¨£å¼
            const selectedChip = document.querySelector('#division-chips .chip[data-div="' + div + '"]');
            if (selectedChip) {
                selectedChip.classList.add('active');
                selectedChip.classList.add(div);
            }
            
            // å„²å­˜åˆ° localStorage
            localStorage.setItem('semester', JSON.stringify(sem));
            console.log('å·²å„²å­˜:', JSON.stringify(sem));
            
            // æ›´æ–°ç¯€æ¬¡é¡¯ç¤º
            renderPeriods();
            
            // é¡¯ç¤ºæç¤º
            toast('å·²åˆ‡æ›è‡³' + (div === 'day' ? 'æ—¥é–“éƒ¨' : div === 'night' ? 'å¤œé–“éƒ¨' : 'é€²ä¿®éƒ¨'));
        }
        
        function resetAllSettings() {
            if (!confirm('ç¢ºå®šè¦é‡è¨­æ‰€æœ‰è¨­å®šå—ï¼Ÿé€™æœƒæ¸…é™¤å­¸æœŸè¨­å®šã€éƒ¨åˆ¥é¸æ“‡ç­‰ã€‚')) return;
            
            // æ¸…é™¤ localStorage
            localStorage.removeItem('semester');
            
            // é‡è¨­è®Šæ•¸
            sem = { div: 'day', start: '', end: '', periods: JSON.parse(JSON.stringify(PERIODS.day)) };
            
            // é‡æ–°åˆå§‹åŒ– UI
            initSemesterUI();
            
            toast('è¨­å®šå·²é‡è¨­ï¼');
        }
        
        function saveSemesterToStorage() {
            localStorage.setItem('semester', JSON.stringify(sem));
        }
        
        function loadSemesterFromStorage() {
            const saved = localStorage.getItem('semester');
            console.log('å¾ localStorage è®€å–:', saved);
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    sem.div = parsed.div || 'day';
                    sem.start = parsed.start || '';
                    sem.end = parsed.end || '';
                    sem.periods = parsed.periods && parsed.periods.length > 0 ? parsed.periods : JSON.parse(JSON.stringify(PERIODS[sem.div]));
                    console.log('è§£ææˆåŠŸ:', sem);
                } catch (e) {
                    console.log('è§£æå¤±æ•—ï¼Œä½¿ç”¨é è¨­');
                    sem = { div: 'day', start: '', end: '', periods: JSON.parse(JSON.stringify(PERIODS.day)) };
                }
            }
        }
        
        function initSemesterUI() {
            console.log('åˆå§‹åŒ– UI, sem.div =', sem.div);
            
            // æ›´æ–°éƒ¨åˆ¥ chips
            const chips = document.querySelectorAll('#division-chips .chip');
            chips.forEach(c => {
                c.classList.remove('active', 'day', 'night', 'weekend');
                if (c.dataset.div === sem.div) {
                    c.classList.add('active');
                    c.classList.add(sem.div);
                }
            });
            
            // æ›´æ–°æ—¥æœŸ
            document.getElementById('semester-start').value = sem.start || '';
            document.getElementById('semester-end').value = sem.end || '';
            calcWeeks();
            
            // æ›´æ–°ç¯€æ¬¡è¡¨
            renderPeriods();
        }
        function renderPeriods() {
            const ps = sem.periods && sem.periods.length > 0 ? sem.periods : PERIODS[sem.div || 'day'];
            document.getElementById('period-settings').innerHTML = '<table class="period-table"><thead><tr><th>ç¯€æ¬¡</th><th>é–‹å§‹</th><th>çµæŸ</th></tr></thead><tbody>' + ps.map((p, i) => '<tr><td>ç¬¬' + p.n + 'ç¯€</td><td><input type="time" class="form-input" value="' + p.s + '" onchange="updatePeriod(' + i + ',\'s\',this.value)" style="padding:8px"></td><td><input type="time" class="form-input" value="' + p.e + '" onchange="updatePeriod(' + i + ',\'e\',this.value)" style="padding:8px"></td></tr>').join('') + '</tbody></table>';
            updatePeriodDropdowns();
        }
        function updatePeriod(idx, key, val) {
            sem.periods[idx][key] = val;
            saveSemesterToStorage();
        }
        function calcWeeks() {
            const s = document.getElementById('semester-start').value;
            const e = document.getElementById('semester-end').value;
            if (s && e) {
                const startDate = new Date(s);
                const endDate = new Date(e);
                const weeks = Math.ceil((endDate - startDate) / (7 * 24 * 60 * 60 * 1000));
                document.getElementById('semester-weeks').textContent = weeks;
                
                // è¨ˆç®—ç›®å‰ç¬¬å¹¾é€±
                const now = new Date();
                let currentWeek = 0;
                if (now >= startDate && now <= endDate) {
                    currentWeek = Math.ceil((now - startDate) / (7 * 24 * 60 * 60 * 1000));
                    document.getElementById('current-week').textContent = currentWeek;
                } else if (now < startDate) {
                    document.getElementById('current-week').textContent = 'å°šæœªé–‹å­¸';
                } else {
                    document.getElementById('current-week').textContent = 'å·²çµæ¥­';
                }
                
                sem.start = s;
                sem.end = e;
                sem.weeks = weeks;
                sem.currentWeek = currentWeek;
                
                // é¡¯ç¤ºæ—¥æ›†æŒ‰éˆ•
                const container = document.getElementById('week-selector-container');
                if (container) container.style.display = weeks > 0 ? 'block' : 'none';
                
                // æ›´æ–°å­¸æœŸçµæŸå‘¨æ¬¡é¸æ“‡å™¨
                updateSemesterEndWeekSelector(weeks);
            }
        }
        
        function updateSemesterEndWeekSelector(weeks) {
            const selector = document.getElementById('semester-end-week');
            if (!selector || weeks <= 0) return;
            
            let opts = '';
            for (let i = 1; i <= weeks; i++) {
                opts += `<option value="${i}">ç¬¬ ${i} å‘¨</option>`;
            }
            selector.innerHTML = opts;
            selector.value = weeks;
        }
        
        function toggleSemesterEndWeek() {
            const mode = document.getElementById('semester-end-mode').value;
            const weekGroup = document.getElementById('semester-end-week-group');
            if (weekGroup) {
                weekGroup.style.display = mode === 'specific_week' ? 'block' : 'none';
            }
        }
        
        // === å­¸æœŸæ—¥æ›†é¸æ“‡å™¨ ===
        function openWeekPicker() {
            if (!sem.start || !sem.end) {
                toast('è«‹å…ˆè¨­å®šå­¸æœŸèµ·è¿„æ—¥æœŸ', 'warning');
                return;
            }
            
            const startDate = new Date(sem.start);
            const endDate = new Date(sem.end);
            
            // åˆå§‹åŒ–å¹´ä»½é¸æ“‡å™¨
            const yearSelector = document.getElementById('picker-year');
            const startYear = startDate.getFullYear();
            const endYear = endDate.getFullYear();
            let yearOpts = '';
            for (let y = startYear; y <= endYear; y++) {
                yearOpts += `<option value="${y}">${y} å¹´</option>`;
            }
            yearSelector.innerHTML = yearOpts;
            
            // è¨­å®šç•¶å‰å¹´ä»½
            const now = new Date();
            if (now >= startDate && now <= endDate) {
                yearSelector.value = now.getFullYear();
            } else {
                yearSelector.value = startYear;
            }
            
            // åˆå§‹åŒ–æœˆä»½é¸æ“‡å™¨
            updateMonthPickerOptions();
            
            // æ›´æ–°æ—¥æ›†
            updateWeekPickerCalendar();
            
            openModal('weekPicker');
        }
        
        function updateMonthPickerOptions() {
            const yearSelector = document.getElementById('picker-year');
            const monthSelector = document.getElementById('picker-month');
            const selectedYear = parseInt(yearSelector.value);
            
            const startDate = new Date(sem.start);
            const endDate = new Date(sem.end);
            
            let monthOpts = '';
            for (let m = 1; m <= 12; m++) {
                const checkDate = new Date(selectedYear, m - 1, 15);
                // åªé¡¯ç¤ºåœ¨å­¸æœŸç¯„åœå…§çš„æœˆä»½
                const monthStart = new Date(selectedYear, m - 1, 1);
                const monthEnd = new Date(selectedYear, m, 0);
                
                if (monthEnd >= startDate && monthStart <= endDate) {
                    monthOpts += `<option value="${m}">${m} æœˆ</option>`;
                }
            }
            monthSelector.innerHTML = monthOpts;
            
            // è¨­å®šç•¶å‰æœˆä»½
            const now = new Date();
            if (now.getFullYear() === selectedYear) {
                const currentMonth = now.getMonth() + 1;
                if (monthSelector.querySelector(`option[value="${currentMonth}"]`)) {
                    monthSelector.value = currentMonth;
                }
            }
        }
        
        function updateWeekPickerCalendar() {
            updateMonthPickerOptions();
            
            const yearSelector = document.getElementById('picker-year');
            const monthSelector = document.getElementById('picker-month');
            const listContainer = document.getElementById('week-picker-list');
            
            const selectedYear = parseInt(yearSelector.value);
            const selectedMonth = parseInt(monthSelector.value);
            
            if (!selectedYear || !selectedMonth) {
                listContainer.innerHTML = '<div class="empty"><div class="icon">ğŸ“…</div>è«‹é¸æ“‡å¹´æœˆ</div>';
                return;
            }
            
            const startDate = new Date(sem.start);
            const endDate = new Date(sem.end);
            const now = new Date();
            const totalWeeks = sem.weeks || 0;
            
            // æ‰¾å‡ºè©²æœˆä»½åŒ…å«çš„æ‰€æœ‰å‘¨æ¬¡
            const monthStart = new Date(selectedYear, selectedMonth - 1, 1);
            const monthEnd = new Date(selectedYear, selectedMonth, 0);
            
            let html = `<div style="margin-bottom:10px;font-weight:600;color:var(--primary)">${selectedYear}å¹´${selectedMonth}æœˆ å‘¨æ¬¡åˆ—è¡¨</div>`;
            html += '<div style="display:flex;flex-direction:column;gap:8px">';
            
            let foundWeeks = 0;
            for (let w = 1; w <= totalWeeks; w++) {
                const weekStart = new Date(startDate);
                weekStart.setDate(weekStart.getDate() + (w - 1) * 7);
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekEnd.getDate() + 6);
                
                // æª¢æŸ¥é€™å‘¨æ˜¯å¦èˆ‡é¸å®šæœˆä»½é‡ç–Š
                if (weekEnd >= monthStart && weekStart <= monthEnd) {
                    foundWeeks++;
                    const isCurrentWeek = now >= weekStart && now <= weekEnd;
                    const isPast = weekEnd < now;
                    
                    const weekDays = [];
                    for (let d = 0; d < 7; d++) {
                        const day = new Date(weekStart);
                        day.setDate(day.getDate() + d);
                        weekDays.push({
                            date: day.getDate(),
                            month: day.getMonth() + 1,
                            isCurrentMonth: day.getMonth() + 1 === selectedMonth,
                            isToday: day.toDateString() === now.toDateString()
                        });
                    }
                    
                    html += `
                        <div class="week-picker-item" onclick="selectWeek(${w})" style="
                            padding:12px;
                            border:2px solid ${isCurrentWeek ? 'var(--primary)' : 'var(--border)'};
                            border-radius:10px;
                            cursor:pointer;
                            background:${isCurrentWeek ? 'rgba(79,70,229,0.1)' : isPast ? '#f8f8f8' : '#fff'};
                            transition:all 0.2s;
                        " onmouseover="this.style.borderColor='var(--primary)'" onmouseout="this.style.borderColor='${isCurrentWeek ? 'var(--primary)' : 'var(--border)'}'"
                        >
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                                <span style="font-weight:600;color:${isCurrentWeek ? 'var(--primary)' : 'var(--text)'}">
                                    ç¬¬ ${w} å‘¨ ${isCurrentWeek ? 'ğŸ“' : ''} ${isPast ? 'âœ“' : ''}
                                </span>
                                <span style="font-size:12px;color:var(--text-light)">
                                    ${weekStart.getMonth()+1}/${weekStart.getDate()} - ${weekEnd.getMonth()+1}/${weekEnd.getDate()}
                                </span>
                            </div>
                            <div style="display:grid;grid-template-columns:repeat(7,1fr);gap:4px;text-align:center">
                                ${['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'].map((d, i) => `
                                    <div style="font-size:10px;color:var(--text-light)">${d}</div>
                                `).join('')}
                                ${weekDays.map(d => `
                                    <div style="
                                        font-size:12px;
                                        padding:4px;
                                        border-radius:4px;
                                        color:${d.isCurrentMonth ? (d.isToday ? '#fff' : 'var(--text)') : '#ccc'};
                                        background:${d.isToday ? 'var(--primary)' : 'transparent'};
                                        font-weight:${d.isToday ? '600' : '400'}
                                    ">${d.date}</div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }
            }
            
            html += '</div>';
            
            if (foundWeeks === 0) {
                html = '<div class="empty"><div class="icon">ğŸ“…</div>æ­¤æœˆä»½ç„¡èª²ç¨‹å‘¨æ¬¡</div>';
            }
            
            listContainer.innerHTML = html;
        }
        
        function selectWeek(week) {
            const startDate = new Date(sem.start);
            const weekStart = new Date(startDate);
            weekStart.setDate(weekStart.getDate() + (week - 1) * 7);
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekEnd.getDate() + 6);
            
            const infoEl = document.getElementById('selected-week-info');
            infoEl.style.display = 'block';
            infoEl.innerHTML = `
                <strong>âœ… å·²é¸æ“‡ç¬¬ ${week} å‘¨</strong><br>
                ğŸ“… ${weekStart.getFullYear()}/${weekStart.getMonth()+1}/${weekStart.getDate()} (${DAY_NAMES[weekStart.getDay()]}) 
                ~ ${weekEnd.getFullYear()}/${weekEnd.getMonth()+1}/${weekEnd.getDate()} (${DAY_NAMES[weekEnd.getDay()]})
            `;
            
            toast(`å·²é¸æ“‡ç¬¬ ${week} å‘¨`);
        }
        
        function jumpToCurrentWeek() {
            if (!sem.start || !sem.currentWeek || sem.currentWeek <= 0) {
                toast('ç›®å‰ä¸åœ¨å­¸æœŸæœŸé–“å…§', 'warning');
                return;
            }
            
            const now = new Date();
            document.getElementById('picker-year').value = now.getFullYear();
            updateMonthPickerOptions();
            document.getElementById('picker-month').value = now.getMonth() + 1;
            updateWeekPickerCalendar();
            
            setTimeout(() => selectWeek(sem.currentWeek), 100);
        }
        
        function jumpToFirstWeek() {
            if (!sem.start) return;
            const startDate = new Date(sem.start);
            document.getElementById('picker-year').value = startDate.getFullYear();
            updateMonthPickerOptions();
            document.getElementById('picker-month').value = startDate.getMonth() + 1;
            updateWeekPickerCalendar();
            
            setTimeout(() => selectWeek(1), 100);
        }
        
        function jumpToLastWeek() {
            if (!sem.end || !sem.weeks) return;
            const endDate = new Date(sem.end);
            document.getElementById('picker-year').value = endDate.getFullYear();
            updateMonthPickerOptions();
            document.getElementById('picker-month').value = endDate.getMonth() + 1;
            updateWeekPickerCalendar();
            
            setTimeout(() => selectWeek(sem.weeks), 100);
        }
        async function saveSemester() {
            calcWeeks();
            saveSemesterToStorage();
            
            // å„²å­˜è‡ªå‹•æé†’è¨­å®šåˆ°ä¼ºæœå™¨
            const autoRemind = document.getElementById('auto-remind').checked;
            const remindMinutes = document.getElementById('remind-minutes').value;
            const absentNotifyTimes = document.getElementById('absent-notify-times').value;
            const semesterEndMode = document.getElementById('semester-end-mode').value;
            const semesterEndWeek = document.getElementById('semester-end-week').value;
            
            await api('/api/settings', { 
                method: 'POST', 
                body: JSON.stringify({
                    remindBeforeClass: autoRemind,
                    remindMinutes: parseInt(remindMinutes),
                    semesterStart: sem.start,
                    semesterEnd: sem.end,
                    absentNotifyTimes: parseInt(absentNotifyTimes),
                    semesterEndMode: semesterEndMode,
                    semesterEndWeek: parseInt(semesterEndWeek) || 0
                })
            });
            
            toast('å­¸æœŸè¨­å®šå·²å„²å­˜ï¼');
        }
        async function loadReminderSettings() {
            const r = await api('/api/settings');
            if (r) {
                document.getElementById('auto-remind').checked = r.remindBeforeClass !== false;
                document.getElementById('remind-minutes').value = r.remindMinutes || 30;
                if (r.absentNotifyTimes !== undefined) {
                    document.getElementById('absent-notify-times').value = r.absentNotifyTimes;
                }
                if (r.semesterEndMode) {
                    document.getElementById('semester-end-mode').value = r.semesterEndMode;
                    toggleSemesterEndWeek();
                }
                if (r.semesterEndWeek) {
                    document.getElementById('semester-end-week').value = r.semesterEndWeek;
                }
            }
        }
        function updatePeriodDropdowns() {
            const ps = sem.periods && sem.periods.length > 0 ? sem.periods : PERIODS[sem.div || 'day'];
            const opts = ps.map(p => '<option value="' + p.n + '">ç¬¬' + p.n + 'ç¯€ (' + p.s + '-' + p.e + ')</option>').join('');
            document.getElementById('course-period').innerHTML = opts;
            document.getElementById('edit-course-period').innerHTML = opts;
        }

        // === ç­ç´šç®¡ç† ===
        async function loadClasses() {
            const data = await api('/api/classes');
            if (data) {
                classes = data;
                renderClasses();
                updateClassDropdowns();
            }
        }
        function renderClasses() {
            document.getElementById('classes-list').innerHTML = classes.length ? classes.map(c => 
                '<div class="item-card" onclick="editClass(\'' + c.code + '\')">' +
                '<div class="icon" style="background:var(--primary)">ğŸ«</div>' +
                '<div class="info"><h5>' + c.code + ' - ' + c.name + '</h5><span>' + (DIV_NAMES[c.division] || 'æ—¥é–“éƒ¨') + (c.teacher ? ' Â· ' + c.teacher : '') + '</span></div>' +
                '<div class="actions"><span class="badge primary">' + (c.count || 0) + ' äºº</span></div></div>'
            ).join('') : '<div class="empty">å°šç„¡ç­ç´šï¼Œè«‹é»æ“Šä¸Šæ–¹æŒ‰éˆ•æ–°å¢</div>';
        }
        async function addClass() {
            const code = document.getElementById('class-code').value.trim();
            const name = document.getElementById('class-name').value.trim();
            const division = document.getElementById('class-division').value;
            const teacher = document.getElementById('class-teacher').value.trim();
            if (!code || !name) { toast('è«‹å¡«å¯«ç­ç´šä»£ç¢¼å’Œåç¨±', 'danger'); return; }
            const r = await api('/api/classes', { method: 'POST', body: JSON.stringify({ code, name, division, teacher }) });
            if (r?.success) { toast('ç­ç´šå·²æ–°å¢ï¼'); closeModal('addClass'); loadClasses(); document.getElementById('class-code').value = ''; document.getElementById('class-name').value = ''; document.getElementById('class-teacher').value = ''; }
            else { toast(r?.message || 'æ–°å¢å¤±æ•—', 'danger'); }
        }
        function editClass(code) {
            currentClass = classes.find(c => c.code === code);
            if (!currentClass) return;
            document.getElementById('edit-class-code').value = currentClass.code;
            document.getElementById('edit-class-name').value = currentClass.name;
            document.getElementById('edit-class-division').value = currentClass.division || 'day';
            document.getElementById('edit-class-teacher').value = currentClass.teacher || '';
            openModal('editClass');
        }
        async function saveClass() {
            const name = document.getElementById('edit-class-name').value.trim();
            const division = document.getElementById('edit-class-division').value;
            const teacher = document.getElementById('edit-class-teacher').value.trim();
            console.log('å„²å­˜ç­ç´š:', currentClass.code, { name, division, teacher });
            const r = await api('/api/classes/' + currentClass.code, { method: 'PUT', body: JSON.stringify({ name, division, teacher }) });
            console.log('API å›æ‡‰:', r);
            if (r?.success) { 
                toast('ç­ç´šå·²æ›´æ–°ï¼'); 
                closeModal('editClass'); 
                loadClasses(); 
            } else {
                toast(r?.message || 'æ›´æ–°å¤±æ•—', 'danger');
            }
        }
        async function deleteClass() {
            if (!confirm('ç¢ºå®šåˆªé™¤ç­ç´š ' + currentClass.code + 'ï¼Ÿ')) return;
            const r = await api('/api/classes/' + currentClass.code, { method: 'DELETE' });
            if (r?.success) {
                toast('ç­ç´šå·²åˆªé™¤ï¼'); 
                closeModal('editClass'); 
                loadClasses();
            } else {
                toast('åˆªé™¤å¤±æ•—', 'danger');
            }
        }
        function updateClassDropdowns() {
            const opts = '<option value="">é¸æ“‡ç­ç´š</option>' + classes.map(c => '<option value="' + c.code + '">' + c.code + ' - ' + c.name + '</option>').join('');
            document.getElementById('course-class').innerHTML = opts;
            document.getElementById('edit-course-class').innerHTML = opts;
            document.getElementById('student-class').innerHTML = opts;
            document.getElementById('edit-student-class').innerHTML = opts;
            document.getElementById('student-filter').innerHTML = '<option value="">å…¨éƒ¨ç­ç´š</option>' + classes.map(c => '<option value="' + c.code + '">' + c.name + '</option>').join('');
        }

        // === èª²ç¨‹ç®¡ç† ===
        async function loadCourses() {
            const data = await api('/api/courses');
            console.log('è¼‰å…¥èª²ç¨‹:', data);
            if (data) {
                courses = data;
                console.log('èª²ç¨‹è³‡æ–™:', courses.map(c => ({ id: c.id, name: c.name || c.subject, day: c.day, period: c.period })));
                renderCourses();
                renderScheduleGrid();
            }
        }
        function renderCourses() {
            document.getElementById('courses-list').innerHTML = courses.length ? courses.map(c => {
                const dayName = DAY_NAMES[c.day] || '?';
                const period = c.period || '?';
                const radiusText = c.radius === -1 ? 'ğŸ“±ç¾å ´' : c.radius === 0 ? 'ğŸŒç·šä¸Š' : `ğŸ“${c.radius}m`;
                return '<div class="item-card" onclick="editCourse(\'' + c.id + '\')">' +
                    '<div class="icon" style="background:var(--success)">ğŸ“–</div>' +
                    '<div class="info"><h5>' + (c.name || c.subject || 'æœªå‘½å') + '</h5><span>ç­ç´š ' + c.classCode + ' Â· é€±' + dayName + ' ç¬¬' + period + 'ç¯€ Â· ' + (c.room || 'æ•™å®¤æœªè¨­å®š') + ' Â· ' + radiusText + '</span></div></div>';
            }).join('') : '<div class="empty">å°šç„¡èª²ç¨‹</div>';
        }
        function showView(view) {
            const tabs = document.querySelectorAll('#page-schedule .tabs .tab');
            tabs.forEach((t, i) => {
                if (view === 'grid') t.classList.toggle('active', i === 0);
                else if (view === 'list') t.classList.toggle('active', i === 1);
                else if (view === 'substitute') t.classList.toggle('active', i === 2);
            });
            document.getElementById('grid-view').style.display = view === 'grid' ? 'block' : 'none';
            document.getElementById('list-view').style.display = view === 'list' ? 'block' : 'none';
            document.getElementById('substitute-view').style.display = view === 'substitute' ? 'block' : 'none';
            
            if (view === 'substitute') {
                loadSubstitutes();
            }
        }
        
        // === èª²è¡¨å‘¨æ¬¡é¸æ“‡å™¨ ===
        function initScheduleWeekSelector() {
            if (!sem.start || !sem.end) {
                document.getElementById('schedule-week-selector').style.display = 'none';
                return;
            }
            
            document.getElementById('schedule-week-selector').style.display = 'block';
            
            const startDate = new Date(sem.start);
            const endDate = new Date(sem.end);
            const now = new Date();
            
            // åˆå§‹åŒ–å¹´ä»½
            const yearSelector = document.getElementById('schedule-year');
            const startYear = startDate.getFullYear();
            const endYear = endDate.getFullYear();
            let yearOpts = '';
            for (let y = startYear; y <= endYear; y++) {
                yearOpts += `<option value="${y}">${y} å¹´</option>`;
            }
            yearSelector.innerHTML = yearOpts;
            
            // è¨­å®šç•¶å‰å¹´ä»½
            if (now >= startDate && now <= endDate) {
                yearSelector.value = now.getFullYear();
            } else {
                yearSelector.value = startYear;
            }
            
            onScheduleYearChange();
            
            // è¨­å®šç•¶å‰å‘¨
            if (sem.currentWeek > 0) {
                selectedScheduleWeek = sem.currentWeek;
                document.getElementById('schedule-week').value = selectedScheduleWeek;
                updateScheduleWeekInfo();
            }
        }
        
        function onScheduleYearChange() {
            const yearSelector = document.getElementById('schedule-year');
            const monthSelector = document.getElementById('schedule-month');
            const selectedYear = parseInt(yearSelector.value);
            
            const startDate = new Date(sem.start);
            const endDate = new Date(sem.end);
            
            let monthOpts = '';
            for (let m = 1; m <= 12; m++) {
                const monthStart = new Date(selectedYear, m - 1, 1);
                const monthEnd = new Date(selectedYear, m, 0);
                if (monthEnd >= startDate && monthStart <= endDate) {
                    monthOpts += `<option value="${m}">${m} æœˆ</option>`;
                }
            }
            monthSelector.innerHTML = monthOpts;
            
            // è¨­å®šç•¶å‰æœˆä»½
            const now = new Date();
            if (now.getFullYear() === selectedYear) {
                const currentMonth = now.getMonth() + 1;
                if (monthSelector.querySelector(`option[value="${currentMonth}"]`)) {
                    monthSelector.value = currentMonth;
                }
            }
            
            onScheduleMonthChange();
        }
        
        function onScheduleMonthChange() {
            const yearSelector = document.getElementById('schedule-year');
            const monthSelector = document.getElementById('schedule-month');
            const weekSelector = document.getElementById('schedule-week');
            
            const selectedYear = parseInt(yearSelector.value);
            const selectedMonth = parseInt(monthSelector.value);
            
            if (!selectedYear || !selectedMonth) return;
            
            const startDate = new Date(sem.start);
            const monthStart = new Date(selectedYear, selectedMonth - 1, 1);
            const monthEnd = new Date(selectedYear, selectedMonth, 0);
            const totalWeeks = sem.weeks || 0;
            const now = new Date();
            
            let weekOpts = '';
            for (let w = 1; w <= totalWeeks; w++) {
                const weekStart = new Date(startDate);
                weekStart.setDate(weekStart.getDate() + (w - 1) * 7);
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekEnd.getDate() + 6);
                
                if (weekEnd >= monthStart && weekStart <= monthEnd) {
                    const isCurrentWeek = now >= weekStart && now <= weekEnd;
                    const label = `ç¬¬ ${w} å‘¨ (${weekStart.getMonth()+1}/${weekStart.getDate()}-${weekEnd.getMonth()+1}/${weekEnd.getDate()})${isCurrentWeek ? ' ğŸ“' : ''}`;
                    weekOpts += `<option value="${w}">${label}</option>`;
                }
            }
            weekSelector.innerHTML = weekOpts || '<option value="">æ­¤æœˆä»½ç„¡èª²ç¨‹å‘¨æ¬¡</option>';
            
            if (selectedScheduleWeek > 0 && weekSelector.querySelector(`option[value="${selectedScheduleWeek}"]`)) {
                weekSelector.value = selectedScheduleWeek;
            }
        }
        
        function onScheduleWeekChange() {
            const weekSelector = document.getElementById('schedule-week');
            selectedScheduleWeek = parseInt(weekSelector.value) || 0;
            updateScheduleWeekInfo();
            renderScheduleGrid();
        }
        
        function updateScheduleWeekInfo() {
            const infoEl = document.getElementById('schedule-week-info');
            if (!selectedScheduleWeek || !sem.start) {
                infoEl.style.display = 'none';
                return;
            }
            
            const startDate = new Date(sem.start);
            const weekStart = new Date(startDate);
            weekStart.setDate(weekStart.getDate() + (selectedScheduleWeek - 1) * 7);
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekEnd.getDate() + 6);
            
            const now = new Date();
            const isCurrentWeek = now >= weekStart && now <= weekEnd;
            
            infoEl.style.display = 'block';
            infoEl.className = isCurrentWeek ? 'alert alert-success' : 'alert alert-info';
            infoEl.innerHTML = `
                <strong>${isCurrentWeek ? 'ğŸ“ æœ¬å‘¨' : `ğŸ“… ç¬¬ ${selectedScheduleWeek} å‘¨`}</strong>ï¼š
                ${weekStart.getFullYear()}/${weekStart.getMonth()+1}/${weekStart.getDate()} (${DAY_NAMES[weekStart.getDay()]}) 
                ~ ${weekEnd.getFullYear()}/${weekEnd.getMonth()+1}/${weekEnd.getDate()} (${DAY_NAMES[weekEnd.getDay()]})
            `;
        }
        
        function goToPrevWeek() {
            if (selectedScheduleWeek > 1) {
                selectedScheduleWeek--;
                syncWeekSelectors();
            } else {
                toast('å·²ç¶“æ˜¯ç¬¬ä¸€å‘¨', 'warning');
            }
        }
        
        function goToNextWeek() {
            if (selectedScheduleWeek < (sem.weeks || 0)) {
                selectedScheduleWeek++;
                syncWeekSelectors();
            } else {
                toast('å·²ç¶“æ˜¯æœ€å¾Œä¸€å‘¨', 'warning');
            }
        }
        
        function goToCurrentWeek() {
            if (!sem.currentWeek || sem.currentWeek <= 0) {
                toast('ç›®å‰ä¸åœ¨å­¸æœŸæœŸé–“å…§', 'warning');
                return;
            }
            selectedScheduleWeek = sem.currentWeek;
            syncWeekSelectors();
        }
        
        function syncWeekSelectors() {
            if (!sem.start || !selectedScheduleWeek) return;
            
            const startDate = new Date(sem.start);
            const weekStart = new Date(startDate);
            weekStart.setDate(weekStart.getDate() + (selectedScheduleWeek - 1) * 7);
            
            document.getElementById('schedule-year').value = weekStart.getFullYear();
            onScheduleYearChange();
            document.getElementById('schedule-month').value = weekStart.getMonth() + 1;
            onScheduleMonthChange();
            document.getElementById('schedule-week').value = selectedScheduleWeek;
            
            updateScheduleWeekInfo();
            renderScheduleGrid();
        }
        
        function applyWeekToSchedule() {
            const infoEl = document.getElementById('selected-week-info');
            if (!infoEl.style.display || infoEl.style.display === 'none') {
                toast('è«‹å…ˆé¸æ“‡ä¸€å€‹å‘¨æ¬¡', 'warning');
                return;
            }
            
            // å¾é¸ä¸­çš„å‘¨æ¬¡è³‡è¨Šä¸­å–å¾—å‘¨æ¬¡
            const match = infoEl.innerHTML.match(/ç¬¬ (\d+) å‘¨/);
            if (match) {
                selectedScheduleWeek = parseInt(match[1]);
                closeModal('weekPicker');
                showPage('schedule');
                syncWeekSelectors();
                toast(`å·²åˆ‡æ›åˆ°ç¬¬ ${selectedScheduleWeek} å‘¨`);
            }
        }
        
        // === èª¿ä»£èª²åŠŸèƒ½ ===
        async function loadSubstitutes() {
            const data = await api('/api/substitutes');
            substitutes = data || [];
            renderSubstitutes();
        }
        
        function renderSubstitutes() {
            const container = document.getElementById('substitute-list');
            if (!substitutes || substitutes.length === 0) {
                container.innerHTML = '<div class="empty"><div class="icon">ğŸ”„</div><h3>å°šç„¡èª¿ä»£èª²ç´€éŒ„</h3><p style="color:var(--text-light)">é»æ“Šä¸Šæ–¹æŒ‰éˆ•æ–°å¢èª¿ä»£èª²</p></div>';
                return;
            }
            
            const typeLabels = {
                'substitute': 'ğŸ‘¨â€ğŸ« ä»£èª²',
                'swap': 'ğŸ”„ èª¿èª²',
                'cancel': 'âŒ åœèª²',
                'makeup': 'ğŸ“ è£œèª²'
            };
            
            const typeColors = {
                'substitute': '#3b82f6',
                'swap': '#f59e0b',
                'cancel': '#ef4444',
                'makeup': '#10b981'
            };
            
            let html = '';
            substitutes.forEach(s => {
                const course = courses.find(c => c.id === s.courseId);
                const courseName = course ? (course.name || course.subject) : 'æœªçŸ¥èª²ç¨‹';
                
                html += `
                    <div class="list-item" onclick="editSubstitute('${s.id}')" style="border-left:4px solid ${typeColors[s.type] || '#666'}">
                        <div class="item-main">
                            <div class="item-title">
                                <span style="background:${typeColors[s.type] || '#666'};color:#fff;padding:2px 8px;border-radius:10px;font-size:11px;margin-right:8px">${typeLabels[s.type] || s.type}</span>
                                ${courseName}
                            </div>
                            <div class="item-subtitle">
                                ğŸ“… ${s.date} ${s.teacher ? 'ãƒ»ğŸ‘¨â€ğŸ« ' + s.teacher : ''} ${s.newDate ? 'ãƒ»âœ ' + s.newDate : ''}
                            </div>
                            ${s.note ? `<div class="item-subtitle">ğŸ’¬ ${s.note}</div>` : ''}
                        </div>
                        <span class="item-arrow">â€º</span>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function onSubTypeChange() {
            const type = document.getElementById('sub-type').value;
            document.getElementById('sub-substitute-fields').style.display = (type === 'substitute') ? 'block' : 'none';
            document.getElementById('sub-swap-fields').style.display = (type === 'swap' || type === 'makeup') ? 'block' : 'none';
        }
        
        function onEditSubTypeChange() {
            const type = document.getElementById('edit-sub-type').value;
            document.getElementById('edit-sub-substitute-fields').style.display = (type === 'substitute') ? 'block' : 'none';
            document.getElementById('edit-sub-swap-fields').style.display = (type === 'swap' || type === 'makeup') ? 'block' : 'none';
        }
        
        function openSubstituteModal() {
            // æ›´æ–°èª²ç¨‹ä¸‹æ‹‰é¸å–®
            const courseOpts = courses.map(c => `<option value="${c.id}">${c.name || c.subject} (${c.classCode})</option>`).join('');
            document.getElementById('sub-original-course').innerHTML = '<option value="">é¸æ“‡èª²ç¨‹</option>' + courseOpts;
            
            // æ›´æ–°ç¯€æ¬¡ä¸‹æ‹‰é¸å–®
            const ps = sem.periods && sem.periods.length > 0 ? sem.periods : PERIODS[sem.div || 'day'];
            const periodOpts = ps.map(p => `<option value="${p.n}">ç¬¬${p.n}ç¯€ (${p.s}-${p.e})</option>`).join('');
            document.getElementById('sub-new-period').innerHTML = periodOpts;
            
            // è¨­å®šé è¨­æ—¥æœŸç‚ºä»Šå¤©
            document.getElementById('sub-date').value = new Date().toISOString().split('T')[0];
            
            onSubTypeChange();
            openModal('addSubstitute');
        }
        
        async function addSubstitute() {
            const type = document.getElementById('sub-type').value;
            const courseId = document.getElementById('sub-original-course').value;
            const date = document.getElementById('sub-date').value;
            const teacher = document.getElementById('sub-teacher').value.trim();
            const newDate = document.getElementById('sub-new-date').value;
            const newPeriod = document.getElementById('sub-new-period').value;
            const note = document.getElementById('sub-note').value.trim();
            
            if (!courseId || !date) {
                toast('è«‹é¸æ“‡èª²ç¨‹å’Œæ—¥æœŸ', 'danger');
                return;
            }
            
            const data = { type, courseId, date, teacher, newDate, newPeriod, note };
            const r = await api('/api/substitutes', { method: 'POST', body: JSON.stringify(data) });
            
            if (r?.success) {
                toast('èª¿ä»£èª²å·²æ–°å¢ï¼');
                closeModal('addSubstitute');
                loadSubstitutes();
                
                // æ¸…ç©ºè¡¨å–®
                document.getElementById('sub-teacher').value = '';
                document.getElementById('sub-new-date').value = '';
                document.getElementById('sub-note').value = '';
            } else {
                toast(r?.message || 'æ–°å¢å¤±æ•—', 'danger');
            }
        }
        
        function editSubstitute(id) {
            currentSubstitute = substitutes.find(s => s.id === id);
            if (!currentSubstitute) return;
            
            // æ›´æ–°èª²ç¨‹ä¸‹æ‹‰é¸å–®
            const courseOpts = courses.map(c => `<option value="${c.id}">${c.name || c.subject} (${c.classCode})</option>`).join('');
            document.getElementById('edit-sub-original-course').innerHTML = '<option value="">é¸æ“‡èª²ç¨‹</option>' + courseOpts;
            
            // æ›´æ–°ç¯€æ¬¡ä¸‹æ‹‰é¸å–®
            const ps = sem.periods && sem.periods.length > 0 ? sem.periods : PERIODS[sem.div || 'day'];
            const periodOpts = ps.map(p => `<option value="${p.n}">ç¬¬${p.n}ç¯€ (${p.s}-${p.e})</option>`).join('');
            document.getElementById('edit-sub-new-period').innerHTML = periodOpts;
            
            // å¡«å…¥è³‡æ–™
            document.getElementById('edit-sub-type').value = currentSubstitute.type || 'substitute';
            document.getElementById('edit-sub-original-course').value = currentSubstitute.courseId || '';
            document.getElementById('edit-sub-date').value = currentSubstitute.date || '';
            document.getElementById('edit-sub-teacher').value = currentSubstitute.teacher || '';
            document.getElementById('edit-sub-new-date').value = currentSubstitute.newDate || '';
            document.getElementById('edit-sub-new-period').value = currentSubstitute.newPeriod || '';
            document.getElementById('edit-sub-note').value = currentSubstitute.note || '';
            
            onEditSubTypeChange();
            openModal('editSubstitute');
        }
        
        async function saveSubstitute() {
            const type = document.getElementById('edit-sub-type').value;
            const courseId = document.getElementById('edit-sub-original-course').value;
            const date = document.getElementById('edit-sub-date').value;
            const teacher = document.getElementById('edit-sub-teacher').value.trim();
            const newDate = document.getElementById('edit-sub-new-date').value;
            const newPeriod = document.getElementById('edit-sub-new-period').value;
            const note = document.getElementById('edit-sub-note').value.trim();
            
            const data = { type, courseId, date, teacher, newDate, newPeriod, note };
            const r = await api('/api/substitutes/' + currentSubstitute.id, { method: 'PUT', body: JSON.stringify(data) });
            
            if (r?.success) {
                toast('èª¿ä»£èª²å·²æ›´æ–°ï¼');
                closeModal('editSubstitute');
                loadSubstitutes();
            } else {
                toast(r?.message || 'æ›´æ–°å¤±æ•—', 'danger');
            }
        }
        
        async function deleteSubstitute() {
            if (!confirm('ç¢ºå®šåˆªé™¤æ­¤èª¿ä»£èª²ç´€éŒ„ï¼Ÿ')) return;
            
            const r = await api('/api/substitutes/' + currentSubstitute.id, { method: 'DELETE' });
            
            if (r?.success) {
                toast('èª¿ä»£èª²å·²åˆªé™¤ï¼');
                closeModal('editSubstitute');
                loadSubstitutes();
            } else {
                toast(r?.message || 'åˆªé™¤å¤±æ•—', 'danger');
            }
        }
        
        function renderScheduleGrid() {
            const div = sem.div || 'day';
            const ps = sem.periods && sem.periods.length > 0 ? sem.periods : PERIODS[div];
            const days = div === 'weekend' ? ['', 'å…­', 'æ—¥'] : ['', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”'];
            let html = days.map(d => '<div class="schedule-header">' + (d || 'ç¯€æ¬¡') + '</div>').join('');
            ps.forEach(p => {
                html += '<div class="schedule-time">' + p.n + '<br><small>' + p.s + '</small></div>';
                for (let i = 1; i < days.length; i++) {
                    const dayNum = div === 'weekend' ? (i === 1 ? 6 : 0) : i;
                    const c = courses.find(x => x.day == dayNum && x.period == p.n);
                    if (c) {
                        html += '<div class="schedule-cell has-class" onclick="editCourse(\'' + c.id + '\')"><div class="class-tag">' + (c.name || c.subject) + '<br>' + c.classCode + '</div></div>';
                    } else {
                        html += '<div class="schedule-cell" onclick="quickAddCourse(' + dayNum + ',' + p.n + ')"></div>';
                    }
                }
            });
            document.getElementById('schedule-grid').innerHTML = html;
            document.getElementById('schedule-grid').style.gridTemplateColumns = '60px repeat(' + (days.length - 1) + ', 1fr)';
        }
        function quickAddCourse(day, period) {
            document.getElementById('course-day').value = day;
            document.getElementById('course-period').value = period;
            openModal('addCourse');
        }
        async function addCourse() {
            const name = document.getElementById('course-name').value.trim();
            const classCode = document.getElementById('course-class').value;
            const day = parseInt(document.getElementById('course-day').value);
            const period = parseInt(document.getElementById('course-period').value);
            const room = document.getElementById('course-room').value.trim();
            const lat = document.getElementById('course-lat').value;
            const lon = document.getElementById('course-lon').value;
            const radius = parseInt(document.getElementById('course-radius').value) || 100;
            if (!name || !classCode) { toast('è«‹å¡«å¯«èª²ç¨‹åç¨±å’Œç­ç´š', 'danger'); return; }
            const p = ((sem.periods && sem.periods.length > 0 ? sem.periods : PERIODS[sem.div || "day"])).find(x => x.n == period) || {};
            const r = await api('/api/courses', { method: 'POST', body: JSON.stringify({ subject: name, name, classCode, day, period, time: p.s + '-' + p.e, room, lat: lat ? +lat : 0, lon: lon ? +lon : 0, radius: radius }) });
            if (r?.success) { toast('èª²ç¨‹å·²æ–°å¢ï¼'); closeModal('addCourse'); loadCourses(); document.getElementById('course-name').value = ''; document.getElementById('course-room').value = ''; }
        }
        function editCourse(id) {
            currentCourse = courses.find(c => c.id === id);
            if (!currentCourse) return;
            console.log('ç·¨è¼¯èª²ç¨‹:', currentCourse);
            document.getElementById('edit-course-name').value = currentCourse.name || currentCourse.subject || '';
            document.getElementById('edit-course-class').value = currentCourse.classCode || '';
            document.getElementById('edit-course-day').value = currentCourse.day || 1;
            document.getElementById('edit-course-period').value = currentCourse.period || 1;
            document.getElementById('edit-course-room').value = currentCourse.room || '';
            document.getElementById('edit-course-lat').value = currentCourse.lat || '';
            document.getElementById('edit-course-lon').value = currentCourse.lon || '';
            // ç¢ºä¿ radius æ­£ç¢ºè¨­å®šï¼ˆè½‰ç‚ºå­—ä¸²æ¯”å° select optionï¼‰
            const radiusValue = String(currentCourse.radius !== undefined ? currentCourse.radius : 100);
            document.getElementById('edit-course-radius').value = radiusValue;
            console.log('è¨­å®š radius:', radiusValue, 'ç›®å‰é¸æ“‡:', document.getElementById('edit-course-radius').value);
            openModal('editCourse');
        }
        async function saveCourse() {
            const subject = document.getElementById('edit-course-name').value.trim();
            const classCode = document.getElementById('edit-course-class').value;
            const day = parseInt(document.getElementById('edit-course-day').value);
            const period = parseInt(document.getElementById('edit-course-period').value);
            const room = document.getElementById('edit-course-room').value.trim();
            const lat = document.getElementById('edit-course-lat').value;
            const lon = document.getElementById('edit-course-lon').value;
            const radius = parseInt(document.getElementById('edit-course-radius').value);
            const p = ((sem.periods && sem.periods.length > 0 ? sem.periods : PERIODS[sem.div || "day"])).find(x => x.n == period) || {};
            console.log('ğŸ“ å„²å­˜èª²ç¨‹:', currentCourse.id, { radius, radiusType: typeof radius });
            const r = await api('/api/courses/' + currentCourse.id, { method: 'PUT', body: JSON.stringify({ subject, classCode, day, period, time: p.s + '-' + p.e, room, lat: lat ? +lat : 0, lon: lon ? +lon : 0, radius }) });
            console.log('ğŸ“ API å›æ‡‰:', r);
            if (r?.success) { 
                const radiusText = radius === -1 ? 'ç¾å ´ç°½åˆ°' : radius === 0 ? 'ä¸é™åˆ¶' : `GPS ${radius}å…¬å°º`;
                // é¡¯ç¤ºä¼ºæœå™¨ç¢ºèªçš„å€¼
                const serverRadius = r.radius || radius;
                toast(`âœ… å·²æ›´æ–°ï¼ç°½åˆ°ç¯„åœï¼š${serverRadius} å…¬å°º`); 
                closeModal('editCourse'); 
                await loadCourses(); 
            } else {
                toast(r?.message || 'æ›´æ–°å¤±æ•—', 'danger');
            }
        }
        // === è¶…å¼·åŒ– GPS å®šä½ç³»çµ± v2.0 ===
        // åŒ…å«ï¼šå¡çˆ¾æ›¼æ¿¾æ³¢ã€ç•°å¸¸å€¼éæ¿¾ã€åŠ æ¬Šå¹³å‡ã€çµ±è¨ˆåˆ†æã€åœ°åœ–é è¦½
        let gpsWatchId = null;
        let gpsAborted = false;
        
        const GPS_CONFIG = {
            targetAccuracy: 20,      // ç›®æ¨™ç²¾åº¦ï¼ˆå…¬å°ºï¼‰- æ›´åš´æ ¼
            excellentAccuracy: 10,   // æ¥µä½³ç²¾åº¦ - ç«‹å³æ¡ç”¨
            maxWaitTime: 30000,      // æœ€å¤§ç­‰å¾…æ™‚é–“ 30 ç§’
            minSamples: 5,           // æœ€å°‘å–æ¨£æ¬¡æ•¸
            maxSamples: 20,          // æœ€å¤šå–æ¨£æ¬¡æ•¸
            stableThreshold: 3,      // é€£çºŒç©©å®šæ¬¡æ•¸é–€æª»
            stableDistance: 5,       // ç©©å®šåˆ¤å®šè·é›¢ï¼ˆå…¬å°ºï¼‰
            outlierThreshold: 2.5,   // ç•°å¸¸å€¼æ¨™æº–å·®å€æ•¸
            kalmanQ: 0.00001,        // å¡çˆ¾æ›¼æ¿¾æ³¢éç¨‹å™ªéŸ³
            kalmanR: 0.01            // å¡çˆ¾æ›¼æ¿¾æ³¢æ¸¬é‡å™ªéŸ³
        };
        
        // å¡çˆ¾æ›¼æ¿¾æ³¢å™¨é¡åˆ¥
        class KalmanFilter {
            constructor(q = GPS_CONFIG.kalmanQ, r = GPS_CONFIG.kalmanR) {
                this.q = q; // éç¨‹å™ªéŸ³
                this.r = r; // æ¸¬é‡å™ªéŸ³
                this.x = null; // ä¼°è¨ˆå€¼
                this.p = 1; // ä¼°è¨ˆèª¤å·®
                this.k = 0; // å¡çˆ¾æ›¼å¢ç›Š
            }
            filter(measurement) {
                if (this.x === null) {
                    this.x = measurement;
                    return measurement;
                }
                // é æ¸¬
                this.p = this.p + this.q;
                // æ›´æ–°
                this.k = this.p / (this.p + this.r);
                this.x = this.x + this.k * (measurement - this.x);
                this.p = (1 - this.k) * this.p;
                return this.x;
            }
        }
        
        // è¨ˆç®—å…©é»è·é›¢ï¼ˆå…¬å°ºï¼‰
        function calcGPSDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) ** 2 + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) ** 2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }
        
        // è¨ˆç®—æ¨™æº–å·®
        function calcStdDev(arr, mean) {
            const sqDiffs = arr.map(v => (v - mean) ** 2);
            return Math.sqrt(sqDiffs.reduce((a, b) => a + b, 0) / arr.length);
        }
        
        // ç§»é™¤ç•°å¸¸å€¼ï¼ˆä½¿ç”¨ IQR æ–¹æ³•ï¼‰
        function removeOutliers(samples) {
            if (samples.length < 4) return samples;
            
            const lats = samples.map(s => s.latitude).sort((a,b) => a-b);
            const lons = samples.map(s => s.longitude).sort((a,b) => a-b);
            
            const q1Lat = lats[Math.floor(lats.length * 0.25)];
            const q3Lat = lats[Math.floor(lats.length * 0.75)];
            const iqrLat = q3Lat - q1Lat;
            
            const q1Lon = lons[Math.floor(lons.length * 0.25)];
            const q3Lon = lons[Math.floor(lons.length * 0.75)];
            const iqrLon = q3Lon - q1Lon;
            
            return samples.filter(s => 
                s.latitude >= q1Lat - 1.5 * iqrLat && s.latitude <= q3Lat + 1.5 * iqrLat &&
                s.longitude >= q1Lon - 1.5 * iqrLon && s.longitude <= q3Lon + 1.5 * iqrLon
            );
        }
        
        // åŠ æ¬Šå¹³å‡è¨ˆç®—ï¼ˆç²¾åº¦è¶Šé«˜æ¬Šé‡è¶Šå¤§ï¼‰
        function calcWeightedAverage(samples) {
            if (samples.length === 0) return null;
            
            // æ¬Šé‡ = 1 / accuracyÂ²ï¼ˆç²¾åº¦è¶Šå°æ¬Šé‡è¶Šå¤§ï¼‰
            let totalWeight = 0;
            let weightedLat = 0;
            let weightedLon = 0;
            
            samples.forEach(s => {
                const weight = 1 / (s.accuracy ** 2);
                totalWeight += weight;
                weightedLat += s.latitude * weight;
                weightedLon += s.longitude * weight;
            });
            
            return {
                latitude: weightedLat / totalWeight,
                longitude: weightedLon / totalWeight
            };
        }
        
        // è¨ˆç®—ä¸­ä½æ•¸
        function median(arr) {
            const sorted = [...arr].sort((a, b) => a - b);
            const mid = Math.floor(sorted.length / 2);
            return sorted.length % 2 ? sorted[mid] : (sorted[mid - 1] + sorted[mid]) / 2;
        }
        
        function getHighAccuracyPosition(latField, lonField, isEdit = false) {
            if (!navigator.geolocation) { 
                toast('ç€è¦½å™¨ä¸æ”¯æ´å®šä½', 'danger'); 
                return; 
            }
            
            // æ¸…é™¤ä¹‹å‰çš„ç›£è½
            if (gpsWatchId) {
                navigator.geolocation.clearWatch(gpsWatchId);
                gpsWatchId = null;
            }
            gpsAborted = false;
            
            const samples = [];
            const kalmanLat = new KalmanFilter();
            const kalmanLon = new KalmanFilter();
            let bestPosition = null;
            let bestAccuracy = Infinity;
            let stableCount = 0;
            let lastPosition = null;
            const startTime = Date.now();
            
            // é¡¯ç¤ºå®šä½ç‹€æ…‹ UI
            const statusId = 'gps-status-' + Date.now();
            const statusHtml = `<div id="${statusId}" style="margin-top:10px;padding:15px;background:linear-gradient(135deg,#1a1a2e,#16213e);border-radius:12px;color:#fff;text-align:center;box-shadow:0 4px 15px rgba(0,0,0,0.3)">
                <div style="display:flex;align-items:center;justify-content:center;gap:8px;margin-bottom:10px">
                    <div id="${statusId}-icon" style="font-size:28px;animation:pulse 1s infinite">ğŸ“¡</div>
                    <div style="text-align:left">
                        <div style="font-weight:700;font-size:15px">è¶…ç²¾æº–å®šä½æ¨¡å¼</div>
                        <div id="${statusId}-phase" style="font-size:11px;opacity:0.8">åˆå§‹åŒ–è¡›æ˜Ÿé€£ç·š...</div>
                    </div>
                </div>
                <div style="background:rgba(255,255,255,0.1);border-radius:8px;padding:10px;margin-bottom:10px">
                    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;text-align:center;font-size:11px">
                        <div><div id="${statusId}-samples" style="font-size:18px;font-weight:700;color:#4ade80">0</div>å–æ¨£æ•¸</div>
                        <div><div id="${statusId}-accuracy" style="font-size:18px;font-weight:700;color:#fbbf24">--</div>ç•¶å‰ç²¾åº¦</div>
                        <div><div id="${statusId}-best" style="font-size:18px;font-weight:700;color:#60a5fa">--</div>æœ€ä½³ç²¾åº¦</div>
                    </div>
                </div>
                <div id="${statusId}-info" style="font-size:11px;margin-bottom:8px;opacity:0.9">æ­£åœ¨æ”¶é›†å®šä½æ•¸æ“š...</div>
                <div style="height:6px;background:rgba(255,255,255,0.2);border-radius:3px;overflow:hidden;margin-bottom:8px">
                    <div id="${statusId}-bar" style="width:0%;height:100%;background:linear-gradient(90deg,#4ade80,#22d3ee);transition:width 0.3s;border-radius:3px"></div>
                </div>
                <div id="${statusId}-quality" style="display:flex;justify-content:center;gap:4px;margin-bottom:10px">
                    <span class="quality-dot" style="width:8px;height:8px;border-radius:50%;background:#555"></span>
                    <span class="quality-dot" style="width:8px;height:8px;border-radius:50%;background:#555"></span>
                    <span class="quality-dot" style="width:8px;height:8px;border-radius:50%;background:#555"></span>
                    <span class="quality-dot" style="width:8px;height:8px;border-radius:50%;background:#555"></span>
                    <span class="quality-dot" style="width:8px;height:8px;border-radius:50%;background:#555"></span>
                </div>
                <div style="display:flex;gap:8px">
                    <button onclick="cancelGPS('${statusId}')" style="flex:1;padding:8px;background:rgba(239,68,68,0.3);border:1px solid rgba(239,68,68,0.5);border-radius:6px;color:#fff;cursor:pointer;font-size:12px">âŒ å–æ¶ˆ</button>
                    <button id="${statusId}-accept" onclick="acceptCurrentGPS('${statusId}')" style="flex:1;padding:8px;background:rgba(34,197,94,0.3);border:1px solid rgba(34,197,94,0.5);border-radius:6px;color:#fff;cursor:pointer;font-size:12px;display:none">âœ… ä½¿ç”¨ç›®å‰çµæœ</button>
                </div>
            </div>
            <style>@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}</style>`;
            
            const container = document.getElementById(latField).closest('.form-group').parentElement;
            const existingStatus = container.querySelector('[id^="gps-status-"]');
            if (existingStatus) existingStatus.remove();
            container.insertAdjacentHTML('beforeend', statusHtml);
            
            // å„²å­˜ç‹€æ…‹ä¾›å¤–éƒ¨å­˜å–
            window.gpsState = { samples, bestPosition, bestAccuracy, latField, lonField, statusId };
            
            const updateUI = (phase, info, progress, accuracy, best) => {
                const el = (id) => document.getElementById(`${statusId}-${id}`);
                if (el('phase')) el('phase').textContent = phase;
                if (el('info')) el('info').textContent = info;
                if (el('bar')) el('bar').style.width = progress + '%';
                if (el('samples')) el('samples').textContent = samples.length;
                if (el('accuracy')) el('accuracy').textContent = accuracy ? Math.round(accuracy) + 'm' : '--';
                if (el('best')) el('best').textContent = best < Infinity ? Math.round(best) + 'm' : '--';
                
                // æ›´æ–°å“è³ªæŒ‡ç¤ºç‡ˆ
                const dots = document.querySelectorAll(`#${statusId}-quality .quality-dot`);
                const quality = best <= 10 ? 5 : best <= 20 ? 4 : best <= 50 ? 3 : best <= 100 ? 2 : 1;
                dots.forEach((dot, i) => {
                    dot.style.background = i < quality ? (quality >= 4 ? '#4ade80' : quality >= 3 ? '#fbbf24' : '#ef4444') : '#555';
                });
                
                // é¡¯ç¤ºæ¥å—æŒ‰éˆ•ï¼ˆæœ‰è¶³å¤ æ¨£æœ¬æ™‚ï¼‰
                if (samples.length >= 3 && el('accept')) {
                    el('accept').style.display = 'block';
                }
            };
            
            const finishGPS = (success, lat, lon, accuracy, method = '') => {
                if (gpsWatchId) {
                    navigator.geolocation.clearWatch(gpsWatchId);
                    gpsWatchId = null;
                }
                const statusEl = document.getElementById(statusId);
                if (statusEl) statusEl.remove();
                window.gpsState = null;
                
                if (success && !gpsAborted) {
                    document.getElementById(latField).value = lat.toFixed(7);
                    document.getElementById(lonField).value = lon.toFixed(7);
                    const accLevel = accuracy <= 10 ? 'ğŸ¯ æ¥µé«˜' : accuracy <= 20 ? 'âœ… å„ªè‰¯' : accuracy <= 50 ? 'ğŸ‘ è‰¯å¥½' : accuracy <= 100 ? 'âš ï¸ ä¸€èˆ¬' : 'ğŸ“ ç²—ç•¥';
                    const methodText = method ? ` (${method})` : '';
                    toast(`å®šä½æˆåŠŸï¼ç²¾åº¦ç´„ ${Math.round(accuracy)} å…¬å°º ${accLevel}${methodText}`, accuracy <= 50 ? 'success' : 'warning');
                }
            };
            
            window.cancelGPS = (sid) => {
                gpsAborted = true;
                if (gpsWatchId) {
                    navigator.geolocation.clearWatch(gpsWatchId);
                    gpsWatchId = null;
                }
                const el = document.getElementById(sid);
                if (el) el.remove();
                window.gpsState = null;
                toast('å·²å–æ¶ˆå®šä½', 'warning');
            };
            
            window.acceptCurrentGPS = (sid) => {
                if (!window.gpsState || window.gpsState.samples.length === 0) {
                    toast('å°šç„¡å®šä½æ•¸æ“š', 'danger');
                    return;
                }
                const { samples, latField, lonField } = window.gpsState;
                const filtered = removeOutliers(samples);
                const weighted = calcWeightedAverage(filtered.length > 0 ? filtered : samples);
                const avgAcc = samples.reduce((s, p) => s + p.accuracy, 0) / samples.length;
                finishGPS(true, weighted.latitude, weighted.longitude, avgAcc, 'æ‰‹å‹•ç¢ºèª');
            };
            
            // ä½¿ç”¨ watchPosition æŒçºŒç›£è½
            gpsWatchId = navigator.geolocation.watchPosition(
                (pos) => {
                    if (gpsAborted) return;
                    
                    const { latitude, longitude, accuracy } = pos.coords;
                    const elapsed = Date.now() - startTime;
                    const progress = Math.min(95, (elapsed / GPS_CONFIG.maxWaitTime) * 100);
                    
                    // å¥—ç”¨å¡çˆ¾æ›¼æ¿¾æ³¢
                    const filteredLat = kalmanLat.filter(latitude);
                    const filteredLon = kalmanLon.filter(longitude);
                    
                    const sample = { 
                        latitude: filteredLat, 
                        longitude: filteredLon, 
                        rawLat: latitude,
                        rawLon: longitude,
                        accuracy, 
                        timestamp: Date.now() 
                    };
                    samples.push(sample);
                    
                    // æ›´æ–°æœ€ä½³ä½ç½®
                    if (accuracy < bestAccuracy) {
                        bestAccuracy = accuracy;
                        bestPosition = { latitude: filteredLat, longitude: filteredLon, accuracy };
                    }
                    
                    // æª¢æŸ¥ç©©å®šæ€§
                    if (lastPosition) {
                        const dist = calcGPSDistance(lastPosition.latitude, lastPosition.longitude, filteredLat, filteredLon);
                        if (dist < GPS_CONFIG.stableDistance && accuracy < 50) {
                            stableCount++;
                        } else {
                            stableCount = Math.max(0, stableCount - 1);
                        }
                    }
                    lastPosition = { latitude: filteredLat, longitude: filteredLon };
                    
                    // åˆ¤å®šéšæ®µ
                    let phase = 'æ”¶é›†è¡›æ˜Ÿä¿¡è™Ÿ...';
                    if (samples.length >= 3) phase = 'åˆ†æå®šä½æ•¸æ“š...';
                    if (samples.length >= 8) phase = 'å„ªåŒ–ç²¾ç¢ºåº¦...';
                    if (stableCount >= 2) phase = 'ä½ç½®å·²ç©©å®šï¼';
                    if (accuracy <= GPS_CONFIG.targetAccuracy) phase = 'é«˜ç²¾åº¦é–å®šä¸­...';
                    
                    updateUI(
                        phase,
                        `å·²æ”¶é›† ${samples.length} å€‹å®šä½é» | ç©©å®šåº¦: ${Math.min(100, stableCount * 25)}%`,
                        progress,
                        accuracy,
                        bestAccuracy
                    );
                    
                    // æ¢ä»¶1: æ¥µä½³ç²¾åº¦ï¼Œç«‹å³å®Œæˆ
                    if (accuracy <= GPS_CONFIG.excellentAccuracy && samples.length >= 2) {
                        finishGPS(true, filteredLat, filteredLon, accuracy, 'æ¥µé«˜ç²¾åº¦');
                        return;
                    }
                    
                    // æ¢ä»¶2: é”åˆ°ç›®æ¨™ç²¾åº¦ + è¶³å¤ æ¨£æœ¬ + ç©©å®š
                    if (accuracy <= GPS_CONFIG.targetAccuracy && samples.length >= GPS_CONFIG.minSamples && stableCount >= GPS_CONFIG.stableThreshold) {
                        const filtered = removeOutliers(samples);
                        const weighted = calcWeightedAverage(filtered);
                        finishGPS(true, weighted.latitude, weighted.longitude, accuracy, 'ç©©å®šé–å®š');
                        return;
                    }
                    
                    // æ¢ä»¶3: é”åˆ°æœ€å¤§æ¨£æœ¬æ•¸
                    if (samples.length >= GPS_CONFIG.maxSamples) {
                        const filtered = removeOutliers(samples);
                        const weighted = calcWeightedAverage(filtered.length > 0 ? filtered : samples);
                        const avgAcc = filtered.reduce((s, p) => s + p.accuracy, 0) / filtered.length;
                        finishGPS(true, weighted.latitude, weighted.longitude, Math.min(bestAccuracy, avgAcc), 'çµ±è¨ˆå„ªåŒ–');
                        return;
                    }
                },
                (err) => {
                    if (gpsAborted) return;
                    console.error('GPS éŒ¯èª¤:', err);
                    
                    if (samples.length > 0) {
                        const filtered = removeOutliers(samples);
                        const weighted = calcWeightedAverage(filtered.length > 0 ? filtered : samples);
                        const avgAcc = samples.reduce((s, p) => s + p.accuracy, 0) / samples.length;
                        finishGPS(true, weighted.latitude, weighted.longitude, Math.min(bestAccuracy, avgAcc), 'éƒ¨åˆ†æ•¸æ“š');
                    } else {
                        finishGPS(false);
                        let errMsg = 'å®šä½å¤±æ•—';
                        if (err.code === 1) errMsg = 'è«‹å…è¨±ä½ç½®å­˜å–æ¬Šé™';
                        else if (err.code === 2) errMsg = 'ç„¡æ³•å–å¾—ä½ç½®ï¼Œè«‹ç¢ºèª GPS å·²é–‹å•Ÿ';
                        else if (err.code === 3) errMsg = 'å®šä½é€¾æ™‚ï¼Œè«‹ç§»è‡³é–‹é—Šè™•é‡è©¦';
                        toast(errMsg, 'danger');
                    }
                },
                {
                    enableHighAccuracy: true,
                    timeout: GPS_CONFIG.maxWaitTime,
                    maximumAge: 0
                }
            );
            
            // è¶…æ™‚è™•ç†
            setTimeout(() => {
                if (gpsWatchId && !gpsAborted) {
                    if (samples.length >= GPS_CONFIG.minSamples) {
                        const filtered = removeOutliers(samples);
                        const weighted = calcWeightedAverage(filtered.length > 0 ? filtered : samples);
                        const avgAcc = filtered.length > 0 
                            ? filtered.reduce((s, p) => s + p.accuracy, 0) / filtered.length 
                            : samples.reduce((s, p) => s + p.accuracy, 0) / samples.length;
                        finishGPS(true, weighted.latitude, weighted.longitude, Math.min(bestAccuracy, avgAcc), 'æ™‚é–“å„ªåŒ–');
                    } else if (bestPosition) {
                        finishGPS(true, bestPosition.latitude, bestPosition.longitude, bestPosition.accuracy, 'æœ€ä½³å–æ¨£');
                    } else {
                        finishGPS(false);
                        toast('å®šä½é€¾æ™‚ï¼Œè«‹åˆ°æˆ¶å¤–æˆ–çª—é‚Šé‡è©¦', 'danger');
                    }
                }
            }, GPS_CONFIG.maxWaitTime + 2000);
        }
        
        function getLocationForEdit() {
            getHighAccuracyPosition('edit-course-lat', 'edit-course-lon', true);
        }
        
        async function deleteCourse() {
            if (!confirm('ç¢ºå®šåˆªé™¤æ­¤èª²ç¨‹ï¼Ÿ')) return;
            const r = await api('/api/courses/' + currentCourse.id, { method: 'DELETE' });
            if (r?.success) {
                toast('èª²ç¨‹å·²åˆªé™¤ï¼'); 
                closeModal('editCourse'); 
                loadCourses();
            } else {
                toast('åˆªé™¤å¤±æ•—', 'danger');
            }
        }
        
        function getLocation() {
            getHighAccuracyPosition('course-lat', 'course-lon', false);
        }
        
        // === Google Maps åº§æ¨™è§£æ ===
        function parseGoogleMapsUrl() {
            const url = prompt('è«‹è²¼ä¸Š Google Maps é€£çµæˆ–åº§æ¨™ï¼š\n\nä¾‹å¦‚ï¼š\nâ€¢ 22.6267, 120.3565\nâ€¢ https://www.google.com/maps/@22.6267,120.3565,17z\nâ€¢ https://goo.gl/maps/...');
            if (!url) return;
            
            const coords = extractCoordinates(url);
            if (coords) {
                document.getElementById('course-lat').value = coords.lat;
                document.getElementById('course-lon').value = coords.lon;
                toast(`å·²è¨­å®šåº§æ¨™ï¼š${coords.lat}, ${coords.lon}`);
            } else {
                toast('ç„¡æ³•è§£æåº§æ¨™ï¼Œè«‹ç¢ºèªæ ¼å¼', 'danger');
            }
        }
        function parseGoogleMapsUrlForEdit() {
            const url = prompt('è«‹è²¼ä¸Š Google Maps é€£çµæˆ–åº§æ¨™ï¼š\n\nä¾‹å¦‚ï¼š\nâ€¢ 22.6267, 120.3565\nâ€¢ https://www.google.com/maps/@22.6267,120.3565,17z');
            if (!url) return;
            
            const coords = extractCoordinates(url);
            if (coords) {
                document.getElementById('edit-course-lat').value = coords.lat;
                document.getElementById('edit-course-lon').value = coords.lon;
                toast(`å·²è¨­å®šåº§æ¨™ï¼š${coords.lat}, ${coords.lon}`);
            } else {
                toast('ç„¡æ³•è§£æåº§æ¨™ï¼Œè«‹ç¢ºèªæ ¼å¼', 'danger');
            }
        }
        function extractCoordinates(input) {
            // å˜—è©¦è§£æå„ç¨®æ ¼å¼
            let lat, lon;
            
            // æ ¼å¼1: ç´”åº§æ¨™ "22.6267, 120.3565" æˆ– "22.6267,120.3565"
            const simpleMatch = input.match(/(-?\d+\.?\d*)\s*,\s*(-?\d+\.?\d*)/);
            if (simpleMatch) {
                lat = parseFloat(simpleMatch[1]);
                lon = parseFloat(simpleMatch[2]);
            }
            
            // æ ¼å¼2: Google Maps URL /@lat,lon,zoom
            const urlMatch = input.match(/@(-?\d+\.?\d*),(-?\d+\.?\d*)/);
            if (urlMatch) {
                lat = parseFloat(urlMatch[1]);
                lon = parseFloat(urlMatch[2]);
            }
            
            // æ ¼å¼3: Google Maps place URL /place/.../@lat,lon
            const placeMatch = input.match(/place\/[^/]+\/@(-?\d+\.?\d*),(-?\d+\.?\d*)/);
            if (placeMatch) {
                lat = parseFloat(placeMatch[1]);
                lon = parseFloat(placeMatch[2]);
            }
            
            // æ ¼å¼4: Google Maps !3d lat !4d lon
            const embedMatch = input.match(/!3d(-?\d+\.?\d*).*?!4d(-?\d+\.?\d*)/);
            if (embedMatch) {
                lat = parseFloat(embedMatch[1]);
                lon = parseFloat(embedMatch[2]);
            }
            
            // é©—è­‰åº§æ¨™ç¯„åœ
            if (lat && lon && lat >= -90 && lat <= 90 && lon >= -180 && lon <= 180) {
                return { lat: lat.toFixed(6), lon: lon.toFixed(6) };
            }
            return null;
        }

        // === å­¸ç”Ÿç®¡ç† ===
        async function loadStudents() {
            const filter = document.getElementById('student-filter')?.value || '';
            const data = await api('/api/students');
            if (data) {
                students = filter ? data.filter(s => s.classCode === filter) : data;
                renderStudents();
            }
        }
        function renderStudents() {
            document.getElementById('students-list').innerHTML = students.length ? students.map(s =>
                '<div class="item-card" onclick="editStudent(\'' + s.studentId + '\')">' +
                '<div class="icon" style="background:var(--primary)">' + (s.name ? s.name.charAt(0) : '?') + '</div>' +
                '<div class="info"><h5>' + s.studentId + ' - ' + s.name + '</h5><span>' + s.classCode + (s.lineId ? ' Â· LINE å·²ç¶å®š' : '') + '</span></div></div>'
            ).join('') : '<div class="empty">å°šç„¡å­¸ç”Ÿ</div>';
        }
        async function addStudent() {
            const studentId = document.getElementById('student-id').value.trim();
            const name = document.getElementById('student-name').value.trim();
            const classCode = document.getElementById('student-class').value;
            const phone = document.getElementById('student-phone').value.trim();
            const parentPhone = document.getElementById('student-parent-phone').value.trim();
            if (!studentId || !name || !classCode) { toast('è«‹å¡«å¯«å­¸è™Ÿã€å§“åå’Œç­ç´š', 'danger'); return; }
            const r = await api('/api/students', { method: 'POST', body: JSON.stringify({ studentId, name, classCode, phone, parentPhone }) });
            if (r?.success) { toast('å­¸ç”Ÿå·²æ–°å¢ï¼'); closeModal('addStudent'); loadStudents(); document.getElementById('student-id').value = ''; document.getElementById('student-name').value = ''; document.getElementById('student-phone').value = ''; document.getElementById('student-parent-phone').value = ''; }
            else { toast(r?.message || 'æ–°å¢å¤±æ•—', 'danger'); }
        }
        function editStudent(id) {
            currentStudent = students.find(s => s.studentId === id);
            if (!currentStudent) return;
            document.getElementById('edit-student-id').value = currentStudent.studentId;
            document.getElementById('edit-student-name').value = currentStudent.name;
            document.getElementById('edit-student-class').value = currentStudent.classCode;
            document.getElementById('edit-student-phone').value = currentStudent.phone || '';
            document.getElementById('edit-student-parent-phone').value = currentStudent.parentPhone || '';
            openModal('editStudent');
        }
        async function saveStudent() {
            const name = document.getElementById('edit-student-name').value.trim();
            const classCode = document.getElementById('edit-student-class').value;
            const phone = document.getElementById('edit-student-phone').value.trim();
            const parentPhone = document.getElementById('edit-student-parent-phone').value.trim();
            const r = await api('/api/students/' + currentStudent.studentId, { method: 'PUT', body: JSON.stringify({ name, classCode, phone, parentPhone }) });
            if (r?.success) { toast('å­¸ç”Ÿå·²æ›´æ–°ï¼'); closeModal('editStudent'); loadStudents(); }
        }
        async function deleteStudent() {
            if (!confirm('ç¢ºå®šåˆªé™¤å­¸ç”Ÿ ' + currentStudent.name + 'ï¼Ÿ')) return;
            await api('/api/students/' + currentStudent.studentId, { method: 'DELETE' });
            toast('å­¸ç”Ÿå·²åˆªé™¤ï¼'); closeModal('editStudent'); loadStudents();
        }

        // === ç°½åˆ°ç®¡ç† ===
        async function loadSessions() {
            const now = new Date();
            document.getElementById('session-date').textContent = now.toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });
            const dow = now.getDay();
            console.log('ä»Šå¤©æ˜ŸæœŸ:', dow, 'èª²ç¨‹æ•¸:', courses.length);
            const today = courses.filter(c => {
                console.log('æª¢æŸ¥èª²ç¨‹:', c.name || c.subject, 'æ˜ŸæœŸ:', c.day, 'åŒ¹é…:', c.day == dow);
                return c.day == dow;
            });
            console.log('ä»Šæ—¥èª²ç¨‹:', today);
            if (!today.length) {
                document.getElementById('sessions-list').innerHTML = '<div class="empty"><div class="icon">ğŸ“…</div><h3>ä»Šæ—¥ç„¡èª²ç¨‹</h3><p style="color:var(--text-light);margin-top:10px">è«‹å…ˆåœ¨èª²è¡¨ç®¡ç†æ–°å¢ä»Šå¤©ï¼ˆæ˜ŸæœŸ' + DAY_NAMES[dow] + 'ï¼‰çš„èª²ç¨‹</p></div>';
                return;
            }
            document.getElementById('sessions-list').innerHTML = today.map(c => {
                const p = ((sem.periods && sem.periods.length > 0 ? sem.periods : PERIODS[sem.div || "day"])).find(x => x.n == c.period) || { s: '', e: '' };
                const nowTime = now.getHours() * 60 + now.getMinutes();
                const endTime = parseInt((p.e || '17:00').split(':')[0]) * 60 + parseInt((p.e || '17:00').split(':')[1] || 0);
                const completed = nowTime > endTime;
                return '<div class="session-item' + (completed ? ' completed' : '') + '"><div class="session-header"><div class="session-icon">ğŸ“–</div><div class="session-info"><h4>' + (c.name || c.subject) + ' - ' + c.classCode + '</h4><span>ç¬¬' + c.period + 'ç¯€ Â· ' + p.s + '-' + p.e + ' Â· ' + (c.room || 'æ•™å®¤') + '</span></div></div><div class="session-actions">' + (completed ? '<button class="btn btn-outline btn-sm" disabled>å·²çµæŸ</button>' : '<button class="btn btn-primary btn-sm" onclick="startSession(\'' + c.id + '\')">ğŸ“± ç°½åˆ°</button><button class="btn btn-success btn-sm" onclick="sendReminder(\'' + c.id + '\')">ğŸ“¢ é€šçŸ¥</button><button class="btn btn-outline btn-sm" onclick="endSession(\'' + c.id + '\')">â¹ï¸ çµæŸ</button>') + '</div></div>';
            }).join('');
        }
        let currentSessionId = null;
        let currentSessionCourseId = null;
        
        async function startSession(id) {
            const c = courses.find(x => x.id === id);
            if (!c) {
                toast('æ‰¾ä¸åˆ°èª²ç¨‹', 'danger');
                return;
            }
            const today = new Date().toISOString().split('T')[0];
            const p = ((sem.periods && sem.periods.length > 0 ? sem.periods : PERIODS[sem.div || "day"])).find(x => x.n == c.period) || { s: '08:00', e: '09:00' };
            console.log('å»ºç«‹ç°½åˆ°:', { courseId: id, date: today, startTime: p.s, endTime: p.e });
            
            const r = await api('/api/sessions', { method: 'POST', body: JSON.stringify({ courseId: id, date: today, startTime: p.s, endTime: p.e }) });
            console.log('API å›æ‡‰:', r);
            
            if (r?.success && r.qrContent) {
                currentSessionId = r.sessionId;
                currentSessionCourseId = id;
                currentGpsCheckinCode = r.gpsCheckinCode;
                showQR(r.qrContent, r.gpsCheckinCode, (c.name || c.subject) + ' - ' + c.classCode, today + ' ' + p.s);
                toast('ç°½åˆ°å·²å»ºç«‹ï¼');
            } else {
                toast(r?.error || 'å»ºç«‹ç°½åˆ°å¤±æ•—', 'danger');
            }
        }
        
        async function sendReminder(courseId) {
            // å…ˆç¢ºä¿æœ‰ç°½åˆ°æ´»å‹•
            if (!currentSessionId || currentSessionCourseId !== courseId) {
                // å»ºç«‹æ–°çš„ç°½åˆ°æ´»å‹•
                const c = courses.find(x => x.id === courseId);
                if (!c) { toast('æ‰¾ä¸åˆ°èª²ç¨‹', 'danger'); return; }
                
                const today = new Date().toISOString().split('T')[0];
                const p = ((sem.periods && sem.periods.length > 0 ? sem.periods : PERIODS[sem.div || "day"])).find(x => x.n == c.period) || { s: '08:00', e: '09:00' };
                
                const r = await api('/api/sessions', { method: 'POST', body: JSON.stringify({ courseId: courseId, date: today, startTime: p.s, endTime: p.e }) });
                if (r?.success) {
                    currentSessionId = r.sessionId;
                    currentSessionCourseId = courseId;
                } else {
                    toast('å»ºç«‹ç°½åˆ°å¤±æ•—', 'danger');
                    return;
                }
            }
            
            // ç™¼é€ä¸Šèª²æé†’ï¼ˆé™„å¸¶ç°½åˆ°é€£çµï¼‰
            toast('æ­£åœ¨ç™¼é€é€šçŸ¥...');
            const r = await api('/api/notify/remind', { 
                method: 'POST', 
                body: JSON.stringify({ 
                    courseId: courseId, 
                    sessionId: currentSessionId 
                }) 
            });
            
            if (r?.success) {
                toast('å·²ç™¼é€ ' + r.sent + ' å‰‡é€šçŸ¥ï¼');
            } else {
                toast(r?.message || 'ç™¼é€å¤±æ•—', 'danger');
            }
        }
        
        async function endSession(id) {
            if (!confirm('ç¢ºå®šçµæŸï¼Ÿæœªç°½åˆ°å­¸ç”Ÿå°‡è¢«æ¨™è¨˜ç‚ºç¼ºå¸­ã€‚')) return;
            const r = await api('/api/sessions/' + id + '/complete', { method: 'POST' });
            if (r?.success) { 
                toast('å·²çµæŸï¼Œ' + (r.marked || 0) + ' äººç¼ºå¸­'); 
                currentSessionId = null;
                currentSessionCourseId = null;
                loadSessions(); 
            }
            else { toast('çµæŸå¤±æ•—', 'danger'); }
        }
        
        let currentQRUrl = '';
        let currentGpsUrl = '';
        let currentGpsCheckinCode = '';
        
        function showQR(directContent, gpsContent, name, time) {
            console.log('é¡¯ç¤º QR Code:', { directContent, gpsContent, name, time, BOT });
            
            // è¨­å®šæ–‡å­—
            document.getElementById('qr-name').textContent = name;
            document.getElementById('qr-time').textContent = time;
            
            // æ¸…ç©ºèˆŠçš„ QR Code
            const container = document.getElementById('qr-container');
            container.innerHTML = '';
            
            // å»ºç«‹é€£çµ
            const botId = BOT;
            // è€å¸«æ‰‹æ©Ÿ QR Codeï¼ˆç›´æ¥ç°½åˆ°ï¼‰
            currentQRUrl = 'https://line.me/R/oaMessage/' + botId + '/?' + encodeURIComponent(directContent);
            // å­¸ç”Ÿé€£çµï¼ˆGPS ç°½åˆ°ï¼‰
            currentGpsUrl = 'https://line.me/R/oaMessage/' + botId + '/?' + encodeURIComponent(gpsContent);
            
            // é¡¯ç¤ºå­¸ç”Ÿ GPS ç°½åˆ°é€£çµ
            document.getElementById('qr-link').value = currentGpsUrl;
            document.getElementById('qr-link-box').style.display = 'block';
            
            // é–‹å•Ÿ modal
            openModal('qr');
            
            // ç”Ÿæˆ QR Codeï¼ˆè€å¸«æ‰‹æ©Ÿç”¨ï¼Œç›´æ¥ç°½åˆ°ï¼‰
            setTimeout(() => {
                try {
                    console.log('QR URL (ç›´æ¥ç°½åˆ°):', currentQRUrl);
                    console.log('å­¸ç”Ÿé€£çµ (GPSç°½åˆ°):', currentGpsUrl);
                    
                    new QRCode(container, {
                        text: currentQRUrl,
                        width: 200,
                        height: 200,
                        colorDark: '#000000',
                        colorLight: '#ffffff',
                        correctLevel: QRCode.CorrectLevel.H
                    });
                    console.log('QR Code ç”¢ç”ŸæˆåŠŸ');
                } catch (e) {
                    console.error('QR Code éŒ¯èª¤:', e);
                    container.innerHTML = '<p style="color:red;text-align:center">QR Code ç”¢ç”Ÿå¤±æ•—<br>' + e.message + '</p>';
                }
            }, 100);
        }
        
        function copyQRLink() {
            const input = document.getElementById('qr-link');
            input.select();
            document.execCommand('copy');
            toast('é€£çµå·²è¤‡è£½ï¼');
        }
        
        async function sendReminderFromQR() {
            if (!currentSessionCourseId || !currentSessionId) {
                toast('è«‹å…ˆå»ºç«‹ç°½åˆ°æ´»å‹•', 'danger');
                return;
            }
            
            toast('æ­£åœ¨ç™¼é€é€šçŸ¥...');
            const r = await api('/api/notify/remind', { 
                method: 'POST', 
                body: JSON.stringify({ 
                    courseId: currentSessionCourseId, 
                    sessionId: currentSessionId 
                }) 
            });
            
            if (r?.success) {
                toast('å·²ç™¼é€ ' + r.sent + ' å‰‡é€šçŸ¥ï¼');
            } else {
                toast(r?.message || 'ç™¼é€å¤±æ•—', 'danger');
            }
        }
        
        function downloadQR() {
            const container = document.getElementById('qr-container');
            const img = container.querySelector('img');
            const canvas = container.querySelector('canvas');
            
            if (img) {
                const link = document.createElement('a');
                link.download = 'qrcode.png';
                link.href = img.src;
                link.click();
                toast('å·²ä¸‹è¼‰ï¼');
            } else if (canvas) {
                const link = document.createElement('a');
                link.download = 'qrcode.png';
                link.href = canvas.toDataURL();
                link.click();
                toast('å·²ä¸‹è¼‰ï¼');
            } else {
                toast('æ‰¾ä¸åˆ° QR Code åœ–ç‰‡', 'danger');
            }
        }

        // === è«‹å‡ç®¡ç† ===
        async function loadLeaves() {
            const data = await api('/api/leaves');
            if (data) {
                leaves = data;
                const pending = leaves.filter(l => l.status === 'å¾…å¯©æ ¸').length;
                const badge = document.getElementById('leave-badge');
                badge.style.display = pending > 0 ? 'inline' : 'none';
                badge.textContent = pending;
                renderLeaves();
            }
        }
        function filterLeaves(filter) {
            leaveFilter = filter;
            document.querySelectorAll('#page-leaves .tab').forEach((t, i) => {
                const filters = ['pending', 'approved', 'rejected', 'all'];
                t.classList.toggle('active', filters[i] === filter);
            });
            renderLeaves();
        }
        function renderLeaves() {
            let filtered = leaves;
            if (leaveFilter === 'pending') filtered = leaves.filter(l => l.status === 'å¾…å¯©æ ¸');
            else if (leaveFilter === 'approved') filtered = leaves.filter(l => l.status === 'å·²æ ¸å‡†');
            else if (leaveFilter === 'rejected') filtered = leaves.filter(l => l.status === 'å·²é§å›');
            document.getElementById('leaves-list').innerHTML = filtered.length ? filtered.map(l => {
                const badge = l.status === 'å¾…å¯©æ ¸' ? 'warning' : l.status === 'å·²æ ¸å‡†' ? 'success' : 'danger';
                return '<div class="leave-item ' + l.status.replace('å·²', '').toLowerCase() + '"><div style="display:flex;justify-content:space-between;margin-bottom:8px"><b>' + l.name + ' (' + l.studentId + ')</b><span class="badge ' + badge + '">' + l.status + '</span></div><div style="font-size:14px;color:var(--text-light);margin-bottom:10px">ğŸ“… ' + l.date + ' Â· ç¬¬' + l.periods + 'ç¯€<br>ğŸ“ ' + l.type + 'ï¼š' + (l.reason || 'ç„¡èªªæ˜') + '</div>' + (l.status === 'å¾…å¯©æ ¸' ? '<button class="btn btn-sm btn-success" onclick="openReviewLeave(\'' + l.id + '\')">å¯©æ ¸</button>' : '') + '</div>';
            }).join('') : '<div class="empty">ç„¡è«‹å‡ç´€éŒ„</div>';
        }
        function openReviewLeave(id) {
            currentLeave = leaves.find(l => l.id === id);
            if (!currentLeave) return;
            document.getElementById('leave-detail').innerHTML = '<div class="alert alert-info"><b>' + currentLeave.name + '</b> (' + currentLeave.studentId + ')<br>ğŸ“… ' + currentLeave.date + ' Â· ç¬¬' + currentLeave.periods + 'ç¯€<br>ğŸ“ ' + currentLeave.type + 'ï¼š' + (currentLeave.reason || 'ç„¡') + '</div>';
            document.getElementById('review-note').value = '';
            openModal('reviewLeave');
        }
        async function reviewLeave(status) {
            if (!currentLeave) return;
            const note = document.getElementById('review-note').value.trim();
            const r = await api('/api/leaves/' + currentLeave.id, { method: 'PUT', body: JSON.stringify({ status, note }) });
            if (r?.success) { toast(status === 'å·²æ ¸å‡†' ? 'å·²æ ¸å‡†ï¼' : 'å·²é§å›ï¼'); closeModal('reviewLeave'); loadLeaves(); }
        }

        // === å‡ºç¼ºç´€éŒ„ ===
        async function loadRecords() {
            const data = await api('/api/records');
            document.getElementById('records-table').innerHTML = data?.length ? data.slice(-50).reverse().map(r => {
                const badge = r.status === 'å·²å ±åˆ°' ? 'success' : r.status === 'é²åˆ°' ? 'warning' : 'danger';
                return '<tr><td>' + (r.date || '-') + '</td><td>' + r.studentId + '</td><td>' + (r.studentName || '-') + '</td><td><span class="badge ' + badge + '">' + r.status + '</span></td></tr>';
            }).join('') : '<tr><td colspan="4" class="empty">å°šç„¡ç´€éŒ„</td></tr>';
        }
        async function addRecord() {
            const studentId = document.getElementById('record-student').value.trim();
            const date = document.getElementById('record-date').value;
            const status = document.getElementById('record-status').value;
            const note = document.getElementById('record-note').value.trim();
            if (!studentId || !date) { toast('è«‹å¡«å¯«å­¸è™Ÿå’Œæ—¥æœŸ', 'danger'); return; }
            const r = await api('/api/records/manual', { method: 'POST', body: JSON.stringify({ studentId, date, status, note }) });
            if (r?.success) { toast('ç´€éŒ„å·²æ–°å¢ï¼'); closeModal('addRecord'); loadRecords(); }
        }

        // === çµ±è¨ˆ ===
        async function loadStats() {
            const data = await api('/api/stats/attendance');
            if (data) {
                document.getElementById('overall-rate').textContent = data.overall + '%';
                document.getElementById('stats-attended').textContent = data.attended || 0;
                document.getElementById('stats-late').textContent = data.late || 0;
                document.getElementById('stats-absent').textContent = data.absent || 0;
                document.getElementById('stats-total').textContent = data.totalRecords || 0;
                const offset = 327 - 327 * (data.overall / 100);
                document.getElementById('progress-circle').style.strokeDashoffset = offset;
                const low = data.lowAttendance || [];
                document.getElementById('low-attendance-list').innerHTML = low.length ? low.slice(0, 10).map(s => '<div class="student-alert ' + (s.rate < 60 ? 'critical' : 'warning') + '"><div class="avatar">' + s.name.charAt(0) + '</div><div class="info"><h5>' + s.name + ' (' + s.studentId + ')</h5><span>' + s.classCode + ' Â· å‡ºå¸­ç‡ ' + s.rate + '%</span></div></div>').join('') : '<div class="empty">æ‰€æœ‰å­¸ç”Ÿå‡ºå¸­ç‡è‰¯å¥½ ğŸ‘</div>';
            }
        }

        // === è­¦ç¤º ===
        async function loadAlerts() {
            const data = await api('/api/stats/consecutive-absent');
            if (data?.alerts) {
                document.getElementById('alert-list').innerHTML = data.alerts.length ? data.alerts.map(s => '<div class="student-alert ' + (s.level === 'critical' ? 'critical' : 'warning') + '"><div class="avatar">' + s.name.charAt(0) + '</div><div class="info"><h5>' + s.name + ' (' + s.studentId + ')</h5><span>' + s.classCode + ' Â· é€£çºŒç¼ºå¸­ <b>' + s.consecutiveAbsent + '</b> æ¬¡</span></div><button class="btn btn-sm btn-danger" onclick="sendWarning(\'' + s.studentId + '\',' + s.consecutiveAbsent + ')">ğŸ“² é€šçŸ¥</button></div>').join('') : '<div class="empty">ç›®å‰æ²’æœ‰é€£çºŒç¼ºå¸­çš„å­¸ç”Ÿ âœ¨</div>';
            }
        }
        async function sendWarning(id, count) {
            const r = await api('/api/notify/warning', { method: 'POST', body: JSON.stringify({ studentId: id, consecutiveCount: count }) });
            toast(r?.success ? 'è­¦å‘Šå·²ç™¼é€ï¼' : 'ç™¼é€å¤±æ•—', r?.success ? 'success' : 'danger');
        }
        async function sendAllWarnings() {
            const data = await api('/api/stats/consecutive-absent');
            if (data?.alerts) {
                for (const s of data.alerts) {
                    await api('/api/notify/warning', { method: 'POST', body: JSON.stringify({ studentId: s.studentId, consecutiveCount: s.consecutiveAbsent }) });
                }
                toast('å·²ç™¼é€ ' + data.alerts.length + ' å‰‡è­¦å‘Šï¼');
            }
        }

        // === å„€è¡¨æ¿ ===
        async function loadDashboard() {
            const now = new Date();
            document.getElementById('today-info').textContent = now.toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });
            const data = await api('/api/dashboard');
            if (data) {
                document.getElementById('stat-students').textContent = data.totalStudents || 0;
                document.getElementById('stat-attended').textContent = data.todayAttended || 0;
                document.getElementById('stat-late').textContent = data.todayLate || 0;
                document.getElementById('stat-absent').textContent = data.todayAbsent || 0;
            }
            const dow = now.getDay();
            const today = courses.filter(c => c.day == dow);
            document.getElementById('today-classes').innerHTML = today.length ? today.map(c => {
                const p = ((sem.periods && sem.periods.length > 0 ? sem.periods : PERIODS[sem.div || "day"])).find(x => x.n == c.period) || { s: '', e: '' };
                return '<div style="padding:10px;border:1px solid var(--border);border-radius:10px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center"><div><b>' + (c.name || c.subject) + '</b> - ' + c.classCode + '<br><small>ç¬¬' + c.period + 'ç¯€ ' + p.s + '-' + p.e + '</small></div><button class="btn btn-primary btn-sm" onclick="startSession(\'' + c.id + '\')">ğŸ“±</button></div>';
            }).join('') : '<div class="empty">ä»Šæ—¥ç„¡èª²ç¨‹</div>';
            const alerts = await api('/api/stats/consecutive-absent');
            document.getElementById('dashboard-alerts').innerHTML = alerts?.alerts?.length ? alerts.alerts.slice(0, 3).map(s => '<div style="padding:8px 0;border-bottom:1px solid var(--border)">âš ï¸ ' + s.name + ' é€£çºŒç¼ºå¸­ ' + s.consecutiveAbsent + ' æ¬¡</div>').join('') : '<div class="empty">ç„¡ç•°å¸¸ âœ¨</div>';
        }

        // === è¨­å®š ===
        async function testConn() {
            const url = document.getElementById('api-url').value.trim();
            if (!url) { toast('è«‹è¼¸å…¥ç¶²å€', 'danger'); return; }
            toast('æ¸¬è©¦ä¸­...', 'warning');
            try {
                const res = await fetch(url + '/api/health');
                if (res.ok) {
                    API = url;
                    localStorage.setItem('apiUrl', url);
                    document.getElementById('status-dot').classList.add('connected');
                    toast('é€£ç·šæˆåŠŸï¼');
                    loadAll();
                } else throw new Error();
            } catch { toast('é€£ç·šå¤±æ•—', 'danger'); }
        }
        function saveBotId() {
            BOT = document.getElementById('bot-id').value.trim() || '@bot';
            localStorage.setItem('botId', BOT);
            toast('Bot ID å·²å„²å­˜ï¼');
        }
        
        // === æ¸¬è©¦é©—è­‰åŠŸèƒ½ ===
        async function testSemesterEndNotify() {
            const classCode = document.getElementById('test-class').value;
            if (!classCode) { toast('è«‹é¸æ“‡æ¸¬è©¦ç­ç´š', 'danger'); return; }
            if (!confirm('ç¢ºå®šç™¼é€ã€Œå­¸æœŸçµæŸé€šçŸ¥ã€çµ¦ ' + classCode + ' ç­ç´šæ‰€æœ‰å­¸ç”Ÿï¼Ÿ')) return;
            toast('ç™¼é€ä¸­...', 'warning');
            const r = await api('/api/test/semester-end', { method: 'POST', body: JSON.stringify({ classCode }) });
            if (r?.success) {
                toast('å·²ç™¼é€ ' + r.count + ' å‰‡å­¸æœŸçµæŸé€šçŸ¥ï¼');
            } else {
                toast(r?.message || 'ç™¼é€å¤±æ•—', 'danger');
            }
        }
        async function testCheckinNotify() {
            const classCode = document.getElementById('test-class').value;
            if (!classCode) { toast('è«‹é¸æ“‡æ¸¬è©¦ç­ç´š', 'danger'); return; }
            if (!confirm('ç¢ºå®šç™¼é€ã€Œç°½åˆ°æˆåŠŸé€šçŸ¥ã€çµ¦ ' + classCode + ' ç­ç´šæ‰€æœ‰å­¸ç”Ÿï¼Ÿ')) return;
            toast('ç™¼é€ä¸­...', 'warning');
            const r = await api('/api/test/checkin-notify', { method: 'POST', body: JSON.stringify({ classCode, status: 'å·²å ±åˆ°' }) });
            if (r?.success) {
                toast('å·²ç™¼é€ ' + r.count + ' å‰‡ç°½åˆ°æˆåŠŸé€šçŸ¥ï¼');
            } else {
                toast(r?.message || 'ç™¼é€å¤±æ•—', 'danger');
            }
        }
        async function testLateNotify() {
            const classCode = document.getElementById('test-class').value;
            if (!classCode) { toast('è«‹é¸æ“‡æ¸¬è©¦ç­ç´š', 'danger'); return; }
            if (!confirm('ç¢ºå®šç™¼é€ã€Œé²åˆ°é€šçŸ¥ã€çµ¦ ' + classCode + ' ç­ç´šæ‰€æœ‰å­¸ç”Ÿï¼Ÿ')) return;
            toast('ç™¼é€ä¸­...', 'warning');
            const r = await api('/api/test/checkin-notify', { method: 'POST', body: JSON.stringify({ classCode, status: 'é²åˆ°', lateMinutes: 15 }) });
            if (r?.success) {
                toast('å·²ç™¼é€ ' + r.count + ' å‰‡é²åˆ°é€šçŸ¥ï¼');
            } else {
                toast(r?.message || 'ç™¼é€å¤±æ•—', 'danger');
            }
        }
        async function testAbsentNotify() {
            const classCode = document.getElementById('test-class').value;
            if (!classCode) { toast('è«‹é¸æ“‡æ¸¬è©¦ç­ç´š', 'danger'); return; }
            if (!confirm('ç¢ºå®šç™¼é€ã€Œç¼ºå¸­é€šçŸ¥ã€çµ¦ ' + classCode + ' ç­ç´šæ‰€æœ‰å­¸ç”Ÿï¼Ÿ')) return;
            toast('ç™¼é€ä¸­...', 'warning');
            const r = await api('/api/test/checkin-notify', { method: 'POST', body: JSON.stringify({ classCode, status: 'ç¼ºå¸­' }) });
            if (r?.success) {
                toast('å·²ç™¼é€ ' + r.count + ' å‰‡ç¼ºå¸­é€šçŸ¥ï¼');
            } else {
                toast(r?.message || 'ç™¼é€å¤±æ•—', 'danger');
            }
        }
        async function testReminderNotify() {
            const classCode = document.getElementById('test-class').value;
            if (!classCode) { toast('è«‹é¸æ“‡æ¸¬è©¦ç­ç´š', 'danger'); return; }
            if (!confirm('ç¢ºå®šç™¼é€ã€Œä¸Šèª²æé†’ã€çµ¦ ' + classCode + ' ç­ç´šæ‰€æœ‰å­¸ç”Ÿï¼Ÿ')) return;
            toast('ç™¼é€ä¸­...', 'warning');
            const r = await api('/api/test/reminder', { method: 'POST', body: JSON.stringify({ classCode }) });
            if (r?.success) {
                toast('å·²ç™¼é€ ' + r.count + ' å‰‡ä¸Šèª²æé†’ï¼');
            } else {
                toast(r?.message || 'ç™¼é€å¤±æ•—', 'danger');
            }
        }
        function updateTestClassDropdown() {
            const select = document.getElementById('test-class');
            if (select) {
                select.innerHTML = '<option value="">-- é¸æ“‡ç­ç´š --</option>' + classes.map(c => '<option value="' + c.code + '">' + c.code + ' - ' + c.name + '</option>').join('');
            }
            // åŒæ™‚æ›´æ–°èª²ç¨‹é™¤éŒ¯ä¸‹æ‹‰é¸å–®
            const debugSelect = document.getElementById('debug-course');
            if (debugSelect) {
                debugSelect.innerHTML = '<option value="">-- é¸æ“‡èª²ç¨‹ --</option>' + courses.map(c => '<option value="' + c.id + '">' + (c.name || c.subject) + ' (' + c.classCode + ') - ç›®å‰è¨­å®š: ' + c.radius + 'm</option>').join('');
            }
        }
        
        async function debugCourse() {
            const courseId = document.getElementById('debug-course').value;
            if (!courseId) { toast('è«‹é¸æ“‡èª²ç¨‹', 'danger'); return; }
            
            toast('æª¢æŸ¥ä¸­...', 'warning');
            const resultDiv = document.getElementById('debug-result');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = 'è¼‰å…¥ä¸­...';
            
            try {
                const r = await api('/api/debug/course/' + courseId);
                if (r) {
                    resultDiv.innerHTML = '<b>ğŸ“‹ Google Sheets åŸå§‹è³‡æ–™ï¼š</b><br>' +
                        'èª²ç¨‹ID: ' + r.courseId + '<br>' +
                        'ç§‘ç›®: ' + r.ç§‘ç›® + '<br>' +
                        'ç­ç´š: ' + r.ç­ç´š + '<br>' +
                        'æ•™å®¤ç·¯åº¦: ' + r.æ•™å®¤ç·¯åº¦ + '<br>' +
                        'æ•™å®¤ç¶“åº¦: ' + r.æ•™å®¤ç¶“åº¦ + '<br>' +
                        '<b style="color:var(--primary)">ç°½åˆ°ç¯„åœåŸå§‹å€¼: ' + r.ç°½åˆ°ç¯„åœ_åŸå§‹å€¼ + '</b><br>' +
                        'ç°½åˆ°ç¯„åœé¡å‹: ' + r.ç°½åˆ°ç¯„åœ_é¡å‹ + '<br>' +
                        'ç°½åˆ°ç¯„åœè§£æ: ' + r.ç°½åˆ°ç¯„åœ_è§£æ + '<br>' +
                        '<br><b>å‰ç«¯ç›®å‰å¿«å–çš„å€¼: ' + (courses.find(c => c.id === courseId)?.radius || 'æ‰¾ä¸åˆ°') + '</b>';
                    toast('æª¢æŸ¥å®Œæˆ');
                } else {
                    resultDiv.innerHTML = 'ç„¡æ³•å–å¾—è³‡æ–™';
                    toast('æª¢æŸ¥å¤±æ•—', 'danger');
                }
            } catch (e) {
                resultDiv.innerHTML = 'éŒ¯èª¤: ' + e.message;
                toast('æª¢æŸ¥å¤±æ•—', 'danger');
            }
        }

        // === é é¢è¼‰å…¥ ===
        function loadPage(page) {
            if (page === 'dashboard') loadDashboard();
            if (page === 'semester') { initSemesterUI(); }
            if (page === 'schedule') { initScheduleWeekSelector(); renderScheduleGrid(); renderCourses(); }
            if (page === 'sessions') loadSessions();
            if (page === 'classes') loadClasses();
            if (page === 'students') loadStudents();
            if (page === 'leaves') loadLeaves();
            if (page === 'records') { document.getElementById('record-date').value = new Date().toISOString().split('T')[0]; loadRecords(); }
            if (page === 'stats') loadStats();
            if (page === 'alerts') loadAlerts();
            if (page === 'linebot') document.getElementById('bot-id').value = BOT;
            if (page === 'settings') { updateTestClassDropdown(); document.getElementById('bot-id').value = BOT; }
        }
        async function loadAll() {
            await loadClasses();
            await loadCourses();
            await loadLeaves();
            await loadDashboard();
        }
        function init() {
            document.getElementById('api-url').value = API;
            document.getElementById('bot-id').value = BOT;
            
            // å¾ localStorage è®€å–å­¸æœŸè¨­å®š
            loadSemesterFromStorage();
            console.log('è¼‰å…¥çš„ sem:', sem);
            
            // åˆå§‹åŒ–å­¸æœŸè¨­å®š UI
            initSemesterUI();
            
            // è¨ˆç®—ç›®å‰é€±æ¬¡
            calcWeeks();
            
            // è‡ªå‹•åµæ¸¬ API
            if (!API && location.origin.includes('onrender.com')) {
                API = location.origin;
                localStorage.setItem('apiUrl', API);
                document.getElementById('api-url').value = API;
            }
            if (API) {
                loadAll();
                loadReminderSettings();
            }
        }
        init();
    </script>
</body>
</html>
