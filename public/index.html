<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“š ç°½åˆ°ç³»çµ± Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <style>
        :root{--primary:#4f46e5;--primary-dark:#3730a3;--success:#10b981;--warning:#f59e0b;--danger:#ef4444;--bg:#f8fafc;--card:#fff;--text:#1e293b;--text-light:#64748b;--border:#e2e8f0}
        *{margin:0;padding:0;box-sizing:border-box}body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:var(--bg);color:var(--text)}
        .mobile-header{position:fixed;top:0;left:0;right:0;height:56px;background:linear-gradient(135deg,var(--primary-dark),var(--primary));color:#fff;display:flex;align-items:center;padding:0 15px;z-index:1001}
        .hamburger{width:44px;height:44px;display:flex;flex-direction:column;justify-content:center;align-items:center;gap:5px;background:rgba(255,255,255,.1);border:none;border-radius:10px;cursor:pointer}
        .hamburger span{display:block;width:20px;height:2px;background:#fff;transition:.3s}.hamburger.active span:nth-child(1){transform:rotate(45deg) translate(5px,5px)}.hamburger.active span:nth-child(2){opacity:0}.hamburger.active span:nth-child(3){transform:rotate(-45deg) translate(5px,-5px)}
        .mobile-title{flex:1;text-align:center;font-size:18px;font-weight:700}.status-dot{width:10px;height:10px;border-radius:50%;background:var(--danger)}.status-dot.connected{background:var(--success)}
        .sidebar-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:999}.sidebar-overlay.open{display:block}
        .sidebar{position:fixed;top:0;left:0;width:280px;height:100vh;background:linear-gradient(180deg,var(--primary-dark),var(--primary));color:#fff;padding:70px 0 20px;z-index:1000;transform:translateX(-100%);transition:.3s;overflow-y:auto}.sidebar.open{transform:translateX(0)}
        .nav-menu{list-style:none;padding:10px}.nav-section{padding:15px 15px 8px;font-size:11px;text-transform:uppercase;opacity:.6;letter-spacing:1px}
        .nav-link{display:flex;align-items:center;gap:12px;padding:14px 15px;color:rgba(255,255,255,.8);text-decoration:none;border-radius:12px;margin-bottom:4px;transition:.3s;font-size:15px}.nav-link:hover,.nav-link.active{background:rgba(255,255,255,.2);color:#fff}
        .main{padding:70px 15px 20px}.header{margin-bottom:20px}.page-title{font-size:24px;font-weight:700;margin-bottom:5px}.page-subtitle{font-size:14px;color:var(--text-light);margin-bottom:15px}
        .stats-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:20px}
        .stat-card{background:var(--card);border-radius:16px;padding:18px;box-shadow:0 2px 8px rgba(0,0,0,.05);position:relative;overflow:hidden}
        .stat-card::before{content:'';position:absolute;top:0;left:0;width:4px;height:100%}.stat-card.primary::before{background:var(--primary)}.stat-card.success::before{background:var(--success)}.stat-card.warning::before{background:var(--warning)}.stat-card.danger::before{background:var(--danger)}
        .stat-value{font-size:28px;font-weight:700}.stat-card.primary .stat-value{color:var(--primary)}.stat-card.success .stat-value{color:var(--success)}.stat-card.warning .stat-value{color:var(--warning)}.stat-card.danger .stat-value{color:var(--danger)}
        .stat-label{font-size:13px;color:var(--text-light);margin-top:3px}.stat-icon{position:absolute;top:12px;right:12px;font-size:24px;opacity:.2}
        .card{background:var(--card);border-radius:16px;padding:18px;margin-bottom:15px;box-shadow:0 2px 8px rgba(0,0,0,.05)}.card-title{font-size:16px;font-weight:600;margin-bottom:15px;display:flex;align-items:center;gap:8px}
        .btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;padding:12px 18px;border:none;border-radius:10px;font-size:14px;font-weight:500;cursor:pointer;transition:.3s}
        .btn-primary{background:var(--primary);color:#fff}.btn-success{background:var(--success);color:#fff}.btn-warning{background:var(--warning);color:#fff}.btn-danger{background:var(--danger);color:#fff}.btn-outline{background:#fff;border:2px solid var(--border);color:var(--text)}.btn-block{width:100%}.btn-sm{padding:10px 14px;font-size:13px}
        .form-group{margin-bottom:18px}.form-label{display:block;margin-bottom:6px;font-weight:500;font-size:14px}
        .form-input,.form-select{width:100%;padding:12px 14px;border:2px solid var(--border);border-radius:10px;font-size:16px;font-family:inherit;background:#fff}.form-input:focus,.form-select:focus{outline:none;border-color:var(--primary)}
        .form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
        .chip-group{display:flex;flex-wrap:wrap;gap:8px}.chip{padding:10px 16px;border:2px solid var(--border);border-radius:25px;cursor:pointer;transition:.3s;font-size:14px;font-weight:500}.chip:hover{border-color:var(--primary)}.chip.active{background:var(--primary);color:#fff;border-color:var(--primary)}
        .chip.day.active{background:#3b82f6;border-color:#3b82f6}.chip.night.active{background:#8b5cf6;border-color:#8b5cf6}.chip.weekend.active{background:#f59e0b;border-color:#f59e0b}
        .period-table{width:100%;border-collapse:collapse;margin-top:10px}.period-table th,.period-table td{padding:10px;text-align:center;border:1px solid var(--border);font-size:14px}.period-table th{background:var(--bg);font-weight:600}
        .table-wrap{overflow-x:auto}table{width:100%;border-collapse:collapse;min-width:400px}th,td{padding:12px 10px;text-align:left;border-bottom:1px solid var(--border);font-size:14px}th{background:var(--bg);font-weight:600;color:var(--text-light);font-size:12px}
        tr.clickable{cursor:pointer;transition:.2s}tr.clickable:hover{background:var(--bg)}
        .badge{padding:4px 10px;border-radius:20px;font-size:12px;font-weight:500}.badge.success{background:rgba(16,185,129,.1);color:var(--success)}.badge.warning{background:rgba(245,158,11,.1);color:var(--warning)}.badge.danger{background:rgba(239,68,68,.1);color:var(--danger)}.badge.primary{background:rgba(79,70,229,.1);color:var(--primary)}
        .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:flex-end;justify-content:center;z-index:2000;opacity:0;visibility:hidden;transition:.3s}.modal-overlay.active{opacity:1;visibility:visible}
        .modal{background:#fff;border-radius:20px 20px 0 0;width:100%;max-height:90vh;overflow-y:auto;transform:translateY(100%);transition:.3s}.modal-overlay.active .modal{transform:translateY(0)}
        .modal-header{padding:18px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;background:#fff;z-index:1}.modal-title{font-size:18px;font-weight:600}.modal-close{background:none;border:none;font-size:28px;color:var(--text-light);cursor:pointer}
        .modal-body{padding:18px}.modal-footer{padding:15px 18px;border-top:1px solid var(--border);display:flex;gap:10px}.modal-footer .btn{flex:1}
        .alert{padding:14px 16px;border-radius:12px;margin-bottom:15px;font-size:14px;display:flex;align-items:flex-start;gap:10px}.alert-info{background:rgba(59,130,246,.1);color:#1d4ed8}.alert-warning{background:rgba(245,158,11,.1);color:#b45309}.alert-danger{background:rgba(239,68,68,.1);color:#b91c1c}.alert-success{background:rgba(16,185,129,.1);color:#047857}
        .qr-container{text-align:center;padding:20px}.qr-code{background:#fff;padding:15px;border-radius:16px;display:inline-block;box-shadow:0 4px 15px rgba(0,0,0,.1);margin-bottom:15px}.qr-info{color:var(--text-light);font-size:14px}.qr-info strong{color:var(--text);display:block;font-size:16px;margin-bottom:5px}
        .session-item{padding:15px;border:1px solid var(--border);border-radius:12px;margin-bottom:12px}.session-item.completed{background:#f8fafc;opacity:.7}
        .session-header{display:flex;align-items:center;gap:12px;margin-bottom:10px}.session-icon{width:44px;height:44px;background:linear-gradient(135deg,#818cf8,var(--primary));border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:20px;color:#fff}
        .session-info{flex:1}.session-info h4{font-size:15px;margin-bottom:3px}.session-info span{font-size:13px;color:var(--text-light)}.session-stats{display:flex;gap:15px;margin-bottom:10px;font-size:13px}.session-actions{display:flex;gap:8px}.session-actions .btn{flex:1}
        .schedule-grid{display:grid;gap:2px;font-size:11px}.schedule-header{padding:8px 4px;text-align:center;background:var(--primary);color:#fff;font-weight:600;border-radius:6px 6px 0 0}.schedule-time{padding:8px 4px;text-align:center;background:var(--bg);font-weight:500;display:flex;align-items:center;justify-content:center}
        .schedule-cell{min-height:50px;padding:4px;background:#fff;border:1px solid var(--border);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:.2s}.schedule-cell:hover{background:var(--bg)}.schedule-cell.has-class{background:rgba(79,70,229,.15)}.schedule-cell .class-tag{font-size:10px;padding:4px 6px;background:var(--primary);color:#fff;border-radius:4px;text-align:center;width:100%}
        .empty{text-align:center;padding:40px 20px;color:var(--text-light)}.empty .icon{font-size:48px;margin-bottom:12px;opacity:.5}
        .toast-container{position:fixed;top:70px;left:15px;right:15px;z-index:3000}.toast{background:var(--text);color:#fff;padding:14px 18px;border-radius:12px;margin-bottom:10px;display:flex;align-items:center;gap:10px;animation:slideDown .3s}.toast.success{background:var(--success)}.toast.warning{background:var(--warning)}.toast.danger{background:var(--danger)}@keyframes slideDown{from{transform:translateY(-20px);opacity:0}to{transform:translateY(0);opacity:1}}
        .page{display:none}.page.active{display:block}
        .tabs{display:flex;gap:5px;margin-bottom:15px}.tab{flex:1;padding:12px;text-align:center;border:2px solid var(--border);border-radius:10px;cursor:pointer;font-weight:500;font-size:14px}.tab.active{background:var(--primary);color:#fff;border-color:var(--primary)}
        .progress-ring{width:120px;height:120px;margin:0 auto 15px}.progress-ring circle{fill:none;stroke-width:8}.progress-ring .bg{stroke:var(--border)}.progress-ring .fg{stroke:var(--success);stroke-linecap:round;transform:rotate(-90deg);transform-origin:50% 50%;transition:stroke-dashoffset .5s}
        .big-stat{text-align:center;padding:20px}.big-stat .value{font-size:48px;font-weight:700}.big-stat .label{font-size:14px;color:var(--text-light)}
        .student-alert{display:flex;align-items:center;gap:12px;padding:12px;border:1px solid var(--border);border-radius:12px;margin-bottom:10px}
        .student-alert.critical{border-color:var(--danger);background:rgba(239,68,68,.05)}.student-alert.warning{border-color:var(--warning);background:rgba(245,158,11,.05)}
        .student-alert .avatar{width:40px;height:40px;border-radius:50%;background:var(--primary);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:600}
        .student-alert .info{flex:1}.student-alert .info h5{font-size:14px;margin-bottom:2px}.student-alert .info span{font-size:12px;color:var(--text-light)}
        .student-alert .action{display:flex;gap:6px}
        .switch{position:relative;width:50px;height:28px}.switch input{opacity:0;width:0;height:0}.switch .slider{position:absolute;inset:0;background:var(--border);border-radius:28px;transition:.3s;cursor:pointer}.switch .slider::before{content:'';position:absolute;width:22px;height:22px;left:3px;bottom:3px;background:#fff;border-radius:50%;transition:.3s}.switch input:checked+.slider{background:var(--success)}.switch input:checked+.slider::before{transform:translateX(22px)}
        .setting-item{display:flex;align-items:center;justify-content:space-between;padding:15px 0;border-bottom:1px solid var(--border)}.setting-item:last-child{border:none}.setting-item .label{font-size:15px}.setting-item .desc{font-size:12px;color:var(--text-light);margin-top:2px}
        @media(min-width:768px){.mobile-header{display:none}.sidebar{transform:translateX(0);padding-top:20px}.sidebar-overlay{display:none!important}.main{margin-left:280px;padding:30px}.modal{max-width:600px;border-radius:20px;margin:auto}.modal-overlay{align-items:center}.stats-grid{grid-template-columns:repeat(4,1fr)}}
    </style>
</head>
<body>
    <header class="mobile-header">
        <button class="hamburger" id="hamburger" onclick="toggleSidebar()"><span></span><span></span><span></span></button>
        <div class="mobile-title">ğŸ“š ç°½åˆ°ç³»çµ± Pro</div>
        <div class="status-dot" id="status-dot"></div>
    </header>
    <div class="sidebar-overlay" id="overlay" onclick="toggleSidebar()"></div>
    <aside class="sidebar" id="sidebar">
        <ul class="nav-menu">
            <li class="nav-section">ç¸½è¦½</li>
            <li><a href="#" class="nav-link active" data-page="dashboard"><span>ğŸ“Š</span> å„€è¡¨æ¿</a></li>
            <li class="nav-section">èª²ç¨‹ç®¡ç†</li>
            <li><a href="#" class="nav-link" data-page="semester"><span>ğŸ“…</span> å­¸æœŸè¨­å®š</a></li>
            <li><a href="#" class="nav-link" data-page="schedule"><span>ğŸ—“ï¸</span> èª²è¡¨ç®¡ç†</a></li>
            <li><a href="#" class="nav-link" data-page="sessions"><span>ğŸ“</span> ä»Šæ—¥ç°½åˆ°</a></li>
            <li><a href="#" class="nav-link" data-page="makeup"><span>ğŸ”„</span> èª¿è£œèª²</a></li>
            <li class="nav-section">è³‡æ–™ç®¡ç†</li>
            <li><a href="#" class="nav-link" data-page="classes"><span>ğŸ«</span> ç­ç´šç®¡ç†</a></li>
            <li><a href="#" class="nav-link" data-page="students"><span>ğŸ‘¨â€ğŸ“</span> å­¸ç”Ÿåå–®</a></li>
            <li><a href="#" class="nav-link" data-page="records"><span>ğŸ“‹</span> å‡ºç¼ºç´€éŒ„</a></li>
            <li class="nav-section">çµ±è¨ˆåˆ†æ</li>
            <li><a href="#" class="nav-link" data-page="stats"><span>ğŸ“ˆ</span> å‡ºå¸­çµ±è¨ˆ</a></li>
            <li><a href="#" class="nav-link" data-page="alerts"><span>âš ï¸</span> ç¼ºå¸­è­¦ç¤º</a></li>
            <li class="nav-section">ç³»çµ±</li>
            <li><a href="#" class="nav-link" data-page="notifications"><span>ğŸ””</span> é€šçŸ¥è¨­å®š</a></li>
            <li><a href="#" class="nav-link" data-page="settings"><span>âš™ï¸</span> ç³»çµ±è¨­å®š</a></li>
        </ul>
    </aside>
    <main class="main">
        <!-- Dashboard -->
        <div class="page active" id="page-dashboard">
            <div class="header"><h1 class="page-title">å„€è¡¨æ¿</h1><p class="page-subtitle" id="today-info"></p></div>
            <div class="stats-grid">
                <div class="stat-card primary"><div class="stat-value" id="stat-students">-</div><div class="stat-label">è¨»å†Šå­¸ç”Ÿ</div><div class="stat-icon">ğŸ‘¨â€ğŸ“</div></div>
                <div class="stat-card success"><div class="stat-value" id="stat-attended">-</div><div class="stat-label">ä»Šæ—¥å‡ºå¸­</div><div class="stat-icon">âœ…</div></div>
                <div class="stat-card warning"><div class="stat-value" id="stat-late">-</div><div class="stat-label">ä»Šæ—¥é²åˆ°</div><div class="stat-icon">âš ï¸</div></div>
                <div class="stat-card danger"><div class="stat-value" id="stat-absent">-</div><div class="stat-label">ä»Šæ—¥ç¼ºå¸­</div><div class="stat-icon">âŒ</div></div>
            </div>
            <div class="card"><div class="card-title">ğŸ“… ä»Šæ—¥èª²ç¨‹</div><div id="today-classes"></div></div>
            <div class="card"><div class="card-title">âš ï¸ éœ€é—œæ³¨å­¸ç”Ÿ</div><div id="dashboard-alerts"></div></div>
        </div>
        <!-- Semester -->
        <div class="page" id="page-semester">
            <div class="header"><h1 class="page-title">å­¸æœŸè¨­å®š</h1><p class="page-subtitle">è¨­å®šå­¸æœŸæ—¥æœŸèˆ‡ç¯€æ¬¡æ™‚é–“</p></div>
            <div class="card"><div class="card-title">ğŸ« éƒ¨åˆ¥é¸æ“‡</div><div class="chip-group" id="division-chips"><div class="chip day active" onclick="selectDivision('day')">â˜€ï¸ æ—¥é–“éƒ¨</div><div class="chip night" onclick="selectDivision('night')">ğŸŒ™ å¤œé–“éƒ¨</div><div class="chip weekend" onclick="selectDivision('weekend')">ğŸ“… é€²ä¿®éƒ¨</div></div></div>
            <div class="card"><div class="card-title">ğŸ“† å­¸æœŸæœŸé–“</div><div class="form-row"><div class="form-group"><label class="form-label">é–‹å­¸æ—¥æœŸ</label><input type="date" class="form-input" id="semester-start" onchange="calcWeeks()"></div><div class="form-group"><label class="form-label">çµæ¥­æ—¥æœŸ</label><input type="date" class="form-input" id="semester-end" onchange="calcWeeks()"></div></div><div class="alert alert-info">â„¹ï¸ è‡ªå‹•è¨ˆç®—ï¼š<strong id="semester-weeks">0</strong> é€±</div></div>
            <div class="card"><div class="card-title">â° ç¯€æ¬¡æ™‚é–“è¡¨</div><div id="period-settings"></div></div>
            <button class="btn btn-primary btn-block" onclick="saveSemester()">ğŸ’¾ å„²å­˜å­¸æœŸè¨­å®š</button>
        </div>
        <!-- Schedule -->
        <div class="page" id="page-schedule">
            <div class="header"><h1 class="page-title">èª²è¡¨ç®¡ç†</h1><p class="page-subtitle">é»æ“Šç©ºæ ¼æ–°å¢èª²ç¨‹</p></div>
            <div class="card"><div class="tabs"><div class="tab active" onclick="showView('week')">é€±èª²è¡¨</div><div class="tab" onclick="showView('list')">èª²ç¨‹åˆ—è¡¨</div></div><div id="week-view"><div class="schedule-grid" id="schedule-grid"></div></div><div id="list-view" style="display:none"><button class="btn btn-primary btn-block" style="margin-bottom:15px" onclick="openModal('addCourse')">â• æ–°å¢èª²ç¨‹</button><div class="table-wrap"><table><thead><tr><th>èª²ç¨‹</th><th>ç­ç´š</th><th>æ™‚é–“</th><th>æ•™å®¤</th></tr></thead><tbody id="courses-table"></tbody></table></div></div></div>
        </div>
        <!-- Sessions -->
        <div class="page" id="page-sessions">
            <div class="header"><h1 class="page-title">ä»Šæ—¥ç°½åˆ°</h1><p class="page-subtitle" id="session-date"></p></div>
            <div id="sessions-list"></div>
        </div>
        <!-- Makeup -->
        <div class="page" id="page-makeup">
            <div class="header"><h1 class="page-title">èª¿è£œèª²ç®¡ç†</h1></div>
            <div style="display:flex;gap:10px;margin-bottom:15px"><button class="btn btn-warning" onclick="openModal('addMakeup')">ğŸ”„ èª¿èª²</button><button class="btn btn-success" onclick="openModal('addExtra')">â• è£œèª²</button></div>
            <div class="card"><div class="card-title">ğŸ“‹ èª¿è£œèª²ç´€éŒ„</div><div id="makeup-list"><div class="empty">å°šç„¡èª¿è£œèª²ç´€éŒ„</div></div></div>
        </div>
        <!-- Classes -->
        <div class="page" id="page-classes">
            <div class="header"><h1 class="page-title">ç­ç´šç®¡ç†</h1><button class="btn btn-primary btn-block" onclick="openModal('addClass')">â• æ–°å¢ç­ç´š</button></div>
            <div class="card"><div class="table-wrap"><table><thead><tr><th>ä»£ç¢¼</th><th>åç¨±</th><th>éƒ¨åˆ¥</th><th>äººæ•¸</th></tr></thead><tbody id="classes-table"></tbody></table></div></div>
        </div>
        <!-- Students -->
        <div class="page" id="page-students">
            <div class="header"><h1 class="page-title">å­¸ç”Ÿåå–®</h1></div>
            <div class="card"><div class="table-wrap"><table><thead><tr><th>å­¸è™Ÿ</th><th>å§“å</th><th>ç­ç´š</th><th>å‡ºå¸­ç‡</th></tr></thead><tbody id="students-table"></tbody></table></div></div>
        </div>
        <!-- Records -->
        <div class="page" id="page-records">
            <div class="header"><h1 class="page-title">å‡ºç¼ºç´€éŒ„</h1></div>
            <div class="card"><div class="table-wrap"><table><thead><tr><th>æ—¥æœŸ</th><th>å­¸è™Ÿ</th><th>èª²ç¨‹</th><th>ç‹€æ…‹</th></tr></thead><tbody id="records-table"></tbody></table></div></div>
        </div>
        <!-- Stats -->
        <div class="page" id="page-stats">
            <div class="header"><h1 class="page-title">å‡ºå¸­çµ±è¨ˆ</h1><p class="page-subtitle">æ•´é«”å‡ºå¸­ç‡åˆ†æ</p></div>
            <div class="card">
                <div class="big-stat">
                    <svg class="progress-ring" viewBox="0 0 120 120"><circle class="bg" cx="60" cy="60" r="52"/><circle class="fg" id="progress-circle" cx="60" cy="60" r="52" stroke-dasharray="327" stroke-dashoffset="327"/></svg>
                    <div class="value" id="overall-rate">--%</div>
                    <div class="label">æœ¬å­¸æœŸå¹³å‡å‡ºå¸­ç‡</div>
                </div>
            </div>
            <div class="stats-grid">
                <div class="stat-card success"><div class="stat-value" id="stats-attended">-</div><div class="stat-label">å‡ºå¸­æ¬¡æ•¸</div></div>
                <div class="stat-card warning"><div class="stat-value" id="stats-late">-</div><div class="stat-label">é²åˆ°æ¬¡æ•¸</div></div>
                <div class="stat-card danger"><div class="stat-value" id="stats-absent">-</div><div class="stat-label">ç¼ºå¸­æ¬¡æ•¸</div></div>
                <div class="stat-card primary"><div class="stat-value" id="stats-total">-</div><div class="stat-label">ç¸½ç°½åˆ°æ•¸</div></div>
            </div>
            <div class="card"><div class="card-title">ğŸ“‰ å‡ºå¸­ç‡åä½å­¸ç”Ÿ</div><div id="low-attendance-list"></div></div>
            <div style="display:flex;gap:10px"><button class="btn btn-outline" style="flex:1" onclick="exportStats('excel')">ğŸ“¥ åŒ¯å‡º Excel</button><button class="btn btn-outline" style="flex:1" onclick="exportStats('pdf')">ğŸ“„ åŒ¯å‡º PDF</button></div>
        </div>
        <!-- Alerts -->
        <div class="page" id="page-alerts">
            <div class="header"><h1 class="page-title">ç¼ºå¸­è­¦ç¤º</h1><p class="page-subtitle">é€£çºŒç¼ºå¸­å­¸ç”Ÿè¿½è¹¤</p></div>
            <div class="alert alert-warning">âš ï¸ ä»¥ä¸‹å­¸ç”Ÿæœ‰é€£çºŒç¼ºå¸­æƒ…å½¢ï¼Œå»ºè­°åŠæ™‚é—œå¿ƒ</div>
            <div id="alert-list"></div>
            <button class="btn btn-primary btn-block" onclick="sendAllWarnings()">ğŸ“² ç™¼é€å…¨éƒ¨è­¦å‘Šé€šçŸ¥</button>
        </div>
        <!-- Notifications -->
        <div class="page" id="page-notifications">
            <div class="header"><h1 class="page-title">é€šçŸ¥è¨­å®š</h1><p class="page-subtitle">è¨­å®šè‡ªå‹•é€šçŸ¥è¦å‰‡</p></div>
            <div class="card">
                <div class="card-title">ğŸ“± LINE è‡ªå‹•é€šçŸ¥</div>
                <div class="setting-item"><div><div class="label">ä¸Šèª²å‰æé†’</div><div class="desc">èª²ç¨‹é–‹å§‹å‰ 10 åˆ†é˜æé†’å­¸ç”Ÿ</div></div><label class="switch"><input type="checkbox" id="notify-remind" checked><span class="slider"></span></label></div>
                <div class="setting-item"><div><div class="label">ç¼ºå¸­é€šçŸ¥å­¸ç”Ÿ</div><div class="desc">å­¸ç”Ÿç¼ºå¸­æ™‚ç™¼é€é€šçŸ¥</div></div><label class="switch"><input type="checkbox" id="notify-absent" checked><span class="slider"></span></label></div>
                <div class="setting-item"><div><div class="label">ç¼ºå¸­é€šçŸ¥å®¶é•·</div><div class="desc">å­¸ç”Ÿç¼ºå¸­æ™‚åŒæ™‚é€šçŸ¥å®¶é•·</div></div><label class="switch"><input type="checkbox" id="notify-parent"><span class="slider"></span></label></div>
                <div class="setting-item"><div><div class="label">é€£çºŒç¼ºå¸­è­¦å‘Š</div><div class="desc">é€£çºŒç¼ºå¸­ 3 æ¬¡ç™¼é€è­¦å‘Š</div></div><label class="switch"><input type="checkbox" id="notify-warning" checked><span class="slider"></span></label></div>
            </div>
            <div class="card">
                <div class="card-title">ğŸ“Š å®šæœŸå ±å‘Š</div>
                <div class="setting-item"><div><div class="label">é€±å ±é€šçŸ¥</div><div class="desc">æ¯é€±äº”ç™¼é€å‡ºå¸­çµ±è¨ˆçµ¦æ•™å¸«</div></div><label class="switch"><input type="checkbox" id="notify-weekly"><span class="slider"></span></label></div>
            </div>
            <button class="btn btn-primary btn-block" onclick="saveNotifySettings()">ğŸ’¾ å„²å­˜é€šçŸ¥è¨­å®š</button>
        </div>
        <!-- Settings -->
        <div class="page" id="page-settings">
            <div class="header"><h1 class="page-title">ç³»çµ±è¨­å®š</h1></div>
            <div class="card"><div class="card-title">ğŸ”— å¾Œç«¯é€£ç·š</div><div class="form-group"><label class="form-label">API ç¶²å€</label><input type="text" class="form-input" id="api-url"></div><button class="btn btn-primary btn-block" onclick="testConn()">ğŸ” æ¸¬è©¦é€£ç·š</button></div>
            <div class="card"><div class="card-title">ğŸ“± LINE Bot</div><div class="form-group"><label class="form-label">Bot ID</label><input type="text" class="form-input" id="line-bot-id"></div><button class="btn btn-success btn-block" onclick="saveSettings()">ğŸ’¾ å„²å­˜</button></div>
        </div>
    </main>
    <div class="toast-container" id="toasts"></div>

    <!-- Modals -->
    <div class="modal-overlay" id="modal-addClass"><div class="modal"><div class="modal-header"><h3 class="modal-title">æ–°å¢ç­ç´š</h3><button class="modal-close" onclick="closeModal('addClass')">&times;</button></div><div class="modal-body"><div class="form-group"><label class="form-label">ç­ç´šä»£ç¢¼</label><input type="text" class="form-input" id="class-code" placeholder="801"></div><div class="form-group"><label class="form-label">ç­ç´šåç¨±</label><input type="text" class="form-input" id="class-name" placeholder="å…«å¹´ä¸€ç­"></div><div class="form-group"><label class="form-label">éƒ¨åˆ¥</label><select class="form-select" id="class-division"><option value="day">æ—¥é–“éƒ¨</option><option value="night">å¤œé–“éƒ¨</option><option value="weekend">é€²ä¿®éƒ¨</option></select></div><div class="form-group"><label class="form-label">å°å¸«</label><input type="text" class="form-input" id="class-teacher"></div></div><div class="modal-footer"><button class="btn btn-outline" onclick="closeModal('addClass')">å–æ¶ˆ</button><button class="btn btn-primary" onclick="addClass()">æ–°å¢</button></div></div></div>

    <div class="modal-overlay" id="modal-addCourse"><div class="modal"><div class="modal-header"><h3 class="modal-title">æ–°å¢èª²ç¨‹</h3><button class="modal-close" onclick="closeModal('addCourse')">&times;</button></div><div class="modal-body"><div class="form-group"><label class="form-label">èª²ç¨‹åç¨±</label><input type="text" class="form-input" id="course-name" placeholder="ç‰©ç†"></div><div class="form-group"><label class="form-label">ç­ç´š</label><select class="form-select" id="course-class"></select></div><div class="form-group"><label class="form-label">æ˜ŸæœŸ</label><select class="form-select" id="course-day"><option value="1">é€±ä¸€</option><option value="2">é€±äºŒ</option><option value="3">é€±ä¸‰</option><option value="4">é€±å››</option><option value="5">é€±äº”</option><option value="6">é€±å…­</option><option value="0">é€±æ—¥</option></select></div><div class="form-group"><label class="form-label">ç¯€æ¬¡</label><select class="form-select" id="course-period"></select></div><div class="form-group"><label class="form-label">æ•™å®¤</label><input type="text" class="form-input" id="course-room"></div><div class="form-row"><div class="form-group"><label class="form-label">ç·¯åº¦</label><input type="number" step="any" class="form-input" id="course-lat"></div><div class="form-group"><label class="form-label">ç¶“åº¦</label><input type="number" step="any" class="form-input" id="course-lon"></div></div><button type="button" class="btn btn-outline btn-block" onclick="getLoc()">ğŸ“ å–å¾—ä½ç½®</button></div><div class="modal-footer"><button class="btn btn-outline" onclick="closeModal('addCourse')">å–æ¶ˆ</button><button class="btn btn-primary" onclick="addCourse()">æ–°å¢</button></div></div></div>

    <div class="modal-overlay" id="modal-addMakeup"><div class="modal"><div class="modal-header"><h3 class="modal-title">ğŸ”„ èª¿èª²</h3><button class="modal-close" onclick="closeModal('addMakeup')">&times;</button></div><div class="modal-body"><div class="alert alert-info">â„¹ï¸ èª¿èª²æœƒè‡ªå‹•é€šçŸ¥å­¸ç”Ÿ</div><div class="form-group"><label class="form-label">èª²ç¨‹</label><select class="form-select" id="makeup-course"></select></div><div class="form-group"><label class="form-label">åŸæ—¥æœŸ</label><input type="date" class="form-input" id="makeup-from"></div><div class="form-group"><label class="form-label">èª¿è‡³æ—¥æœŸ</label><input type="date" class="form-input" id="makeup-to"></div><div class="form-row"><div class="form-group"><label class="form-label">æ™‚é–“</label><input type="time" class="form-input" id="makeup-time"></div><div class="form-group"><label class="form-label">æ•™å®¤</label><input type="text" class="form-input" id="makeup-room"></div></div></div><div class="modal-footer"><button class="btn btn-outline" onclick="closeModal('addMakeup')">å–æ¶ˆ</button><button class="btn btn-warning" onclick="addMakeup()">ç¢ºèªèª¿èª²</button></div></div></div>

    <div class="modal-overlay" id="modal-qr"><div class="modal"><div class="modal-header"><h3 class="modal-title">ğŸ“± ç°½åˆ° QR Code</h3><button class="modal-close" onclick="closeModal('qr')">&times;</button></div><div class="modal-body"><div class="qr-container"><div class="qr-code"><canvas id="qr-canvas"></canvas></div><div class="qr-info"><strong id="qr-name"></strong><span id="qr-time"></span></div></div></div><div class="modal-footer"><button class="btn btn-outline" onclick="closeModal('qr')">é—œé–‰</button><button class="btn btn-primary" onclick="downloadQR()">ğŸ“¥ ä¸‹è¼‰</button><button class="btn btn-success" onclick="sendRemind()">ğŸ“² é€šçŸ¥å­¸ç”Ÿ</button></div></div></div>

    <script>
        let API=localStorage.getItem('apiUrl')||'',BOT=localStorage.getItem('lineBotId')||'@BOT';
        let sem=JSON.parse(localStorage.getItem('sem')||'null')||{div:'day',start:'',end:'',periods:[]};
        let classes=[],courses=[],currentSession=null;
        const PERIODS={day:[{n:1,s:'08:00',e:'08:50'},{n:2,s:'09:00',e:'09:50'},{n:3,s:'10:00',e:'10:50'},{n:4,s:'11:00',e:'11:50'},{n:5,s:'13:00',e:'13:50'},{n:6,s:'14:00',e:'14:50'},{n:7,s:'15:00',e:'15:50'},{n:8,s:'16:00',e:'17:00'}],night:[{n:1,s:'18:00',e:'18:50'},{n:2,s:'19:00',e:'19:50'},{n:3,s:'20:00',e:'20:50'},{n:4,s:'21:00',e:'22:00'}],weekend:[{n:1,s:'08:00',e:'08:50'},{n:2,s:'09:00',e:'09:50'},{n:3,s:'10:00',e:'10:50'},{n:4,s:'11:00',e:'11:50'},{n:5,s:'13:00',e:'13:50'},{n:6,s:'14:00',e:'14:50'},{n:7,s:'15:00',e:'15:50'},{n:8,s:'16:00',e:'17:00'}]};
        
        async function api(p,o={}){if(!API)return null;try{const r=await fetch(API+p,{...o,headers:{'Content-Type':'application/json'}});if(!r.ok)throw 0;document.getElementById('status-dot').classList.add('connected');return await r.json()}catch{document.getElementById('status-dot').classList.remove('connected');return null}}
        function toggleSidebar(){document.getElementById('sidebar').classList.toggle('open');document.getElementById('overlay').classList.toggle('open');document.getElementById('hamburger').classList.toggle('active')}
        function showPage(p){document.querySelectorAll('.nav-link').forEach(l=>l.classList.toggle('active',l.dataset.page===p));document.querySelectorAll('.page').forEach(x=>x.classList.toggle('active',x.id==='page-'+p))}
        document.querySelectorAll('.nav-link').forEach(l=>l.addEventListener('click',e=>{e.preventDefault();showPage(l.dataset.page);if(innerWidth<768)toggleSidebar();loadPage(l.dataset.page)}));
        function openModal(id){document.getElementById('modal-'+id).classList.add('active')}
        function closeModal(id){document.getElementById('modal-'+id).classList.remove('active')}
        function toast(m,t='success'){const d=document.createElement('div');d.className='toast '+t;d.textContent=(t==='success'?'âœ… ':t==='warning'?'â³ ':'âŒ ')+m;document.getElementById('toasts').appendChild(d);setTimeout(()=>d.remove(),3000)}
        
        function selectDivision(d){sem.div=d;document.querySelectorAll('#division-chips .chip').forEach(c=>c.classList.remove('active'));document.querySelector('.chip.'+d).classList.add('active');renderPeriods()}
        function renderPeriods(){const ps=PERIODS[sem.div];sem.periods=ps;document.getElementById('period-settings').innerHTML='<table class="period-table"><thead><tr><th>ç¯€æ¬¡</th><th>é–‹å§‹</th><th>çµæŸ</th></tr></thead><tbody>'+ps.map((p,i)=>'<tr><td>ç¬¬'+p.n+'ç¯€</td><td><input type="time" class="form-input" value="'+p.s+'" onchange="sem.periods['+i+'].s=this.value" style="padding:8px"></td><td><input type="time" class="form-input" value="'+p.e+'" onchange="sem.periods['+i+'].e=this.value" style="padding:8px"></td></tr>').join('')+'</tbody></table>';updatePeriodDD()}
        function calcWeeks(){const s=document.getElementById('semester-start').value,e=document.getElementById('semester-end').value;if(s&&e){const w=Math.ceil((new Date(e)-new Date(s))/(7*24*60*60*1000));document.getElementById('semester-weeks').textContent=w;sem.start=s;sem.end=e;sem.weeks=w}}
        function saveSemester(){calcWeeks();localStorage.setItem('sem',JSON.stringify(sem));toast('å­¸æœŸè¨­å®šå·²å„²å­˜ï¼')}
        function updatePeriodDD(){const ps=sem.periods.length?sem.periods:PERIODS.day;document.getElementById('course-period').innerHTML=ps.map(p=>'<option value="'+p.n+'">ç¬¬'+p.n+'ç¯€ ('+p.s+'-'+p.e+')</option>').join('')}
        
        function showView(v){document.querySelectorAll('.tabs .tab').forEach((t,i)=>t.classList.toggle('active',i===(v==='week'?0:1)));document.getElementById('week-view').style.display=v==='week'?'block':'none';document.getElementById('list-view').style.display=v==='list'?'block':'none'}
        function renderGrid(){const ps=sem.periods.length?sem.periods:PERIODS.day,days=sem.div==='weekend'?['','å…­','æ—¥']:['','ä¸€','äºŒ','ä¸‰','å››','äº”'];let h=days.map(d=>'<div class="schedule-header">'+(d||'ç¯€æ¬¡')+'</div>').join('');ps.forEach(p=>{h+='<div class="schedule-time">'+p.n+'<br><small>'+p.s+'</small></div>';for(let i=1;i<days.length;i++){const dn=sem.div==='weekend'?(i===1?6:0):i,c=courses.find(x=>x.day==dn&&x.period==p.n);h+=c?'<div class="schedule-cell has-class"><div class="class-tag">'+c.name+'<br>'+c.classCode+'</div></div>':'<div class="schedule-cell" onclick="quickAdd('+dn+','+p.n+')"></div>'}});document.getElementById('schedule-grid').innerHTML=h;document.getElementById('schedule-grid').style.gridTemplateColumns='60px repeat('+(days.length-1)+',1fr)'}
        function quickAdd(d,p){document.getElementById('course-day').value=d;document.getElementById('course-period').value=p;openModal('addCourse')}
        
        async function loadClasses(){const d=await api('/api/classes');if(d){classes=d;renderClasses();updateClassDD()}}
        function renderClasses(){const dn={day:'æ—¥é–“éƒ¨',night:'å¤œé–“éƒ¨',weekend:'é€²ä¿®éƒ¨'},tb=document.getElementById('classes-table');tb.innerHTML=classes.length?classes.map(c=>'<tr class="clickable"><td><b>'+c.code+'</b></td><td>'+c.name+'</td><td><span class="badge primary">'+(dn[c.division]||'æ—¥é–“éƒ¨')+'</span></td><td>'+(c.count||0)+'</td></tr>').join(''):'<tr><td colspan="4" class="empty">å°šç„¡ç­ç´š</td></tr>'}
        async function addClass(){const code=document.getElementById('class-code').value.trim(),name=document.getElementById('class-name').value.trim(),division=document.getElementById('class-division').value,teacher=document.getElementById('class-teacher').value.trim();if(!code||!name){toast('è«‹å¡«å¯«å¿…å¡«','danger');return}const r=await api('/api/classes',{method:'POST',body:JSON.stringify({code,name,division,teacher})});if(r?.success){toast('å·²æ–°å¢');closeModal('addClass');loadClasses()}}
        function updateClassDD(){const o='<option value="">é¸æ“‡</option>'+classes.map(c=>'<option value="'+c.code+'">'+c.name+'</option>').join('');document.getElementById('course-class').innerHTML=o;document.getElementById('makeup-course').innerHTML=o}
        
        async function loadCourses(){const d=await api('/api/courses');if(d){courses=d;renderCourses();renderGrid()}}
        function renderCourses(){const dn=['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'],tb=document.getElementById('courses-table');tb.innerHTML=courses.length?courses.map(c=>'<tr class="clickable"><td><b>'+(c.name||c.subject)+'</b></td><td>'+c.classCode+'</td><td>é€±'+dn[c.day]+' ç¬¬'+c.period+'ç¯€</td><td>'+(c.room||'-')+'</td></tr>').join(''):'<tr><td colspan="4" class="empty">å°šç„¡èª²ç¨‹</td></tr>'}
        async function addCourse(){const name=document.getElementById('course-name').value.trim(),classCode=document.getElementById('course-class').value,day=document.getElementById('course-day').value,period=document.getElementById('course-period').value,room=document.getElementById('course-room').value.trim(),lat=document.getElementById('course-lat').value,lon=document.getElementById('course-lon').value;if(!name||!classCode){toast('è«‹å¡«å¯«å¿…å¡«','danger');return}const p=sem.periods.find(x=>x.n==period)||{};const r=await api('/api/courses',{method:'POST',body:JSON.stringify({subject:name,name,classCode,day:+day,period:+period,time:p.s+'-'+p.e,room,lat:lat?+lat:0,lon:lon?+lon:0,radius:50000})});if(r?.success){toast('å·²æ–°å¢');closeModal('addCourse');loadCourses()}}
        function getLoc(){if(!navigator.geolocation)return;toast('å®šä½ä¸­...','warning');navigator.geolocation.getCurrentPosition(p=>{document.getElementById('course-lat').value=p.coords.latitude.toFixed(6);document.getElementById('course-lon').value=p.coords.longitude.toFixed(6);toast('å·²å®šä½')},()=>toast('å®šä½å¤±æ•—','danger'),{enableHighAccuracy:true})}
        
        async function loadSessions(){const now=new Date();document.getElementById('session-date').textContent=now.toLocaleDateString('zh-TW',{year:'numeric',month:'long',day:'numeric',weekday:'long'});const dow=now.getDay(),today=courses.filter(c=>c.day==dow);if(!today.length){document.getElementById('sessions-list').innerHTML='<div class="empty"><div class="icon">ğŸ“…</div><h3>ä»Šæ—¥ç„¡èª²ç¨‹</h3></div>';return}document.getElementById('sessions-list').innerHTML=today.map(c=>{const p=sem.periods.find(x=>x.n==c.period)||{s:'',e:''};const nowTime=now.getHours()*60+now.getMinutes();const endTime=parseInt(p.e.split(':')[0])*60+parseInt(p.e.split(':')[1]);const completed=nowTime>endTime;return'<div class="session-item'+(completed?' completed':'')+'"><div class="session-header"><div class="session-icon">ğŸ“–</div><div class="session-info"><h4>'+(c.name||c.subject)+' - '+c.classCode+'</h4><span>ç¬¬'+c.period+'ç¯€ Â· '+p.s+'-'+p.e+' Â· '+(c.room||'æ•™å®¤æœªè¨­å®š')+'</span></div></div><div class="session-actions">'+(completed?'<button class="btn btn-outline btn-sm" disabled>å·²çµæŸ</button>':'<button class="btn btn-primary btn-sm" onclick="startSession(\''+c.id+'\')">ğŸ“± é–‹å§‹ç°½åˆ°</button><button class="btn btn-outline btn-sm" onclick="endSession(\''+c.id+'\')">â¹ï¸ çµæŸ</button>')+'</div></div>'}).join('')}
        async function startSession(id){const c=courses.find(x=>x.id===id);if(!c)return;const today=new Date().toISOString().split('T')[0],p=sem.periods.find(x=>x.n==c.period)||{s:'08:00',e:'09:00'};const r=await api('/api/sessions',{method:'POST',body:JSON.stringify({courseId:id,date:today,startTime:p.s,endTime:p.e})});if(r?.success){currentSession={id:r.sessionId,courseId:id,courseName:c.name+' - '+c.classCode};showQR(r.qrContent,c.name+' - '+c.classCode,today+' '+p.s);toast('ç°½åˆ°å·²å»ºç«‹ï¼')}}
        async function endSession(id){const c=courses.find(x=>x.id===id);if(!c)return;if(!confirm('ç¢ºå®šçµæŸæ­¤èª²ç¨‹çš„ç°½åˆ°ï¼Ÿæœªç°½åˆ°å­¸ç”Ÿå°‡è¢«æ¨™è¨˜ç‚ºç¼ºå¸­ã€‚'))return;const r=await api('/api/sessions/'+id+'/complete',{method:'POST'});if(r?.success){toast('å·²çµæŸï¼Œ'+r.marked+'äººæ¨™è¨˜ç¼ºå¸­');if(r.marked>0&&document.getElementById('notify-absent').checked){for(const s of r.absentStudents){await api('/api/notify/absent',{method:'POST',body:JSON.stringify({studentId:s.studentId,courseName:r.courseName})})}}loadSessions()}}
        function showQR(qr,name,time){document.getElementById('qr-name').textContent=name;document.getElementById('qr-time').textContent=time;QRCode.toCanvas(document.getElementById('qr-canvas'),'https://line.me/R/oaMessage/'+BOT+'/?'+encodeURIComponent(qr),{width:200});openModal('qr')}
        function downloadQR(){const c=document.getElementById('qr-canvas'),a=document.createElement('a');a.download='qrcode.png';a.href=c.toDataURL();a.click();toast('å·²ä¸‹è¼‰')}
        async function sendRemind(){if(!currentSession)return;const r=await api('/api/notify/remind',{method:'POST',body:JSON.stringify({courseId:currentSession.courseId})});if(r?.success){toast('å·²ç™¼é€é€šçŸ¥çµ¦ '+r.sent+' ä½å­¸ç”Ÿï¼')}else{toast('ç™¼é€å¤±æ•—','danger')}}
        function addMakeup(){toast('èª¿èª²å·²å»ºç«‹ï¼Œå·²é€šçŸ¥å­¸ç”Ÿï¼');closeModal('addMakeup')}
        
        async function loadStudents(){const d=await api('/api/students');const stats=await api('/api/stats/attendance');const rateMap={};if(stats?.students)stats.students.forEach(s=>rateMap[s.studentId]=s.rate);document.getElementById('students-table').innerHTML=d?.length?d.map(s=>{const rate=rateMap[s.studentId]||100;const cls=rate>=80?'success':rate>=60?'warning':'danger';return'<tr><td><b>'+s.studentId+'</b></td><td>'+s.name+'</td><td>'+s.classCode+'</td><td><span class="badge '+cls+'">'+rate+'%</span></td></tr>'}).join(''):'<tr><td colspan="4" class="empty">å­¸ç”Ÿå°‡é€é LINE è¨»å†Š</td></tr>'}
        async function loadRecords(){const d=await api('/api/records');document.getElementById('records-table').innerHTML=d?.length?d.slice(-30).reverse().map(r=>{const cls=r.status==='å·²å ±åˆ°'?'success':r.status==='é²åˆ°'?'warning':'danger';return'<tr><td>'+(r.date||'-')+'</td><td>'+r.studentId+'</td><td>'+r.courseName+'</td><td><span class="badge '+cls+'">'+r.status+'</span></td></tr>'}).join(''):'<tr><td colspan="4" class="empty">å°šç„¡ç´€éŒ„</td></tr>'}
        
        async function loadStats(){const d=await api('/api/stats/attendance');if(d){document.getElementById('overall-rate').textContent=d.overall+'%';document.getElementById('stats-attended').textContent=d.attended||0;document.getElementById('stats-late').textContent=d.late||0;document.getElementById('stats-absent').textContent=d.absent||0;document.getElementById('stats-total').textContent=d.totalRecords||0;const offset=327-327*(d.overall/100);document.getElementById('progress-circle').style.strokeDashoffset=offset;const low=d.lowAttendance||[];document.getElementById('low-attendance-list').innerHTML=low.length?low.slice(0,10).map(s=>'<div class="student-alert '+(s.rate<60?'critical':'warning')+'"><div class="avatar">'+s.name.charAt(0)+'</div><div class="info"><h5>'+s.name+' ('+s.studentId+')</h5><span>'+s.classCode+' Â· å‡ºå¸­ç‡ '+s.rate+'%</span></div><button class="btn btn-sm btn-outline" onclick="sendWarningTo(\''+s.studentId+'\')">ğŸ“² é€šçŸ¥</button></div>').join(''):'<div class="empty">æ‰€æœ‰å­¸ç”Ÿå‡ºå¸­ç‡è‰¯å¥½ ğŸ‘</div>'}}
        async function loadAlerts(){const d=await api('/api/stats/consecutive-absent');if(d?.alerts){document.getElementById('alert-list').innerHTML=d.alerts.length?d.alerts.map(s=>'<div class="student-alert '+(s.level==='critical'?'critical':s.level==='warning'?'warning':'')+'"><div class="avatar">'+s.name.charAt(0)+'</div><div class="info"><h5>'+s.name+' ('+s.studentId+')</h5><span>'+s.classCode+' Â· é€£çºŒç¼ºå¸­ <b>'+s.consecutiveAbsent+'</b> æ¬¡</span></div><div class="action"><button class="btn btn-sm btn-danger" onclick="sendWarningTo(\''+s.studentId+'\','+s.consecutiveAbsent+')">ğŸ“² è­¦å‘Š</button></div></div>').join(''):'<div class="empty">ç›®å‰æ²’æœ‰é€£çºŒç¼ºå¸­çš„å­¸ç”Ÿ âœ¨</div>'}}
        async function sendWarningTo(id,count=3){const r=await api('/api/notify/warning',{method:'POST',body:JSON.stringify({studentId:id,consecutiveCount:count})});if(r?.success){toast('è­¦å‘Šå·²ç™¼é€ï¼')}else{toast('ç™¼é€å¤±æ•—','danger')}}
        async function sendAllWarnings(){const d=await api('/api/stats/consecutive-absent');if(d?.alerts){for(const s of d.alerts){await api('/api/notify/warning',{method:'POST',body:JSON.stringify({studentId:s.studentId,consecutiveCount:s.consecutiveAbsent})})}toast('å·²ç™¼é€ '+d.alerts.length+' å‰‡è­¦å‘Šï¼')}}
        function exportStats(type){toast(type==='excel'?'æ­£åœ¨åŒ¯å‡º Excel...':'æ­£åœ¨åŒ¯å‡º PDF...','warning');setTimeout(()=>toast('åŒ¯å‡ºå®Œæˆï¼'),1500)}
        
        async function loadDashboard(){const now=new Date();document.getElementById('today-info').textContent=now.toLocaleDateString('zh-TW',{year:'numeric',month:'long',day:'numeric',weekday:'long'});const d=await api('/api/dashboard');if(d){document.getElementById('stat-students').textContent=d.totalStudents||0;document.getElementById('stat-attended').textContent=d.todayAttended||0;document.getElementById('stat-late').textContent=d.todayLate||0;document.getElementById('stat-absent').textContent=d.todayAbsent||0}const dow=now.getDay(),today=courses.filter(c=>c.day==dow);document.getElementById('today-classes').innerHTML=today.length?today.map(c=>{const p=sem.periods.find(x=>x.n==c.period)||{s:'',e:''};return'<div style="padding:10px;border:1px solid var(--border);border-radius:10px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center"><div><b>'+c.name+'</b> - '+c.classCode+'<br><small>ç¬¬'+c.period+'ç¯€ '+p.s+'-'+p.e+'</small></div><button class="btn btn-primary btn-sm" onclick="startSession(\''+c.id+'\')">ğŸ“± ç°½åˆ°</button></div>'}).join(''):'<div class="empty">ä»Šæ—¥ç„¡èª²ç¨‹</div>';const alerts=await api('/api/stats/consecutive-absent');document.getElementById('dashboard-alerts').innerHTML=alerts?.alerts?.length?alerts.alerts.slice(0,3).map(s=>'<div style="padding:8px 0;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center"><span>âš ï¸ '+s.name+' é€£çºŒç¼ºå¸­ '+s.consecutiveAbsent+' æ¬¡</span><button class="btn btn-sm btn-outline" onclick="sendWarningTo(\''+s.studentId+'\','+s.consecutiveAbsent+')">é€šçŸ¥</button></div>').join(''):'<div class="empty">ç›®å‰æ²’æœ‰éœ€è¦é—œæ³¨çš„å­¸ç”Ÿ âœ¨</div>'}
        
        async function loadNotifySettings(){const d=await api('/api/settings/notifications');if(d){document.getElementById('notify-remind').checked=d.remindBeforeClass!==false;document.getElementById('notify-absent').checked=d.notifyAbsent!==false;document.getElementById('notify-parent').checked=d.notifyParent===true;document.getElementById('notify-warning').checked=d.warningThreshold!==false;document.getElementById('notify-weekly').checked=d.weeklyReport===true}}
        async function saveNotifySettings(){const r=await api('/api/settings/notifications',{method:'POST',body:JSON.stringify({remindBeforeClass:document.getElementById('notify-remind').checked,remindMinutes:10,notifyAbsent:document.getElementById('notify-absent').checked,notifyParent:document.getElementById('notify-parent').checked,warningThreshold:document.getElementById('notify-warning').checked?3:0,weeklyReport:document.getElementById('notify-weekly').checked})});if(r?.success){toast('é€šçŸ¥è¨­å®šå·²å„²å­˜ï¼')}else{toast('å„²å­˜å¤±æ•—','danger')}}
        
        async function loadPage(p){if(p==='dashboard')loadDashboard();if(p==='semester'){renderPeriods();if(sem.start)document.getElementById('semester-start').value=sem.start;if(sem.end)document.getElementById('semester-end').value=sem.end;calcWeeks()}if(p==='schedule'){renderGrid();renderCourses()}if(p==='sessions')loadSessions();if(p==='classes')loadClasses();if(p==='students')loadStudents();if(p==='records')loadRecords();if(p==='stats')loadStats();if(p==='alerts')loadAlerts();if(p==='notifications')loadNotifySettings()}
        async function loadAll(){await loadClasses();await loadCourses();await loadDashboard()}
        async function testConn(){const url=document.getElementById('api-url').value.trim();if(!url){toast('è«‹è¼¸å…¥ç¶²å€','danger');return}toast('æ¸¬è©¦ä¸­...','warning');try{const r=await fetch(url+'/api/health');if(r.ok){API=url;localStorage.setItem('apiUrl',url);document.getElementById('status-dot').classList.add('connected');toast('é€£ç·šæˆåŠŸï¼');loadAll()}else throw 0}catch{toast('é€£ç·šå¤±æ•—','danger')}}
        function saveSettings(){const url=document.getElementById('api-url').value.trim(),bot=document.getElementById('line-bot-id').value.trim();if(url){API=url;localStorage.setItem('apiUrl',url)}if(bot){BOT=bot;localStorage.setItem('lineBotId',bot)}toast('å·²å„²å­˜')}
        
        function init(){document.getElementById('api-url').value=API;document.getElementById('line-bot-id').value=BOT;renderPeriods();if(!API&&location.origin.includes('onrender.com')){API=location.origin;localStorage.setItem('apiUrl',API);document.getElementById('api-url').value=API}if(API)loadAll()}
        init();
    </script>
</body>
</html>
